---
title: "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V2"
author: "Lei Yue"
date: "2024-04-20"
output:
  prettydoc::html_pretty:
  theme: cayman
  highlight: github
---

In "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V1.Rmd"， I preprocess the journal code data. In this Rmd(V2), we enter the informal process data.

**Special Note:** To enhance the readability and accessibility of this document, we have provided a concise explanation for the naming convention of data

Journal\_: This prefix signifies data that has been coded and extracted from five mainstream Chinese journals.

BTS\_: This indicates data sourced from large-scale international collaborations.

H1\_: This indicates data use to test hypothesis 1.

H2\_: This indicates data use to test hypothesis 2.

H3\_: This indicates data use to test hypothesis 3.

Census\_: This prefix represents Census data published by the National Bureau of Statistics of China.

CFPS2018\_: This signifies data from the 2018 Chinese Family Panel Study.

The majority of data adhere to these naming conventions, with the prefixes typically followed by descriptive and comprehensible demographic variable names or other relevant terms to clarify the data content.

Furthermore, if "Fig" appears in the data name, it signifies that the content represents a data visualization result. Similarly, the presence of "bayes" indicates that the data or result pertains to the calculation of the Bayes factor.

Now, I start to analysis data. and the first thing is load library.

# Install and Load packages

```{r message=FALSE, warning=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")

# use package "pacman" as loading R packages tools

pacman::p_load("tidyverse","here","rio","purrr")
pacman::p_load("geojsonsf","sf","RColorBrewer","ggspatial","patchwork","ggrepel","maps")
pacman::p_load("truncnorm","BayesFactor", "gtools", "bruceR")
```

And then, I loaded the data. The data includes data from the first Stage 1 of the pre-registration report (primarily Census data and CFPS2018 data), Chinese journal coding data, and data from Big Team Science (BTS).

# Load data

## Load the data of stage 1, Chinese journals coding data, and BTS data

```{r}
load("df_Pre_Stage2_Journal_Code.Rdata")

load("df_chinese_subj_rr_stage1.Rdata")

load("BTS.Rdata")

BTS_coding <- readxl::read_xlsx("D://chin-subj//2_Data_Extraction//2_2_BTS//Chin_Subj_Proofreading_BTS_Target_Population.xlsx")
BTS_coding <- BTS_coding %>% 
  dplyr::filter(Coder == "final")

## Here, I remove some data sets to reduce data set clutter.
rm(df_regionCode)
```


## combine raw data and coding data of BTS
```{r}
for (i in seq_along(BTS)) {
  
  current_df <- BTS[[i]]
  
  merged_df <- merge(current_df, BTS_coding, by = "Article_Id", all.x = TRUE) 
  BTS[[i]] <- merged_df
  
}

## Process the target population of BTS_klein_et_al
# BTS_list_name <- names(BTS)

BTS[["BTS_Klein_et_al_2018_1"]]$Target_Population <- 2
BTS[["BTS_Klein_et_al_2018_2"]]$Target_Population <- 2
```


Here, I used self-defined function in Stage1 to calculate Bayesian multinomial test.

# Define a Func to calculate Bayesian multinomial test

## Algorithm in R

```         
lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
```

Here, `alphas` defined the prior Dirichlet distribution, e.g., noninformative prior is a vector of $1$ s, `counts` are the observed frequencies.

To use the algorithm in R, we defined a function here:

```{r}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
     LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```


At this point, I have finished loading the package and data. Next, I analyzed the data and visualized it according to the logic of the written protocal.
I began by analyzing the basic case of the two data sets (BTS and Chinese journals).

# Overview of participants
## The basic situation of Chinese journals coding data
```{r warning=FALSE}
Journal <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) ## valid 1628 rows


Journal_articles_num <- Journal %>% 
  dplyr::distinct(Article_IDs) ## A total 1000 articles


Journal_study_num <- Journal %>% 
  dplyr::distinct(Article_IDs,Study_Number) ## A total 1265 studies


## invalid papers
# Journal_invalid <- df_stage2_Journal_Code2 %>% 
#   dplyr::filter(!is.na(Remark1)) %>% 
#   dplyr::select(Article_IDs_N,Study_Number_N,Subjects_Group_N,
#                 Article_Title,Journal,Remark1,Remark2) %>% 
#   dplyr::filter(grepl("2018",Article_IDs_N))
# 
# 
# writexl::write_xlsx(Journal_invalid,"Journal_invalid.xlsx")
# # Journal_articles_title <- Journal %>% 
# #   dplyr::distinct(Article_Title)


# ## output `Journal` to help download bibliographic data from CNKI
# Journal_cnki <- Journal %>% 
#   dplyr::select(Article_IDs_N,Article_Title,First_Author,Journal) %>% 
#   dplyr::distinct(Article_IDs_N,.keep_all = TRUE) 
# 
# write.csv(Journal_cnki,"Journal_cnki.csv",row.names = FALSE)



# calculate exclude articles that only need code simple info
Journal_simple_info_articles <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(!is.na(Remark1)) %>% 
  dplyr::distinct(Article_IDs,Remark1)

table(Journal_simple_info_articles$Remark1)


## sample size sum
Journal_sample_size <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size),
                Sample_Size = ifelse(Article_IDs == "20185082",33,Sample_Size))


sum(Journal_sample_size$Sample_Size,na.rm = TRUE)  ## 555,098

## Here, I remove some data sets to reduce data set clutter.
# rm(Journal_articles_num,Journal_study_num,df_stage2_Journal_Code2)


## Save Journal to explore analysis
save(Journal, file ="Journal.Rdata")
```


Meanwhile, we process the special target population
```{r}

Journal_special_target_population <- Journal %>% 
  dplyr::select(Article_IDs,Article_Title,Target_Population_N,Coding_Basis_N,Sample_Type_N) %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1)

# writexl::write_xlsx(Journal_special_target_population,"Journal_special_target_populationk.xlsx")

Journal_special_target_population2 <- readxl::read_xlsx("Journal_special_target_population.xlsx") %>% 
  dplyr::select(Article_IDs,Article_Title,`Summary-摘要`,`Disscu & Conclu`,Target_Population_N,Coding_Basis_N,Recode_target_population) %>% 
  dplyr::rename(Abstract = 3)

```


Next, I try to classify special target population
```{r}
## college

Journal_college_TP <- Journal_special_target_population2 %>% 
  dplyr::filter(grepl("大学生|研究生",Recode_target_population)) %>% 
  dplyr::filter(!Recode_target_population %in% c("大学生和青少年罪犯","女大学生","中学生和大学生"))

table(Journal_college_TP$Recode_target_population)


## children and adolenscent
Journal_children_adolenscent_TP <- Journal_special_target_population2 %>% 
  dplyr::filter(grepl("儿童|幼儿|青少年|初中生|高中生|小学生|中学生|中职|婴儿|学龄|学前",Recode_target_population))
```


## The basic situation about BTS data
```{r}
BTS_Overview <- lapply(BTS,function(df){
  
  df <- df %>% 
    dplyr::select(Article_Id,ISO3,ISO2)
  
  return(df)
})

BTS_Overview <- do.call(rbind,BTS_Overview)


BTS_Overview2 <- BTS_Overview %>% 
  dplyr::filter(!is.na(ISO2)) %>%   ## ISO2 is used to subsequent visualize the spatial distribution in and filter out the data with countries as NA.
  dplyr::group_by(ISO2) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Site = "BTS")

sum(BTS_Overview2$Proportion)


## n < 100 countries
BTS_n100 <- BTS_Overview2 %>% 
  dplyr::filter(n < 100)

## n < 1000
BTS_n1000 <- BTS_Overview2 %>% 
  dplyr::filter(n < 1000)
```


## The reported situation of Chinese Journals
```{r}
## calculate region data
# Journal_region_detail_tab <- Journal %>% 
#   dplyr::select(Article_IDs,Study_Number,Subjects_Group,Subjects_Recruitment_Area) %>% 
#   dplyr::filter(Subjects_Recruitment_Area != 0)
# 
# ## studies
# Journal_region_detail_study_num <- Journal_region_detail_tab %>% 
#   dplyr::distinct(Article_IDs,Study_Number) ## 680 studies
# 
# ## papers
# Journal_region_detail_papers_num <- Journal_region_detail_tab %>% 
#   dplyr::distinct(Article_IDs) ## 601 papers

Journal_report <- Journal %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())

report_list <- list()

for (i in names(Journal_report)){
  
  
  report_table <- data.frame(table(Journal_report[[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_report[i]),
                  proportion = round(Freq / sum(Freq),4))
  
  report_list[[i]] <- report_table
  
}

Journal_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 

### Calculate reported status of Educational_Attainment and Occupation
Journal_education_occupation <- Journal %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop")   ### 306 studies

## 20215075 need process

table(Journal_education_occupation $Educational_Attainment_N) ## FALSE 165 TRUE 141
table(Journal_education_occupation $Occupation_N)  ## FALSE 201 TRUE 105


Journal_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(165,141,201,105),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(0.54,0.46,0.66,0.34))


Journal_report <- rbind(Journal_report,Journal_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment method",
                                              "Recruitment area","Educational attainment",
                                              "Occupation","Sampling method",
                                              "SES","Ethnicity","Religious"),
                                   levels = c("Gender","Age","Recruitment_Method",
                                              "Recruitment_Area","Educational_Attainment",
                                              "Occupation","Sampling_Method",
                                              "SES","Ethnicity","Religious")),
                proportion = proportion *100)



## calculate sum
Journal_report %>% 
  dplyr::group_by(col_names) %>% 
  dplyr::summarise(Prop = sum(proportion))
```



### Visualize subjects information reported situations in Chinese journals
```{r}
Fig_Journal_report <- ggplot(Journal_report,aes(col_names,proportion,fill=Var1))+
  geom_col()+
  labs(x="",y="%")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  scale_fill_manual(values = c("#00BFC4","#B2B2B2"))

Fig_Journal_report

ggsave("Fig_Journal_report.pdf", Fig_Journal_report, device = "pdf", width=16, height = 9)

## Here, I remove some data sets to reduce data set clutter.
rm(report_list,report_table,i,Journal_education_occupation,Journal_education_occupation_table)
```


### Specific reports on some demographic categories
```{r}
Journal_age_report_detail <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Age,M_age,SD_age,Other_age) %>%
  dplyr::filter(Age == 1)

### Age report studies num
Journal_age_report_detail_study_num <- Journal_age_report_detail %>%
    dplyr::distinct(Article_IDs,Study_Number) ## 1034 studies

### Age report papers num
Journal_age_report_detail_papers_num <- Journal_age_report_detail_study_num %>% 
  dplyr::distinct(Article_IDs) ## 829 articles
  
### Age fuzzy report studies num
Journal_age_fuzzy_report <- Journal_age_report_detail %>% 
  dplyr::filter(is.na(M_age)) 

Journal_age_fuzzy_report_study_num <- Journal_age_fuzzy_report %>% 
  dplyr::distinct(Article_IDs) ## 121-6=115

## the above "-6" means aticles Mage coded in other_age, these articles are 20183340, 20183097, 20082227, 20214027, 20083017, 20181065


## Here, I remove some data sets to reduce data set clutter.
# rm(Journal_age_report_detail,Journal_age_report_detail_study_num,
#    Journal_age_fuzzy_report,Journal_age_fuzzy_report_study_num)


# writexl::write_xlsx(Journal, "Chin_Subj_articles_replaced.xlsx")
```


In this section, I began by testing and analyzing three main hypotheses.

# Test three hypotheses
## Test the 1st hypothesis
### Gender


Process gender data from Chinese journals.
```{r warning=FALSE}
## Filter for information-rich key variables
Journal_key_variable <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group_N,
                Sample_Size,Target_Population_N,Sample_Type_N,
                Gender,Male_Num,Female_Num,Age,M_age,SD_age,Other_age,
                Subjects_Recruitment_Area,Remark1,Remark2,Remark3)

# names(Journal_key_variable)

## Filter gender related variables
Journal_gender <- Journal_key_variable %>% 
  dplyr::select(-c(10:17)) %>% 
  dplyr::filter(Gender == 1)

## Part of the gender data is the proportion recorded, and part is the number of people, so I deal with it separately.

Journal_gender_decimal <- Journal_gender %>% 
  dplyr::filter(Male_Num < 1 & Female_Num < 1)

Journal_gender_integer <- Journal_gender %>%
  dplyr::filter(Male_Num > 1 | Female_Num > 1) %>% 
  dplyr::mutate_at(vars(4:9),as.numeric)


## Multiple groups of data are removed during processing, so re-create the data.frame and then merge them.
Journal_gender_integer_add <- data.frame(Article_IDs = c("20185082","20213045","20213048","20213048"),
                                         Study_Number = c("1","1","1","2"),
                                         Subjects_Group_N = NA,
                                         Sample_Size = c(33,81,68,59),
                                         Target_Population_N = c(1,1,3,3),
                                         Sample_Type_N = c(3,5,5,5),
                                         Gender = 1,
                                         Male_Num = c(26,49,31,28),
                                         Female_Num = c(7,32,37,31))

Journal_gender_integer2 <- bind_rows(Journal_gender_integer,Journal_gender_integer_add) 


## Process decimal
Journal_gender_decimal2 <- Journal_gender_decimal %>% 
  dplyr::mutate_at(vars(4:9),as.numeric) %>%
  dplyr::mutate(Male_Num = floor(Sample_Size*Male_Num),
                Female_Num = Sample_Size - Male_Num)

## Combining journal gender data for both categories
Journal_gender2 <- bind_rows(Journal_gender_integer2,Journal_gender_decimal2)%>% 
  dplyr::filter(!is.na(Male_Num)) 


## general
Journal_gender_general <- Journal_gender2 %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::summarise(Male_Num = sum(Male_Num,na.rm = TRUE),
                   Female_Num = sum(Female_Num,na.rm = TRUE),
                   Male_Proportion = Male_Num/(Male_Num + Female_Num)*100,
                   Female_Proportion = Female_Num/(Male_Num + Female_Num)*100)

sum(Journal_gender_general$Male_Proportion)+sum(Journal_gender_general$Female_Proportion)


## special
Journal_gender_special <- Journal_gender2 %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::summarise(Male_Num = sum(Male_Num,na.rm = TRUE),
                   Female_Num = sum(Female_Num,na.rm = TRUE),
                   Male_Proportion = Male_Num/(Male_Num + Female_Num)*100,
                   Female_Proportion = Female_Num/(Male_Num + Female_Num)*100)

sum(Journal_gender_special$Male_Proportion)+sum(Journal_gender_special$Female_Proportion)


table(Journal_gender_special$Sample_Type_N)
```


infants and toddlers & special target population

```{r}
## Filter studies targeting infants/toddlers from "Journal_special_target_population2"

Journal_gender_Infants_toddlers_TP <- Journal_special_target_population2 %>% 
  dplyr::select(Article_IDs,Article_Title,Recode_target_population) %>% 
  dplyr::filter(grepl("幼儿|岁儿童|学步儿|学前|学龄|低龄", Recode_target_population)) %>% 
  dplyr::filter(!grepl("幼儿父亲|幼儿教师|母亲|学前儿童父母|8|10|11|12",Recode_target_population))
  

## merge the above data.frame with "Journal" data.frame
Journal_gender_Infants_toddlers_TP_IDs <- Journal %>% 
  dplyr::filter(Article_IDs_N %in% Journal_gender_Infants_toddlers_TP$Article_IDs) %>% 
  dplyr::select(Article_IDs_N,Article_Title,Study_Number_N,Subjects_Group_N,
                M_age,SD_age,Other_age,Age,
                Gender,Male_Num,Female_Num,
                Sample_Type_N,Sample_Type_info_N) %>% 
  dplyr::filter(Gender == 1) %>% 
  dplyr::filter(!grepl("父亲|母亲|父母组",Subjects_Group_N)) %>% 
  dplyr::left_join(Journal_gender_Infants_toddlers_TP,
                   by = c("Article_IDs_N" = "Article_IDs")) %>%
  dplyr::select(1:2,14:15,3:13)


## calculate gender num
## male num and female both are integer
Journal_gender_Infants_toddlers <- Journal_gender_Infants_toddlers_TP_IDs %>% 
  dplyr::summarise(Male_Num = sum(as.numeric(Male_Num)),
                   Female_Num = sum(as.numeric(Female_Num)),
                   Male_Proportion = Male_Num/(Male_Num+Female_Num)*100,
                   Female_Proportion = Female_Num/(Male_Num+Female_Num)*100) ## Male 51.58, Female 48.42
sum(Journal_gender_Infants_toddlers$Male_Proportion)+sum(Journal_gender_Infants_toddlers$Female_Proportion)
```


Here, I remove some data sets to reduce data set clutter.
```{r}
rm(Journal_gender_decimal,Journal_gender_decimal2,
   Journal_gender_integer,Journal_gender_integer2,
   Journal_gender_integer_add,Journal_gender)
```


Process gender data from BTS.
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
BTS_gender_list <- list()

for(i in seq_along(BTS)) {
  
  BTS_name <- names(BTS)[i] 
  
 if ("Gender" %in% names(BTS[[i]])) {  
   
  BTS_gender <- BTS[[i]] %>% 
    dplyr::mutate(Gender = str_to_title(Gender)) %>% 
    dplyr::filter(Gender == "Female" | Gender == "Male") %>% 
    dplyr::mutate(Data_Source =  BTS_name)
  
  BTS_gender_list[[BTS_name]] <- BTS_gender
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Gender' column.\n", BTS_name))  
  } 

}
```


Combine gender data from Chinese Journal and BTS.
```{r}
## Extracting Chinese data
BTS_gender_CHN <- lapply(BTS_gender_list, function(df){
  
  df %>% 
    dplyr::filter(grepl("CHN", ISO3, ignore.case = TRUE)) %>% 
    dplyr::select(ISO3,Data_Source,Gender,Target_Population) 

})

BTS_gender_CHN <- do.call(rbind,BTS_gender_CHN)


## General population
BTS_gender_CHN_general <- BTS_gender_CHN %>%
  dplyr::filter(Target_Population == 2 | Target_Population == 3) %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate(Data_Source = "BTS Chinese")

sum(BTS_gender_CHN_general$Proportion)  


## Combine CHN journal data and set factor
H1_gender_general <- BTS_gender_CHN_general %>% 
  dplyr::add_row(Gender = c("Female","Male"), n = c(57570,48059),
                 Proportion = c(54.50,45.50),Data_Source = "Journal")   ## Here, enter data manually.


H1_gender_factor_general <- H1_gender_general %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Data_Source)


H1_gender_general <- H1_gender_general %>% 
  dplyr::mutate(Data_Source = factor(Data_Source,
                                     levels = H1_gender_factor_general))
```


Visualize gender data for Chinese journals and BTS.
```{r}
H1_Fig_gender_general <- ggplot(data = H1_gender_general,aes(Data_Source,Proportion,fill = Gender))+
  geom_col()+
  geom_hline(yintercept = 50, linetype = "dashed", color = "#666666")+
  labs(y="Proportion")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  xlab("Data source")

H1_Fig_gender_general 
```

Here I tested whether the gender proportion distribution from Chinese five journal data are similar to that of the BTS data. I used Bayesian multinomial test (Bayesian goodness-of-fit test) to examine whether the observed (BTS data) fit the expected (Chinese five journal data).

$H_0$: $\theta = c$, where $c$ is defined by Chinese five journal data; $H_1$: $\theta$ is free to vary.

I compared the general population between the two.

```{r}
H1_gender_bayes_general <- H1_gender_general %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

H1_BF_gender_general <- BayesMultiNomial(dataset = H1_gender_bayes_general,
                                             factor = "Gender",
                                             observed = "BTS Chinese",
                                             expected = "Journal")
```

However, I found there no different between BTS data and the general population of Chinese five journal data, with $Log(BF_{10})$ = `r H1_BF_gender_general$BF$LogBF10`.


In this part, I will analysis gender based on the special target population. For the first research question, only Lucca et al.(2024)' target population is special target population Specifically, it focuses on infants. Therefore, in specila target population, I will compare Lucca et al..(2024) with Chinese journal studies targeting infants/toddlers.
```{r}
Lucca_gender_special <- BTS[[21]] %>% 
  dplyr::filter(ISO2 == "CN") %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n = n()) %>% ## Male 79, Female 77
  dplyr::ungroup() %>% 
  dplyr::filter(!is.na(Gender)) %>% 
  dplyr::mutate(Porportion = n/sum(n)*100, ## Male 50.64, Female 49.36
                Data_Source = "Lucca") %>% 
  dplyr::select(1,3,4)

sum(Lucca_gender_special$Porportion)


## create a data.frame that include two data.source
H1_gender_bayes_special <- data.frame(Gender = c("Female","Male"),
           Lucca = c(49.36,50.64),
           Journal = c(53.62,46.38))

## calculate BF
H1_BF_gender_special <-  BayesMultiNomial(dataset = H1_gender_bayes_special,
                                          factor = "Gender",
                                          observed = "Lucca",
                                          expected = "Journal")
```
In the specific population of infants and toddlers, I did not find significant difference between Lucca et al. (2024) and Chinese five journal data, with $Log(BF_{10})$ = `r H1_BF_gender_special$BF$LogBF10`.



At the end of gender data processing for hypothesis 1, I removed some data sets to reduce data set clutter.
```{r}
rm(H1_gender_factor_general,i,BTS_name)
```


### Age
Reprocess age data from Chinese journals.
```{r warning=FALSE}
Journal_age <- Journal_key_variable %>% 
  dplyr::select(-c(7:9,14:17)) %>% 
  dplyr::filter(Age == 1 & !is.na(Sample_Size)) %>% 
  dplyr::filter(!is.na(M_age) & !is.na(SD_age))


## Filter M_age have multiple group data
Journal_strings_age <- Journal_age %>% 
  dplyr::filter(grepl(";|:|：|,",M_age)) %>% 
  dplyr::mutate(M_age = gsub("[;；]",";",M_age),
                SD_age = gsub("[;；]",";",SD_age)) %>% 
  tidyr::separate_rows(c(M_age,SD_age),sep = ";") %>% 
  dplyr::mutate(M_age = str_extract(M_age,"\\d+\\.\\d+|\\d+"),
                SD_age = str_extract(SD_age,"\\d+\\.\\d+|\\d+")) 

## save `Journal_strings_age` and return to the original papers to re-enter and verify the data.
# writexl::write_xlsx(Journal_strings_age,"Journal_strings_age.xlsx")

Journal_strings_age_newdata <- readxl::read_xlsx("Journal_strings_age.xlsx") %>% 
  dplyr::filter(!is.na(Sample_Size)) %>% 
  dplyr::mutate_at(vars(4:9),as.numeric)


## Filter M_age only have single values data
Journal_single_age <- Journal_age %>% 
  dplyr::filter(!grepl(";|:|：|,",M_age)) %>% 
  dplyr::mutate_at(vars(4:9),as.numeric)


## Some articles contain the mean (M) and standard deviation (SD) of ages, but they was coded in "Other_Age". The V1 version of the document is stored separately.
Journal_otherage <- Journal_otherage %>% 
  dplyr::mutate(Article_IDs = as.character(Article_IDs),
                Study_Number = as.character(Study_Number)) %>% 
  dplyr::rename(M_age = 8,SD_age = 9,Other_age = 10) %>% 
  dplyr::filter(!is.na(SD_age))

## Combining journal age data for three categories 
Journal_age2 <- bind_rows(Journal_strings_age_newdata,Journal_single_age,Journal_otherage)

sum(Journal_age2$Sample_Size)  ## 370426
```


Since raw data is not available for papers in Chinese journals, I simulated the raw data using the method used in the Stges 1 of registration report. It is then combined with BTS and compared with census data.

First, I created a function that groups ages into five-year intervals for the purpose of creating a Population pyramid chart.
```{r}
Sim_Sens_mult_five <- function(Mean0, diff_age, SD0, sample_N=Sample_Size){

  
  ageData_five <-  c(pnorm(4, mean = Mean0, sd = SD0) * sample_N,
                 (pnorm(9, mean = Mean0, sd = SD0) - pnorm(4, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(14, mean = Mean0, sd = SD0) - pnorm(9, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(19, mean = Mean0, sd = SD0) - pnorm(14, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(24, mean = Mean0, sd = SD0) - pnorm(19, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(29, mean = Mean0, sd = SD0) - pnorm(24, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(34, mean = Mean0, sd = SD0) - pnorm(29, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(39, mean = Mean0, sd = SD0) - pnorm(34, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(44, mean = Mean0, sd = SD0) - pnorm(39, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(49, mean = Mean0, sd = SD0) - pnorm(44, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(54, mean = Mean0, sd = SD0) - pnorm(49, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(59, mean = Mean0, sd = SD0) - pnorm(54, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(64, mean = Mean0, sd = SD0) - pnorm(59, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(69, mean = Mean0, sd = SD0) - pnorm(64, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(74, mean = Mean0, sd = SD0) - pnorm(69, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(79, mean = Mean0, sd = SD0) - pnorm(74, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(84, mean = Mean0, sd = SD0) - pnorm(79, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(89, mean = Mean0, sd = SD0) - pnorm(84, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(94, mean = Mean0, sd = SD0) - pnorm(89, mean = Mean0, sd = SD0)) *sample_N,
                 (1 - pnorm(94, mean = Mean0, sd = SD0)) * sample_N)
  
  
    # create a dataframe with ageData_five
  Sim_agefive_df <- setNames(data.frame(matrix(ncol = 2, nrow = 20)), c("ageBins", "sim1"))
  Sim_agefive_df$ageBins <- c("0~4","5~9","10~14","15~19","20~24",
                              "25~29","30~34","35~39","40~44","45~49",
                              "50~54","55~59","60~64","65~69","70~74",
                              "75~79","80~84","85~89", "90~94",">=95")
  Sim_agefive_df$sim1[1:20] <- ageData_five
  

  return(Sim_agefive_df)
}
```


I then continued to use the same steps to divide age into psychological developmental stages.
```{r}
Sim_Sens_mult_PsyStages <- function(Mean1, diff_age, SD1, sample_N=Sample_Size){
  
  
  ageData_PsyStages <-  c(pnorm(17, mean = Mean1, sd = SD1) * sample_N,
                          (pnorm(26, mean = Mean1, sd = SD1) - pnorm(17, mean = Mean1, sd = SD1)) *sample_N,
                          (pnorm(41, mean = Mean1, sd = SD1) - pnorm(26, mean = Mean1, sd = SD1)) *sample_N,
                          (pnorm(60, mean = Mean1, sd = SD1) - pnorm(41, mean = Mean1, sd = SD1)) *sample_N,
                          (1 - pnorm(60, mean = Mean1, sd = SD1)) * sample_N)
  
    
  # create a dataframe with ageData_PsyStages
  Sim_agePsyStages_df <- setNames(data.frame(matrix(ncol = 2, nrow = 5)), c("ageBins", "sim1"))
  Sim_agePsyStages_df$ageBins <- c("<=17", "18~25", "26~40", "41~60", ">=61")
  Sim_agePsyStages_df$sim1[1:5] <- ageData_PsyStages
  

  return(Sim_agePsyStages_df)
}
```


Meanwhile, I created func to process age data simulation in 10-year-old segment.
```{r}
Sim_Sens_mult_interval10 <- function(Mean2, diff_age2, SD2, sample_N2=Sample_Size){

  
  # 0~10, 11~20, 21~30, 31~40, 41~50, 51~60, 61~
  ageData_interval10 <-  c(pnorm(10, mean = Mean2, sd = SD2) * sample_N2,
                           (pnorm(21, mean = Mean2, sd = SD2) - pnorm(10, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(31, mean = Mean2, sd = SD2) - pnorm(21, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(41, mean = Mean2, sd = SD2) - pnorm(31, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(51, mean = Mean2, sd = SD2) - pnorm(41, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(61, mean = Mean2, sd = SD2) - pnorm(51, mean = Mean2, sd = SD2)) *sample_N2,
                           (1 - pnorm(61, mean = Mean2, sd = SD2)) * sample_N2  
)
  
  
    # create a dataframe with ageData1 and ageData2:
  Sim_ageinterval10_df <- setNames(data.frame(matrix(ncol = 2, nrow = 7)), c("ageBins", "sim1"))
  Sim_ageinterval10_df$ageBins <- c("<=10", "11~20", "21~30", "31~40", "41~50", "51~60", ">=61")
  Sim_ageinterval10_df$sim1[1:7] <- ageData_interval10
  
  
  return(Sim_ageinterval10_df)
}
```


In the following part, I will calculate other age data based on different target population.The first is general population.

5-years-old
```{r}
Journal_age_general <-  Journal_age2 %>%
  dplyr::filter(Target_Population_N != 1)


## simulate different categories age data
### five-year-old
Sim_Journal_age_five1_general <- lapply(1:nrow(Journal_age_general),function(i){
  
  Sim_Sens_mult_five(Mean0 = Journal_age_general$M_age[i],
                diff_age = 0,
                SD0 = Journal_age_general$SD_age[i],
                sample_N = Journal_age_general$Sample_Size[i])
  
  })


Sim_Journal_age_five2_general <- do.call(rbind,Sim_Journal_age_five1_general)


Sim_Journal_age_five3_general <- Sim_Journal_age_five2_general %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                           "25~29","30~34","35~39","40~44","45~49",
                                           "50~54","55~59","60~64","65~69","70~74",
                                           "75~79","80~84","85~89", "90~94",">=95")))


## Calculate the sample difference between the coded data and the simulated data
sum(Journal_age_general$Sample_Size)-sum(Sim_Journal_age_five3_general$sim1) 
```


PsyStages
```{r}
## PsyStages
Sim_Journal_age_PsyStages1_general <- lapply(1:nrow(Journal_age_general),function(i){
  
  Sim_Sens_mult_PsyStages(Mean1 = Journal_age_general$M_age[i],
                diff_age = 0,
                SD1 = Journal_age_general$SD_age[i],
                sample_N = Journal_age_general$Sample_Size[i])
  
  })


Sim_Journal_age_PsyStages2_general <- do.call(rbind,Sim_Journal_age_PsyStages1_general)


Sim_Journal_age_PsyStages3_general <- Sim_Journal_age_PsyStages2_general %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=17","18~25", "26~40", "41~60", ">=61")))


## Calculate the sample difference between the coded data and the simulated data
sum(Journal_age_general$Sample_Size)-sum(Sim_Journal_age_PsyStages3_general$sim1,na.rm = TRUE)
```


interval10
```{r}
Sim_Journal_age_interval101_general <- lapply(1:nrow(Journal_age_general),function(i){
  
  Sim_Sens_mult_interval10(Mean2 = Journal_age_general$M_age[i],
                diff_age2 = 0,
                SD2 = Journal_age_general$SD_age[i],
                sample_N2 = Journal_age_general$Sample_Size[i])
  
  })


Sim_Journal_age_interval102_general <- do.call(rbind,Sim_Journal_age_interval101_general)


## Use simulation function to process data. 
Sim_Journal_age_interval103_general <- Sim_Journal_age_interval102_general %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=10", "11~20", "21~30", 
                                           "31~40", "41~50", "51~60", ">=61")))
  


## Calculate the sample difference between the coded data and the simulated data
sum(Journal_age_general$Sample_Size)-sum(Sim_Journal_age_interval103_general$sim1,na.rm = TRUE)
```

As mentioned before, the sepcial target population of BTS is only Lucca et al.(2024), its target population is babies, and there is no need to compare ages between BTS and Journals in age.


Process age data from BTS.
```{r}
# BTS1 <- BTS[-c(3,16,17,8)]
BTS_age_list <- list()

for(i in seq_along(BTS)){
  
  BTS_name <- names(BTS)[i]
  
  if("Age" %in% names(BTS[[i]])){
    
    BTS_age <- BTS[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,Target_Population,ISO3) %>% 
      dplyr::mutate(Age = as.numeric(Age)) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(-Inf,4.5,9.5,14.5,19.5,24.5,
                                           29.5,34.5,39.5,44.5,49.5,
                                           54.5,59.5,64.5,69.5,74.5,
                                           79.5,84.5,89.5,94.5,Inf),
                                labels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" ),
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
  
BTS_age_list[[BTS_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name))  
  } 
}

## merge data.frame in list
BTS_age <-  bind_rows(BTS_age_list)
```


I filter Chinese age data from BTS, and combine BTS CHN data with Journals data. Considering the different target population, I process all data firstly.
```{r}
BTS_age_general_CHN <- BTS_age %>% 
  dplyr::filter(ISO3 == "CHN" & (Target_Population == 2 | Target_Population == 3)) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "BTS Chinese")


sum(BTS_age_general_CHN$Proportion) 


## combine 2 dataframe
H1_age_general <- Sim_Journal_age_five3_general %>%
  dplyr::rename(n = 2) %>%
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "Journal") %>% 
  dplyr::bind_rows(BTS_age_general_CHN) %>% 
  dplyr::add_row(ageBins = ">=95",n = 0, 
                 Proportion =0 ,Data_Source = "BTS Chinese")


H1_age_general %>% 
  dplyr::group_by(Data_Source) %>% 
  dplyr::summarise(Porp = sum(Proportion))


## set ageBins as factor to plot
H1_age_general <- H1_age_general %>% 
  dplyr::mutate(ageBins = factor(ageBins,
                                 levels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))

# ## skewness
# BTS_age_skewness_list <- list()
# 
# for(i in seq_along(BTS)){
#   
#   BTS_name_skewness <- names(BTS)[i]
#   
#   if("Age" %in% names(BTS[[i]])){
#     
#     BTS_age_skewness <- BTS[[i]] %>% 
#       dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
#       dplyr::select(Article_Id,Age,Target_Population,ISO3) %>% 
#       dplyr::mutate(Age = as.numeric(Age)) %>% 
#       dplyr::filter(ISO3 == "CHN")
#     
#     BTS_age_skewness_list[[BTS_name_skewness]] <- BTS_age_skewness
#   
# } else {  
#  
#     cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name_skewness))  
#   } 
# }
# ## merge data.frame in list
# BTS_age_skewness <-  bind_rows(BTS_age_skewness_list)
# 
# library(psych)
# ##BTS
# BTS_stats <- describe(BTS_age_skewness$Age, na.rm = TRUE)
# 
# BTS_stats$skew
# 
# ## Journal
# Journal_stats <- describe(Journal_age2$M_age, na.rm = TRUE)
# 
# Journal_stats$skew
```



Visualize age data from Chinese journals and BTS.

in general target population
```{r}
H1_Fig_age_general <- ggplot(data= H1_age_general, aes(x=ageBins, y=ifelse(Data_Source=="BTS Chinese", -Proportion, Proportion),fill = Data_Source)) +
  geom_col(alpha=0.8, width = 1) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  scale_fill_manual(values = c("BTS Chinese" = "#619CFF", "Journal" = "#7CAE00")) +
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))


H1_Fig_age_general


# H1_Fig_gender_age_general <- H1_Fig_gender_general + H1_Fig_age_general +
#   plot_annotation(tag_levels = 'A')
# 
# H1_Fig_gender_age_general 
# 
# ggsave("H1_Fig_gender_age_general.pdf", H1_Fig_gender_age_general, device = "pdf", width=18, height = 9)
```


Process age for Bayesian multinomial test. First of all, I processed BTS CHN age in psychological development stages.
```{r}
BTS_age_PsyStages_list <- list()

for(i in seq_along(BTS)){
  
  BTS_name <- names(BTS)[i]
  
  if("Age" %in% names(BTS[[i]])){
    
    BTS_age <- BTS[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::mutate(Age = as.numeric(Age)) %>% 
      dplyr::select(Article_Id,Age,Target_Population,ISO3) %>% 
      #dplyr::group_by(ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(0, 17.5, 25.5, 40.5, 60.5, Inf),
                                labels = c("<=17","18~25","26~40", "41~60", ">=61"),
                                levels = c("<=17","18~25","26~40", "41~60", ">=61")))
  
BTS_age_PsyStages_list[[BTS_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name))  
  } 
}


## merge data.frame in list
BTS_age_PsyStages <-  do.call(rbind,BTS_age_PsyStages_list)
```


Secondly, I processed BTS CHN age in 10-year-old segment.
```{r}
BTS_age_interval10_list <- list()

for(i in seq_along(BTS)){
  
  BTS_name <- names(BTS)[i]
  
  if("Age" %in% names(BTS[[i]])){
    
    BTS_age <- BTS[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,Target_Population,ISO3) %>% 
      dplyr::mutate(Age = as.numeric(Age)) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(0, 10.5, 20.5, 30.5, 40.5, 50.5, 60.5, Inf),
                                labels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"),
                                levels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61")))
  
BTS_age_interval10_list[[BTS_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name))  
  } 
}


## merge data.frame in list
BTS_age_interval10 <-  do.call(rbind,BTS_age_interval10_list)
```


And then, I filtered BTS CHN data.

```{r}
## psychological development stages in BTS
### psychological development
BTS_age_PsyStages_CHN_general <- BTS_age_PsyStages %>% 
  dplyr::filter(ISO3 == "CHN" & Target_Population != 1) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "BTS Chinese")

sum(BTS_age_PsyStages_CHN_general$Proportion) 



## 10-year-old segment in BTS
BTS_age_interval10_CHN_general <- BTS_age_interval10 %>% 
  dplyr::filter(ISO3 == "CHN" & Target_Population != 1) %>% 
  dplyr::select(1,5) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "BTS Chinese") 

sum(BTS_age_interval10_CHN_general$Proportion)
```


Next, I Combined two CHN data to Bayesian multinomial test in two different classifications (PsyStages and 10-year-old). One is PsyStages.
```{r}
## general population 
H1_PsyStages_bayes_general <- Sim_Journal_age_PsyStages3_general %>% 
  dplyr::rename(n = 2) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "Journal") %>% 
  bind_rows(BTS_age_PsyStages_CHN_general) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)
## two data sum both 100 ##

H1_BF_PsyStages_general <- BayesMultiNomial(dataset = H1_PsyStages_bayes_general,
                                          factor = "ageBins",
                                          observed = "BTS Chinese",
                                          expected = "Journal")
```


The other is interval10.
```{r}
## general population 
H1_interval10_bayes_general <- Sim_Journal_age_interval103_general %>% 
  dplyr::rename(n = 2) %>%
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "Journal") %>% 
  bind_rows(BTS_age_interval10_CHN_general) %>%
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

sum(H1_interval10_bayes_general$Journal)  
sum(H1_interval10_bayes_general$`BTS Chinese`)


H1_BF_interval10_general <- BayesMultiNomial(dataset = H1_interval10_bayes_general,
                                          factor = "ageBins",
                                          observed = "BTS Chinese",
                                          expected = "Journal")
```

For different target population, I compared general population for them firstly, I found strong evidence for $H_1$ that the age distribution from the Chinese subjects data of BTS data is different form the Chinese journals data, the Bayesian multinomial test shows $Log(BF_{10})$ = `r H1_BF_PsyStages_general$BF$LogBF10`.


Meanwhile, I found strong evidence support $H_1$ for another age category,the Bayesian multinomial test shows $Log(BF_{10})$ = `r H1_BF_interval10_general$BF$LogBF10`.


### attainment education
Try to process educational attainment data from Chinese journal.
```{r}
# Journal_edu <- Journal %>% 
#   dplyr::filter(Educational_Attainment_N == 1) %>% 
#   dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size,M_age,SD_age,
#                 Educational_Attainment_info_N) %>% 
#   dplyr::mutate(Higher_edu = NA,
#                 Below_higher_edu = NA,
#                 Compulsory_edu_above = NA,
#                 Compulsory_edu = NA ,
#                 M_edu_year = NA,
#                 SD_edu_year = NA)
# 
# writexl::write_xlsx(Journal_edu,"Journal_edu.xlsx")


Journal_edu <- readxl::read_xlsx("Journal_edu.xlsx")


## analysis edu base on target population
## general population
Journal_edu_general_article <- Journal_key_variable %>% 
  dplyr::select(Article_IDs,Target_Population_N) %>% 
  dplyr::distinct(Article_IDs,Target_Population_N) %>%   
  dplyr::filter(Target_Population_N != 1)
  

## filter target population is general population
Journal_edu_general <- Journal_edu %>% 
  dplyr::filter(Article_IDs %in% Journal_edu_general_article$Article_IDs) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size))
```


In our study, we have three categories of educational attainments. I process three class data respectively. The first category is education years. I will use M and SD in the paper to simulate the number of subjects with the latter two categories of education level, and then combine them with the latter two categories respectively, and finally complete the subsequent analysis and visualization.
```{r}
## I found there is no data for simul

Journal_edu2_year <- Journal_edu_general %>% 
  dplyr::select(1:15) %>% 
  dplyr::filter(!is.na(M_edu_year) & !is.na(SD_edu_year)) %>% 
  dplyr::filter(is.na(College_and_above))


## If there is data for the other two categories, there is no need to simulate using years of education, which is a screening done after looking at the data



## Simulation of education data based on normal distribution
College_threshold <- 12 ## The education years of college is set at 12
Highschool_threshold <- 9 ## The education years of high school is set at 9


## create a data.frame.
Journal_edu2_year_simul <- data.frame(Article_IDs = character(),
                      Study_Number = character(),
                      Subjects_Group = character(),
                      Sample_Size = integer(),
                      College_and_above = integer(),
                      Below_college = integer(),
                      High_school_and_above = integer(),
                      Below_high_school = integer())
 

# Calculate sample size for each educated stages
for (i in 1:nrow(Journal_edu2_year)) {
  Article_IDs = Journal_edu2_year$Article_IDs[i]
  Study_Number = Journal_edu2_year$Study_Number[i]
  Subjects_Group = Journal_edu2_year$Subjects_Group[i]
  Sample_Size <- Journal_edu2_year$Sample_Size[i] 
  M_edu_year <- Journal_edu2_year$M_edu_year[i]  
  SD_edu_year <- Journal_edu2_year$SD_edu_year[i] 
  
# Use the cumulative distribution function to calculate the proportion of subjects below each threshold
  Prob_college_and_above <- pnorm(College_threshold, mean = M_edu_year, sd = SD_edu_year, lower.tail = FALSE)
  Prob_highschool_and_above <- pnorm(Highschool_threshold, mean = M_edu_year, sd = SD_edu_year, lower.tail = FALSE)
  
#Count people by proportion.
  College_and_above_count <- round(Sample_Size * Prob_college_and_above)
  College_below_count <- Sample_Size - College_and_above_count
  Highschool_and_above_count <- round(Sample_Size * Prob_highschool_and_above)
  Highschool_below_count <- Sample_Size - Highschool_and_above_count
  

# Adds the result to the data.frame
Journal_edu2_year_simul <- rbind(Journal_edu2_year_simul, data.frame(Article_IDs = Article_IDs,
                                       Study_Number = Study_Number,
                                       Subjects_Group = Subjects_Group,
                                       Sample_Size = Sample_Size,
                                       College_and_above = College_and_above_count,
                                       Below_college = College_below_count,
                                       High_school_and_above = Highschool_and_above_count,
                                       Below_high_school = Highschool_below_count))
}
```


The second category is 'college and above' and 'below college'.
```{r}
Journal_college <- Journal_edu_general %>% 
  dplyr::select(-c(5:9,12:15)) %>% 
  dplyr::filter(!is.na(College_and_above) & !is.na(Below_college))

##  both > 1
Journal_college_integer <- Journal_college  %>%
  dplyr::filter(College_and_above > 1 & Below_college > 1) %>%
  dplyr::summarise(College_and_above = sum(College_and_above),
                   Below_college = sum(Below_college)) 
  

## both < 1
Journal_college_decimal <- Journal_college  %>%
  dplyr::filter(College_and_above <= 1 & Below_college <= 1) %>% 
  dplyr::mutate(Total_college_and_above = College_and_above + Below_college) %>% 
  dplyr::mutate(College_and_above_tab = floor(Sample_Size * College_and_above),
                Below_college_tab = ifelse(Total_college_and_above == 1, Sample_Size - College_and_above_tab, floor(Sample_Size * Below_college))) %>% 
  dplyr::mutate(tab = College_and_above_tab + Below_college_tab) %>% 
  dplyr::summarise(College_and_above = sum(College_and_above_tab),
                   Below_college = sum(Below_college_tab)) 
```


The third category is 'high shcool and above' and 'below high school'
```{R}
Journal_high_school <- Journal_edu_general %>% 
  dplyr::select(4,12:13) %>% 
  dplyr::filter(!is.na(High_school_and_above) & !is.na(Below_high_school))

##  both > 1
Journal_high_school_integer <- Journal_high_school %>%
  dplyr::filter(High_school_and_above > 1 & Below_high_school > 1) %>%
  dplyr::summarise(High_school_and_above = sum(High_school_and_above),
                   Below_high_school = sum(Below_high_school)) 
  
## both < 1
Journal_high_school_decimal <- Journal_high_school  %>%
  dplyr::filter(High_school_and_above <= 1 & Below_high_school <= 1) %>% 
  dplyr::mutate(Total_High_school = High_school_and_above + Below_high_school) %>% 
  dplyr::mutate(High_school_and_above_tab = floor(Sample_Size * High_school_and_above),
                Below_high_school_tab = ifelse(Total_High_school == 1, Sample_Size - High_school_and_above_tab, floor(Sample_Size * Below_high_school))) %>% 
  dplyr::mutate(tab = High_school_and_above_tab + Below_high_school_tab) %>% 
  dplyr::summarise(High_school_and_above = sum(High_school_and_above_tab),
                   Below_high_school = sum(Below_high_school_tab)) 
```


Combine education year with the other categories respectively.
```{r}
## combine college data
 Journal_college2 <-  bind_rows(Journal_college_decimal, Journal_college_integer) %>% 
  dplyr::add_row(College_and_above = 1, Below_college = 141) %>% 
  dplyr::summarise(College_and_above = sum(College_and_above),
                   Below_college = sum(Below_college)) %>% 
  tidyr::pivot_longer(cols = c(College_and_above,Below_college),
                      names_to = "Educational_attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "Journal")

sum(Journal_college2$Proportion)


## combine high school data
Journal_high_school2  <-   bind_rows(Journal_high_school_integer,
                                     Journal_high_school_decimal) %>% 
  dplyr::add_row(High_school_and_above = 33, Below_high_school = 109) %>% 
  dplyr::summarise(High_school_and_above = sum(High_school_and_above),
                   Below_high_school = sum(Below_high_school)) %>% 
  tidyr::pivot_longer(cols = c(High_school_and_above,Below_high_school),
                      names_to = "Educational_attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "Journal")  

sum(Journal_high_school2$Proportion)
```


Now, in this part, I process chinese subjects' edu data of BTS
```{r}
# names(BTS_edu_list)
BTS_edu_list2 <- BTS_edu_list[-c(8,12)]

BTS_edu_CHN <- lapply(BTS_edu_list2,function(df_edu){
  
  df_edu <- df_edu %>% 
    dplyr::filter(Country == "CHN" | Country == "CN" | Country == "China")
  
  return(df_edu)
})

BTS_edu_CHN <- do.call(rbind,BTS_edu_CHN)
```


Classify educational attainment and calculate special num
```{r}
## calculate
BTS_college_CHN <- BTS_edu_CHN %>%
  dplyr::filter(!is.na(College)) %>% 
  dplyr::group_by(College) %>%
  dplyr::summarise(n=n()) %>% 
  dplyr::rename(Educational_attainment = 1, Num = 2) %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "BTS Chinese")

 sum(BTS_college_CHN$Proportion)
  
  
BTS_highschool_CHN <- BTS_edu_CHN %>%
  dplyr::filter(!is.na(Highschool)) %>% 
  dplyr::group_by(Highschool) %>%
  dplyr::summarise(n=n()) %>% 
  dplyr::rename(Educational_attainment = 1, Num = 2) %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "BTS Chinese")

sum(BTS_highschool_CHN$Proportion)


## Combine data
H1_edu_college <- rbind(Journal_college2,BTS_college_CHN)

H1_edu_highschool <- rbind(Journal_high_school2,BTS_highschool_CHN)


## set factor 
H1_edu_college <- H1_edu_college %>% 
  dplyr::mutate(Educational_attainment = ifelse(Educational_attainment == "Below_college",
                                                "Below college","College and above"),
                Educational_attainment = factor(Educational_attainment,
                                                levels = c("College and above","Below college")))


H1_edu_highschool <- H1_edu_highschool %>% 
  dplyr::mutate(Educational_attainment = ifelse(Educational_attainment == "Below_high_school","Below high school","High school and above"),
                Educational_attainment = factor(Educational_attainment,
                                                levels = c( "High school and above",
                                                            "Below high school")))
```


visulize the edu data
```{r}
## college
H1_Fig_college <- ggplot(data = H1_edu_college,aes(Data_source,Proportion,fill = Educational_attainment))+
  geom_col()+
  theme_classic()+ 
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title= element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"),
        strip.text = element_text(size = 16,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black"))+
  xlab("Data source")

H1_Fig_college

## highschool
H1_Fig_highschool <- ggplot(data = H1_edu_highschool,aes(Data_source,Proportion,fill =Educational_attainment))+
  geom_col()+
  theme_classic()+ 
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title= element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"),
        strip.text = element_text(size = 16,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black"))+
  xlab("Data source")

H1_Fig_highschool


H1_Fig_gender_age_edu_general <-  H1_Fig_gender_general + H1_Fig_age_general + H1_Fig_college + H1_Fig_highschool + 
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')&
  theme(legend.position = 'bottom')

ggsave("H1_Fig_gender_age_edu_general.pdf",H1_Fig_gender_age_edu_general, device = "pdf", width=18, height = 18)

H1_Fig_gender_age_edu_general
```


Here I tested whether the educatinal attainment proportion distribution from Chinese five journal data are similar to that of the BTS data.


First, I calculate the first category: college.
```{r}
H1_edu_college_bayes <- H1_edu_college %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_source, values_from = Proportion)


H1_BF_edu_college <- BayesMultiNomial(dataset = H1_edu_college_bayes,
                                      factor = "Educational_attainment",
                                      observed = "BTS Chinese",
                                      expected = "Journal")
```

I found strong evidence for the $H_1$ that the college proportion from Chinese five journal data is different from that of BTS data, with $Log(BF_{10})$ = `r H1_BF_edu_college$BF$LogBF10`.

and then, I continue processing the second category: high school.

```{r}
H1_edu_highschool_bayes <- H1_edu_highschool %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_source, values_from = Proportion)


H1_BF_edu_highschool <- BayesMultiNomial(dataset = H1_edu_highschool_bayes,
                                      factor = "Educational_attainment",
                                      observed = "BTS Chinese",
                                      expected = "Journal")
```

Similarity, I also found strong evidence for the $H_1$ that the high schools proportion from Chinese five journal data is different from that of BTS data, with $Log(BF_{10})$ = `r H1_BF_edu_highschool$BF$LogBF10`.


## Test the 2st hypothesis


For hypothesis 2, I first tried to analyze the data in general. I would then compare certain demographic characteristics of the Chinese subjects in studies (BTS and Chinese journals) with those corresponding to Census data or other representative large general social surveys (e.g., CFPS2018) based on the target population.

Firstly, I analyzed data in general.


### Gender
In this part, first of all, I processed gender data of the Census 7th data and the CFPS2018 data.
```{r}
## Process the gender data of census 7
Census7_gender <- df_census7 %>%
  dplyr::select(c(6,7)) %>%        
  dplyr::slice(c(6)) %>%
  dplyr::rename(Male=1, 
                Female=2) %>%
  dplyr::mutate(Data_source = "Census7") %>%
  tidyr::pivot_longer(c(Male, Female), 
                      names_to = "Gender",
                      values_to = "Proportion") %>%
  dplyr::mutate(Proportion = round(as.numeric(Proportion), 0))

## Process the gender data of CFPS2018
CFPS2018_gender <- df_CFPS2018 %>%
  dplyr::rename(Gender = QA002) %>%
  dplyr::count(Gender) %>%
  dplyr::filter(!is.na(Gender)) %>%
  dplyr::mutate(Proportion = n / sum(n)*100,
                Data_source = "CFPS2018",
                Gender= ifelse(Gender == 1, "Male", "Female")) %>%
  dplyr::select(Data_source, Gender, Proportion)

sum(CFPS2018_gender$Proportion)
```


Secondly, I converted data format and combined three data sources.
```{r}
## Convert H1_gender data format
H1_gender_general2 <- H1_gender_general %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_source = "Chinese subjects") %>% 
  dplyr::ungroup()

sum(H1_gender_general2$Proportion)

H2_gender_general <- bind_rows(Census7_gender,CFPS2018_gender,H1_gender_general2)
```


And then, I combined all Chinese gender data and visualized them.
```{r}
H2_Fig_gender_general <- ggplot(H2_gender_general,aes(Data_source,Proportion,fill= Gender))+
  geom_col()+
  geom_hline(yintercept = 50, linetype = "dashed", color = "#666666")+
  labs(y="Proportion",x = "Data source")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))


H2_Fig_gender_general
```


Finally, I calculated the bayes factor for gender.
```{r}
## general population
H2_gender_bayes_general <- H2_gender_general %>% 
  dplyr::select(2,3,1) %>% 
  tidyr::pivot_wider(names_from = Data_source,values_from = Proportion)


H2_BF_gender_Census7_general <- BayesMultiNomial(dataset = H2_gender_bayes_general,
                                          factor = "Gender",
                                          observed = "Chinese subjects",
                                          expected = "Census7")


H2_BF_gender_CFPS2018_general <- BayesMultiNomial(dataset = H2_gender_bayes_general,
                                          factor = "Gender",
                                          observed = "Chinese subjects",
                                          expected = "CFPS2018")
```


The calculation results show that there is no significant difference between the data in Chinese subjects pool and Census7 and CFPS2018, and the calculation results are $Log(BF_{10})$ = `r H2_BF_gender_Census7_total$BF$LogBF10` and $Log(BF_{10})$ = `r H2_BF_gender_CFPS2018_total$BF$LogBF10` respectively.

for general population, I also found similar results. Census7: $Log(BF_{10})$ = `r H2_BF_gender_Census7_general$BF$LogBF10` , CFPS2018: $Log(BF_{10})$ = `r H2_BF_gender_CFPS2018_general$BF$LogBF10`


In this part, I calculate data based on special target population
I calculate preschool children.
```{r}
Journal_gender_preschool <- Journal_gender_Infants_toddlers_TP_IDs %>% 
  dplyr::summarise(Male_Num = sum(as.numeric(Male_Num)), ## 3825
                   Female_Num = sum(as.numeric(Female_Num))) ## 3590

H2_gender_preschool_special <- data.frame(Gender = c("Female","Male","Female","Male"),
                                          n = c(3825,3590,79,77),
                                          Data_source = c("Journal","Journal","Lucca","Lucca"))


## calculate Prop
H2_gender_preschool_special <- H2_gender_preschool_special %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n=sum(n)) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                 Data_source = "Chinese subjects")

sum(H2_gender_preschool_special$`Chinese subjects`)
sum(H2_gender_preschool_special$Census7)


## Census7th preschool (under 6 years old)
Census7_gender_preschool_special <- df_census7 %>% 
  dplyr::select(1,3,4) %>% 
  dplyr::slice(c(9:13,16:17)) %>% 
  dplyr::rename(Age = 1, Male = 2, Female = 3) %>% 
  dplyr::summarise(Male = sum(as.numeric(Male)),
                   Female = sum(as.numeric(Female))) %>% 
  pivot_longer(cols = c("Male","Female"),
               names_to = "Gender",
               values_to = "n") %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_source = "Census7")

sum(Census7_gender_preschool_special$Proportion)


## combine tow data 
H2_gender_preschool_special <- bind_rows(H2_gender_preschool_special,
                                         Census7_gender_preschool_special) %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_source, values_from = Proportion)
  


## bayes 
H2_BF_gender_preschool_Census <- BayesMultiNomial(dataset = H2_gender_preschool_special,
                                                factor = "Gender",
                                                observed = "Chinese subjects",
                                                expected = "Census7")
```


I calculate college
```{r}
Journal_college_TP_IDs <-  Journal_college_TP %>% 
  dplyr::pull(Article_IDs)

Journal_gender_college_sepcial <-  Journal %>% 
  dplyr::filter(Article_IDs_N %in% Journal_college_TP_IDs) %>% 
  dplyr::select(Article_IDs_N,Article_Title,Study_Number,Subjects_Group_N,
                Gender,Male_Num,Female_Num,Sample_Size,
                Sample_Type_N) %>% 
  dplyr::filter(Gender == 1) %>% 
  dplyr::mutate(Male_Num = as.numeric(Male_Num),
                Sample_Size = as.numeric(Sample_Size),
                Female_Num = as.numeric(Female_Num),
                Male_Num = ifelse(Male_Num < 1 & Female_Num < 1,
                                  round(Male_Num * Sample_Size),Male_Num),
                Female_Num = ifelse(Female_Num < 1 & Female_Num > 0,
                                    Sample_Size - Male_Num,Female_Num))


Journal_gender_college_sepcial2 <- Journal_gender_college_sepcial %>% 
  dplyr::summarise(Male =sum(Male_Num),
                   Female = sum(Female_Num)) %>% 
  tidyr::pivot_longer(cols = c("Male","Female"),
                      names_to = "Gender",
                      values_to = "n") %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) ## Male 44.84 / Female 55.16

sum(Journal_gender_college_sepcial2$Proportion)


## The total data we compared is from *the Outline for Women's Development in China (2021-2030)* released by the National Bureau of Statistics of China in 2022.

H2_gender_college_bayes_special <- data.frame(Gender = c("Male","Female"),
                                              Journal = c(44.84,55.16),
                                              Outline_Women = c(50,50))

H2_BF_gender_college_special <- BayesMultiNomial(dataset = H2_gender_college_bayes_special,
                                                 factor = "Gender",
                                                 observed = "Journal",
                                                 expected = "Outline_Women")
```

In terms of gender, for the special target population of college students, we have found that there is no difference between Journal and the overall data of China (the Outline for Women's Development in China (2021-2030)),  $Log(BF_{10})$ = `r H2_BF_gender_special_college$BF$LogBF10`.



### Age
Similarly, for age data, I first processed the Census data and the CFPS2018 data.
```{r}
## Process age data of the census 6
Census6_age_five5 <- df_census6 %>% 
  dplyr::filter(row_number() %% 6 == 0) %>%
  dplyr::select(1,2,5) %>% 
  dplyr::rename(ageBins = 1, Proportion = 3) %>% 
  dplyr::mutate(Proportion = as.numeric(Proportion)) %>% 
  dplyr::mutate(ageBins = str_remove(ageBins, "岁")) %>%
  dplyr::mutate(ageBins = str_replace_all(ageBins, "-", "~")) %>%
  dplyr::slice(-21) 

Census6_age_five5$ageBins[20] <- ">=95"

Census6_age_five5 <- Census6_age_five5 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(Proportion = sum(Proportion)) %>% 
  dplyr::mutate(Data_Source = "Census6") %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(ageBins) %>% 
  dplyr::mutate(ageBins = factor(ageBins, 
                                 levels =c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
  
## Process age data of the census 7 
Census7_age_five5 <- df_census7 %>%
  dplyr::rename(ageBins = 1,Proportion = 5) %>% 
  dplyr::filter(str_detect(ageBins,"岁")) %>%
  dplyr::select(1,2,5) %>% 
  dplyr::mutate(Proportion = as.numeric(Proportion)) %>% 
  dplyr::mutate(ageBins = str_remove(ageBins, "岁")) %>%
  dplyr::mutate(ageBins = str_replace_all(ageBins, "-", "~")) %>% 
  dplyr::slice(-21)

Census7_age_five5$ageBins[20] <- ">=95" 
Census7_age_five5$Proportion[20] <- 0.06+0.01


Census7_age_five5 <- Census7_age_five5 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(Proportion = sum(Proportion)) %>% 
  dplyr::mutate(Data_Source = "Census7") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins = factor(ageBins, 
                                 levels =c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
```


Then, I convert the data format of H1_age.
```{r}
## general
H2_age_general <- H1_age_general %>%
  dplyr::select(1:2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) %>% 
  dplyr::ungroup()

sum(H2_age_general$Proportion)
```


Finally, I visualized all Chinese age data and combined figure of gender and age.
general population
```{r}
H2_Fig_age_general <- ggplot(data= Census7_age_five5, 
       aes(x=ageBins, y = Proportion, fill="Census7")) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = H2_age_general, aes(x=ageBins, 
                y = Proportion,group = 1,color = "Chinese subjects"),size =1)+
  scale_fill_manual(values=c("Census7"="#00BFC4")) +  
  scale_color_manual(values=c("Chinese subjects" = "red")) +
  scale_y_continuous(limits = c(0,45))+
  coord_flip() +
  labs(y="Proportion", x = "Age bins")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))


H2_Fig_age_general
```


In addition, I calculated the bayes factor.
```{r}
# Firstly, I process Census data for the following analysis.
## process census data.
Census7_age <- df_census7 %>%
  dplyr::rename(ageBins = 1, n = 2, Proportion = 5) %>% 
  dplyr::slice(9:145) %>% 
  dplyr::filter(ageBins != "" & !grepl("岁",ageBins)) %>% 
  dplyr::select(1:2,5) %>% 
  dplyr::mutate_at(vars(1:3),as.numeric)

## PsyStages
Census7_age_PsyStages <- Census7_age %>% 
  dplyr::mutate(ageBins = cut(ageBins,
                                breaks = c(-Inf, 17.5, 25.5, 40.5, 60.5, Inf),
                                labels = c("<=17","18~25","26~40", "41~60", ">=61"),
                                levels = c("<=17","18~25","26~40", "41~60", ">=61"))) %>% 
  dplyr::mutate(n  = ifelse(ageBins == ">61", n+118866,n)) %>% 
  dplyr::select(-Proportion) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>%
  dplyr::mutate(Proportion = n/sum(n)*100) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Data_Source = "Census7")

sum(Census7_age_PsyStages$Proportion)


## interval10
Census7_age_interval10 <- Census7_age %>% 
  dplyr::mutate(ageBins = cut(ageBins,
                              breaks = c(-Inf, 10.5, 20.5, 30.5, 40.5, 50.5, 60.5, Inf),
                              labels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"),
                              levels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"))) %>% 
  dplyr::mutate(n  = ifelse(ageBins == ">61", n+118866,n)) %>% 
  dplyr::select(-Proportion) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>%
  dplyr::mutate(Proportion = n/sum(n)*100) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Data_Source = "Census7")

sum(Census7_age_PsyStages$Proportion)


## For target population, I need combine two source data firstly.
## PsySatges
Sim_Journal_age_PsyStages3_general_prop <- Sim_Journal_age_PsyStages3_general %>% 
  dplyr::rename(n =2)


H2_age_Psystages_bayes_general <- bind_rows(BTS_age_PsyStages_CHN_general,Sim_Journal_age_PsyStages3_general_prop) %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "Chinese subjects") %>% 
  dplyr::add_row(Census7_age_PsyStages) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion)

sum(H2_age_Psystages_bayes_general$`Chinese subjects`) 


## interval10
Sim_Journal_age_interval103_general_prop <-  Sim_Journal_age_interval103_general %>% 
  dplyr::rename(n = 2)

H2_age_inteval10_bayes_general <- bind_rows(BTS_age_interval10_CHN_general,Sim_Journal_age_interval103_general_prop) %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Data_Source = "Chinese subjects") %>% 
  dplyr::add_row(Census7_age_interval10) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion)

sum(H2_age_inteval10_bayes_general$`Chinese subjects`) 


## calculate bayes factor
H2_BF_age_Psystages_general <- BayesMultiNomial(dataset = H2_age_Psystages_bayes_general,
                              factor = "ageBins",
                              observed = "Chinese subjects",
                              expected = "Census7")


H2_BF_age_interval10_general <- BayesMultiNomial(dataset = H2_age_inteval10_bayes_general,
                              factor = "ageBins",
                              observed = "Chinese subjects",
                              expected = "Census7")
```


For age of H2, firstly, in general population, I found the Bayesian multinomial test shows strong evidence for comparing them in general population. PsyStages and interval10 are $Log(BF_{10})$ = `r H2_BF_age_Psystages_general$BF$LogBF10` and interval10: $Log(BF_{10})$ = `r H2_BF_age_interval10_general$BF$LogBF10` respectively.



### Educational attainment
Load and process the edu data of census 7th
```{r}
Census7_edu <- readxl::read_xls("A0401.xls")

Census7_edu_adults <- Census7_edu %>% 
  dplyr::slice(c(3,4,29,30,32,39,46,53,60,67,74,81,88,95,102,109,116,123)) %>% 
  dplyr::select(1,2,5,8,11,14,17,20,23,26,29) %>% 
  dplyr::rename(Age = 1,Three_years_old_above = 2, Never_attended_school = 3,
                Preschool_education = 4,Primary_school = 5,Middle_school = 6,
                High_school = 7, Junior_college = 8, Undergraduate_education = 9,
                Postgraduate_student = 10,Doctoral_student = 11) %>% 
  dplyr::slice(-c(1:2)) %>% 
  dplyr::mutate(across(-1,as.numeric)) 


Census7_college <- Census7_edu_adults %>% 
  dplyr::summarise(`Below college` = sum(across(3:7)),
                   `College and above` = sum(across(8:11))) %>% 
  tidyr::pivot_longer(cols = c(1,2),
                      names_to = "Educational_attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "Census7")

sum(Census7_college$Proportion)


Census7_high_school <- Census7_edu_adults %>% 
  dplyr::summarise(`Below high school` = sum(across(3:6)),
                   `High school and above` = sum(across(7:11))) %>% 
  tidyr::pivot_longer(cols = c(1,2),
                      names_to = "Educational_attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "Census7")

sum(Census7_high_school$Proportion)
```


receive edu data of CFPS2018
```{r}
CFPS2018_edu <- df_CFPS2018 %>% 
  dplyr::filter(W01 > -1) %>% 
  dplyr::group_by(W01) %>% 
  dplyr::summarise(Num = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(W01 = as.character(W01)) %>% 
  dplyr::mutate(W01 = case_when(W01 == 0 ~ "Illiterate/Semi - illiterate",
                                W01 == 3 ~ "Primary school",
                                W01 == 4 ~ "high school",
                                W01 == 5 ~ "Senior high school/Secondary vocational school/Technical school/Vocational high school",
                                W01 == 6 ~ "Junior college",
                                W01 == 7 ~ "Undergraduate_education",
                                W01 == 8 ~ "Postgraduate_student",
                                W01 == 9 ~ "Doctoral_student",
                                W01 == 10 ~ "Never attended school",
                                TRUE ~ W01))


CFPS2018_edu_college <- data.frame(Educational_attainment = c("Below college","College and above"),
                                   Num = c(2846+756+3598+5273,3058+1648+1335+112+7)) %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "CFPS2018")

sum(CFPS2018_edu_college$Proportion) 


CFPS2018_edu_high_school <- data.frame(Educational_attainment = c("Below high school","High school and above"),
                                   Num = c(2846+756+3598+5273+3058,1648+1335+112+7)) %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "CFPS2018")


sum(CFPS2018_edu_high_school$Proportion) 
```


Combine multiple edu data
```{r}
## College
Chinese_subjects_pools_edu_college <- H1_edu_college %>%
  dplyr::select(-3) %>%
  dplyr::group_by(Educational_attainment) %>%
  dplyr::summarise(Num = sum(Num)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "Chinese subjects")

sum(Chinese_subjects_pools_edu_college$Proportion)


H2_edu_college <- bind_rows(Chinese_subjects_pools_edu_college,Census7_college,CFPS2018_edu_college)


## highschool
Chinese_subjects_pools_edu_highschool <- H1_edu_highschool %>% 
  dplyr::select(-3) %>% 
  dplyr::group_by(Educational_attainment) %>% 
  dplyr::summarise(Num = sum(Num)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100,
                Data_source = "Chinese subjects")

sum(Chinese_subjects_pools_edu_highschool$Proportion)


H2_edu_highschool <- bind_rows(Chinese_subjects_pools_edu_highschool,Census7_high_school,CFPS2018_edu_high_school)  %>%
  dplyr::mutate(Data_source = factor(Data_source,
                                     levels = c("Census7","CFPS2018","Chinese subjects")))
```


And visualization
```{r}
## college
H2_Fig_college <- ggplot(data = H2_edu_college,aes(Data_source,Proportion,fill = Educational_attainment))+
  geom_col()+
  xlab("Data source")+
  theme_classic()+ 
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title= element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"),
        strip.text = element_text(size = 16,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black"))

H2_Fig_college


## high school
H2_Fig_highschool <- ggplot(data = H2_edu_highschool,aes(Data_source,Proportion,fill = Educational_attainment))+
  geom_col()+
  theme_classic()+ 
  ylab("")+
  xlab("Data source")+
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 16, family = "serif"), 
        legend.title = element_blank(),
        axis.title= element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"),
        strip.text = element_text(size = 16,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black"))

H2_Fig_highschool


## combine Fig

H2_Fig_gender_age_edu_general <- H2_Fig_gender_general + H2_Fig_age_general +H2_Fig_college + H2_Fig_highschool +
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')

ggsave("H2_Fig_gender_age_edu_general.pdf",H2_Fig_gender_age_edu_general, device = "pdf", width=18, height = 18)

H2_Fig_gender_age_edu_general
```


Calculate the BF of edu
```{r}
## college
H2_edu_college_bayes <- H2_edu_college %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_source, values_from = Proportion)

H2_BF_edu_college_Census7 <- BayesMultiNomial(dataset = H2_edu_college_bayes,
                                          factor = "Educational_attainment",
                                          observed = "Chinese subjects",
                                          expected = "Census7")


H2_BF_edu_college_CFPS2018 <- BayesMultiNomial(dataset = H2_edu_college_bayes,
                                          factor = "Educational_attainment",
                                          observed = "Chinese subjects",
                                          expected = "CFPS2018")



## high school
H2_edu_highschool_bayes <- H2_edu_highschool %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_source, values_from = Proportion)

H2_BF_edu_highschool_Census7 <- BayesMultiNomial(dataset = H2_edu_highschool_bayes,
                                          factor = "Educational_attainment",
                                          observed = "Chinese subjects",
                                          expected = "Census7")


H2_BF_edu_highschool_CFPS2018 <- BayesMultiNomial(dataset = H2_edu_highschool_bayes,
                                          factor = "Educational_attainment",
                                          observed = "Chinese subjects",
                                          expected = "CFPS2018")

```
I found the Bayesian multinomial test shows strong evidence for comparing them in general population. PsyStages and interval10 are $Log(BF_{10})$ = `r H2_BF_age_Psystages_general$BF$LogBF10` and interval10: $Log(BF_{10})$ = `r H2_BF_age_interval10_general$BF$LogBF10` respectively.


Note, there is not results description.


Save the data so that I can compare the data from large-scale international cooperation projects and Chinese journals respectively with the census data and data from CFPS.
```{r}
save(H1_age_general,H1_PsyStages_bayes_general,H1_interval10_bayes_general,
     H1_edu_college_bayes,H1_edu_highschool_bayes,
     H2_edu_college_bayes,H2_edu_highschool_bayes,
     Census7_age_five5,Census7_age_interval10,Census7_age_PsyStages,
     Census7_high_school,Census7_college,CFPS2018_edu_high_school,CFPS2018_edu_college,
     file = "H2_BTS_Journal_age_edu.RData")
```


### Region
As stated in RR stage1, I tried to analysis region data. As a first step, I processed Subjects_Recruitment_Area data from Chinese journals.


Create a vector of China's four economic regions, with data sourced from the National Bureau of Statistics of China. The four regions are Central, Eastern, Western, and Northeastern.
```{r}
Central_China4 <- c("山西","安徽","江西","河南","湖北","湖南")

East_China4 <- c("北京","天津","河北","上海","江苏","浙江","福建","山东","广东","海南")

West_China4 <- c("内蒙古","广西","重庆","四川","贵州","云南","西藏","陕西","甘肃","青海","宁夏","新疆")

Northeast_China4 <- c("辽宁","吉林","黑龙江")

China_region_four <- tibble(Region = c(Central_China4, East_China4, 
                                        West_China4, Northeast_China4),
                             Region_four = c(rep("Central China", 6), rep("East China", 10),
                                        rep("West China", 12),rep("Northeast China", 3)))
```


We also create a vector of China's seven regions.
```{r}
China_region_seven <-  tibble(
  Region = c("北京", "天津", "河北", "山西", "内蒙古",
              "上海", "江苏", "浙江", "安徽", "福建", "江西", "山东",
              "河南", "湖北", "湖南",
              "广东", "广西", "海南",
              "重庆", "四川", "贵州", "云南", "西藏",
              "陕西", "甘肃", "青海", "宁夏", "新疆",
              "辽宁", "吉林", "黑龙江"),
  Region_seven = c(rep("North China", 5), 
             rep("East China", 7),
             rep("Central China", 3),
             rep("South China", 3),
             rep("Southwest China", 5),
             rep("Northwest China", 5),
             rep("Northeast China", 3)))
```

Create a vector of all China' province
```{r}
China_province <- c("新疆","西藏","甘肃","青海","内蒙古",
                    "宁夏","四川","重庆","陕西","贵州","云南",
                    "北京","山西","河北","河南","湖北","湖南",
                    "广西","广东","香港","澳门","台湾","海南",
                    "黑龙江","吉林","辽宁","天津","山东","江苏",
                    "安徽","上海","浙江","江西","福建")
```


The data is processed when the target population is the general population.

single region
```{r}

Journal_region_single <- Journal %>% 
   dplyr::select(3,5,7,37,40,16,30) %>% 
   dplyr::mutate(Subjects_Recruitment_Area = gsub("[;；、，,]",";",Subjects_Recruitment_Area),
                 Sample_Size = as.numeric(Sample_Size)) %>% 
   dplyr::filter(Subjects_Recruitment_Area != "0" & !grepl(";",Subjects_Recruitment_Area)) 
 
 
# Journal_major_region_single <- Journal_region_single %>% 
#   dplyr::filter(!Subjects_Recruitment_Area %in% China_province)

# table(Journal_major_region_single$Subjects_Recruitment_Area)

 # sum(Journal_region_single$Sample_Size,na.rm = TRUE)+33
 # 
 # table(Journal_region_single$Subjects_Recruitment_Area)
 
 
 ## calculate the number of articles and studies that include provincial administrative regions 
 ## studies
 # Journal_region_single_studies_num <- Journal_region_single %>% 
 #   dplyr::distinct(Article_IDs,Study_Number)  ## single 592 studies + multiple 10
 # 
 ## papers
 Journal_region_single_papers_num <- Journal_region_single %>%
   dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
   dplyr::distinct(Article_IDs) ## single 521 papers + multiple 11
 
 table(Journal_region_single_papers_num$Subjects_Recruitment_Area)
 
 
 
 Journal_region_single_general_tab <- Journal_region_single %>% 
   dplyr::select(Article_IDs,Target_Population_N,Sample_Size,Subjects_Recruitment_Area) %>%
   dplyr::filter(Target_Population_N != 1) %>% 
   dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == "内蒙古自治区", "内蒙古",Subjects_Recruitment_Area),
                 Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == "广州","广东",Subjects_Recruitment_Area)) %>% 
   dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
   dplyr::group_by(Subjects_Recruitment_Area) %>% 
   dplyr::summarise(n = sum(Sample_Size))
```


multiple regions
```{r}
# Journal_region_multiple <- Journal %>% 
#    dplyr::select(3,5,7,37,40,16,30) %>% 
#    dplyr::mutate(Subjects_Recruitment_Area = gsub("[;；、，,]",";",Subjects_Recruitment_Area)) %>% 
#    dplyr::filter(Subjects_Recruitment_Area != "0" & grepl(";",Subjects_Recruitment_Area)) 
 
 # writexl::write_xlsx(Journal_region_multiple,"Journal_region_multiple.xlsx")
 
 ## re-input data and load data
 Journal_region_multiple <- readxl::read_xlsx("Journal_region_multiple.xlsx") %>% 
   dplyr::filter(True_Value != "No specific value") 



Journal_region_multiple_general_tab <-   Journal_region_multiple %>% 
  dplyr::select(Article_IDs, Target_Population_N,True_Value) %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  tidyr::separate_rows(True_Value,sep = ";") %>% 
  tidyr::separate(True_Value,c("Subjects_Recruitment_Area","Sample_Size"),sep = ":") %>% 
   dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
  dplyr::mutate(Sample_Size  = as.numeric(Sample_Size),
                Sample_Size = ifelse(Article_IDs == "20213104",ceiling(Sample_Size*2500),Sample_Size)) %>% 
  dplyr::select(Sample_Size,Subjects_Recruitment_Area) %>% 
  dplyr::rename(n = Sample_Size)

```


combine two data
```{r}
Journal_region_general_tab <-bind_rows(Journal_region_single_general_tab,
                                       Journal_region_multiple_general_tab) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(n = sum(n),.groups = "drop") %>% 
  dplyr::mutate(Proportion = n/sum(n)*100)

sum(Journal_region_general_tab$Proportion)


Journal_region_general_tab2 <- Journal_region_general_tab %>% 
  dplyr::mutate(Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal_region_general_population")%>% 
  dplyr::rename(Region = 1)

sum(Journal_region_general_tab2$n) #44029
```


convert Journal data into four regions and seven regions
```{r}
## four regions
Journal_region_four <- merge(Journal_region_general_tab2,China_region_four,
                              by = "Region") %>% 
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(Journal_n=sum(n)) 


## seven regions
Journal_region_seven <- merge(Journal_region_general_tab2,China_region_seven,
                               by = "Region")%>% 
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(Journal_n=sum(n)) 
```


The second step, I processed of provincial distribution of population for census7.
```{r message=FALSE, warning=FALSE, include=FALSE}
Census7_region <- readxl::read_xls("A0101.xls") %>% 
  dplyr::select(1,5) %>% 
  dplyr::rename(Region = 1, n = 2) %>% 
  dplyr::filter(!is.na(Region)) %>% 
  dplyr::slice(-c(1:2)) %>% 
  dplyr::mutate(n = as.numeric(n))


Census7_3 <- data.frame(Region = c("台湾","香港","澳门"),n =c(23561236,7474200,683218))


Census7_region <- rbind(Census7_region,Census7_3) %>% 
  dplyr::mutate(Proportion = round(n / sum(n)*100,4)) %>% 
  dplyr::mutate(Count_Bins = cut(Proportion,
                                      breaks = c(-Inf,1,5,10,Inf),
                                      labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Census7")


Census7_region$Region <- gsub(" ", "", Census7_region$Region)  

sum(Census7_region$n) #1,441,497,378
sum(Census7_region$Proportion) ## 100

```


convert Census7 data into four regions and seven regions
```{r}
## four regions
Census7_region_four <- merge(Census7_region,China_region_four,by = "Region") %>%
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(Census7_n=sum(n))


## seven regions
Census7_region_seven <- merge(Census7_region,China_region_seven,by= "Region") %>% 
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(Census7_n=sum(n)) 
```


The third step, I processed of provincial distribution of population for CFPS2018.
```{r}
## process CFPS2018 province data
CFPS2018_region <- data.frame(table(df_CFPS2018$PROVCD18)) %>% 
  dplyr::rename(Region = 1,n=2) %>% 
  dplyr::mutate(Region = c("北京","天津","河北","山西","内蒙古","辽宁","吉林",
                             "黑龙江","上海","江苏","浙江","安徽","福建","江西",
                             "山东","河南","湖北","湖南","广东","广西","海南",
                             "重庆","四川","贵州","云南","西藏","陕西","甘肃",
                             "青海","宁夏","新疆")) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Count_Bins = cut(Proportion,
                                      breaks = c(-Inf,1,5,10,Inf),
                                      labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "CFPS2018")

sum(CFPS2018_region$Proportion) 

```


Convert CFPS2018 into four regions and seven regions
```{r}
## four regions
CFPS2018_region_four <- merge(CFPS2018_region,China_region_four,by = "Region") %>%
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(CFPS2018_n=sum(n)) 


## seven regions
CFPS2018_region_seven <- merge(CFPS2018_region,China_region_seven,by = "Region") %>% 
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(CFPS2018_n=sum(n))
```


Visualize four region
```{r}
H2_region_four <- full_join(Journal_region_four,Census7_region_four,
                            by = "Region_four") %>% 
  dplyr::full_join(CFPS2018_region_four,by = "Region_four") %>% 
  dplyr::mutate(Journal_Prop = Journal_n / sum(Journal_n)*100,
                   Census7_Prop = Census7_n / sum(Census7_n)*100,
                   CFPS2018_Prop = CFPS2018_n /sum(CFPS2018_n)*100) %>% 
  dplyr::select(1,5:7)


H2_region_four2 <- H2_region_four %>% 
  pivot_longer(cols = -Region_four,
             names_to = "Data Source",
             values_to = "Proportion") %>% 
  dplyr::mutate(Region_four = factor(Region_four,
                                     levels = c("East China","Central China",
                                                "West China","Northeast China")))
                # Data_source = factor(Data_source,
                #                      levels = c("Journal","Census7","CFPS2018")))


## Visualization
H2_Fig_region_four <- ggplot(data = H2_region_four2, aes(x = `Data Source`, y = Proportion, fill = Region_four)) +
  geom_col(position = "stack")+
  labs(fill = "Region")+
  scale_x_discrete(labels =c("Journal_Prop" = "Journal",
                              "CFPS2018_Prop" = "CFPS2018",
                              "Census7_Prop" = "Census7"))+
  theme_classic()+
  theme(legend.box.spacing = unit(2,"pt"),
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 15, family = "serif"),
        legend.title = element_text(size = 15, family = "serif"),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  guides(fill = guide_legend(ncol = 2))
                             # title.position = "top",
                             # label.position = "bottom"))


# ggsave("H2_Fig_region_four.pdf",H2_Fig_region_four, device = "pdf", width= 12, height = 9)

H2_Fig_region_four
```


Visualize seven region
```{r}
H2_region_seven <- full_join(Journal_region_seven,Census7_region_seven,
                             by = "Region_seven") %>% 
  dplyr::full_join(CFPS2018_region_seven,by = "Region_seven") %>% 
  dplyr::mutate(Journal_Prop = Journal_n / sum(Journal_n)*100,
                   Census7_Prop = Census7_n / sum(Census7_n)*100,
                   CFPS2018_Prop = CFPS2018_n /sum(CFPS2018_n)*100) %>% 
  dplyr::select(1,5:7)


H2_region_seven2 <- H2_region_seven %>% 
  pivot_longer(cols = -Region_seven,
             names_to = "Data Source",
             values_to = "Proportion") %>% 
  dplyr::mutate(Region_seven = factor(Region_seven,
                                     levels = c("East China","Central China",
                                                "North China","South China",
                                                "Southwest China","Northwest China",
                                                "Northeast China")))
                # Data_source = factor(Data_source,
                #                      levels = c("Journal","Census7","CFPS2018")))
levels(H2_region_seven2$Region_seven)

## Visualization
H2_Fig_region_seven <- ggplot(data = H2_region_seven2, aes(x = `Data Source`, y = Proportion, fill = Region_seven)) +
  geom_col(position = "stack")+
  labs(fill = "Region")+
  scale_x_discrete(labels =c("Journal_Prop" = "Journal",
                              "CFPS2018_Prop" = "CFPS2018",
                              "Census7_Prop" = "Census7"))+
  theme_classic()+
  theme(legend.box.spacing = unit(2,"pt"),
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 15, family = "serif"),
        legend.title = element_text(size = 15, family = "serif"),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  guides(fill = guide_legend(ncol = 3))
                             # title.position = "top",
                             # label.position = "bottom"))


H2_Fig_region_seven


H2_Fig_major_region <- H2_Fig_region_four + H2_Fig_region_seven +
plot_annotation(tag_levels = 'A',
                  theme = theme(plot.title = element_text(size = 24))) + 
  theme(plot.tag = element_text(size = 20))

H2_Fig_major_region

ggsave("H2_Fig_major_region.pdf",H2_Fig_major_region, device = "pdf", width= 15, height = 9)

```


And then, I will visualize the map for the region data of Chinese subjects
Combine all region data and load color data
```{r}
## combine region data
Region_map_data <-  bind_rows(Census7_region,CFPS2018_region,
                              Journal_region_general_tab2)

## load color data
Region_map_color <- readxl::read_xlsx("colour.xlsx") %>% 
  dplyr::mutate(QUHUADAIMA = as.character(QUHUADAIMA)) %>% 
  dplyr::rename(Region = 1) %>% 
  dplyr::select(-2)

## combine color data and region data
Region_data <- dplyr::left_join(Region_map_data,Region_map_color,by = join_by(Region)) %>% 
  dplyr::mutate(QUHUADAIMA = ifelse(Region == "重庆", "500000", QUHUADAIMA),
                Color = ifelse(Count_Bins == "<1",1,
                               ifelse(Count_Bins == "1~5",2,
                                      ifelse(Count_Bins == "5~10",3,4))),
                Color = factor(Color, levels = c("1", "2", "3", "4"))) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = c(Proportion, Count_Bins,n,Color)) %>% 
  dplyr::mutate(across(3:ncol(.),~ifelse(is.na(.),0,.)))
```


Finally, I visualized geographic distribution and calculated Bayesian multinomial test for region.
```{r}
API_pre <-  "http://xzqh.mca.gov.cn/data/"
## 读取全国数据
China <-  st_read(dsn = paste0(API_pre, "quanguo.json"), stringsAsFactors=FALSE) 
## 使用 4326 地理坐标系
st_crs(China) <-  4326

# 读取国界线数据
China_line <-  st_read(dsn = paste0(API_pre, "quanguo_Line.geojson"), stringsAsFactors=FALSE) 
st_crs(China_line) <-  4326
## 选择区划代码为国界线的区域
gjx <- China_line[China_line$QUHUADAIMA == "guojiexian",]

China <- dplyr::left_join(China,Region_data,by= "QUHUADAIMA")



## Chinese journal papers in general population
H2_Fig_region_general <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_region_general_population))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())


## CFPS2018
H2_Fig_CFPS2018_region <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_CFPS2018))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "CFPS2018") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.title = element_blank(),
        legend.position = c(0.2, 0.2),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())


## Census7
H2_Fig_Census7_region <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Census7))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Census7") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering(),
                         height = unit(0.8, "cm"),
                         width = unit(0.6, "cm") )



H2_Fig_region <- H2_Fig_Census7_region  + H2_Fig_region_general + H2_Fig_CFPS2018_region +
  plot_layout(ncol = 1, nrow = 3, heights = c(4,4))+
  plot_annotation(tag_levels = 'A',
                  theme = theme(plot.title = element_text(size = 24))) + 
  theme(plot.tag = element_text(size = 20))


ggsave("H2_Fig_region .pdf", H2_Fig_region , device = "pdf", width=10, height = 15)

H2_Fig_region 
```

BF four region
```{r}
Journal_region_four <- Journal_region_four %>% 
  dplyr::rename(n = 2) %>% 
  dplyr::mutate(Data_source = "Journal")

Census7_region_four <- Census7_region_four %>% 
  dplyr::rename(n = 2)%>% 
  dplyr::mutate(Data_source = "Census7")

CFPS2018_region_four <- CFPS2018_region_four %>% 
  dplyr::rename(n = 2)%>% 
  dplyr::mutate(Data_source = "CFPS2018")


H2_region_four_bayes <- bind_rows(Journal_region_four,
                                  Census7_region_four,
                                  CFPS2018_region_four) %>%
  tidyr::pivot_wider(id_cols = Region_four,
                     names_from = Data_source, 
                     values_from = n) %>% 
  dplyr::mutate(Journal = Journal/sum(Journal)*100,
                Census7 = Census7/sum(Census7)*100,
                CFPS2018 = CFPS2018/sum(CFPS2018)*100) %>%  
  dplyr::mutate(across(everything(),~ifelse(is.na(.),1,.)))


## BF
H2_BF_Journal_Census7_region_four <- BayesMultiNomial(dataset = H2_region_four_bayes,
                                          factor = "Region_four",
                                          observed = "Journal",
                                          expected = "Census7")

H2_BF_Journal_CFPS2018_region_four <- BayesMultiNomial(dataset = H2_region_four_bayes,
                                          factor = "Region_four",
                                          observed = "Journal",
                                          expected = "CFPS2018")
```


BF seven region
```{r}
Journal_region_seven <- Journal_region_seven %>% 
  dplyr::rename(n = 2) %>% 
  dplyr::mutate(Data_source = "Journal")

Census7_region_seven <- Census7_region_seven %>% 
  dplyr::rename(n = 2)%>% 
  dplyr::mutate(Data_source = "Census7")

CFPS2018_region_seven <- CFPS2018_region_seven %>% 
  dplyr::rename(n = 2)%>% 
  dplyr::mutate(Data_source = "CFPS2018")


H2_region_seven_bayes <- bind_rows(Journal_region_seven,
                                  Census7_region_seven,
                                  CFPS2018_region_seven) %>%
  tidyr::pivot_wider(id_cols = Region_seven,
                     names_from = Data_source, 
                     values_from = n) %>% 
  dplyr::mutate(Journal = Journal/sum(Journal)*100,
                Census7 = Census7/sum(Census7)*100,
                CFPS2018 = CFPS2018/sum(CFPS2018)*100) %>%  
  dplyr::mutate(across(everything(),~ifelse(is.na(.),1,.)))


## BF
H2_BF_Journal_Census7_region_seven <- BayesMultiNomial(dataset = H2_region_seven_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal",
                                          expected = "Census7")

H2_BF_Journal_CFPS2018_region_seven <- BayesMultiNomial(dataset = H2_region_seven_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal",
                                          expected = "CFPS2018")
```



## Test the 3st hypothesis
### Gender


As with the first two hypotheses, I dealt with gender data first.
```{r}
# H3_BTS_gender_list <- BTS_gender_list[-c(19)]
BTS_gender_allcountry <- lapply(BTS_gender_list, function(df){
  
  df %>% 
    dplyr::select(ISO3,Data_Source,Gender) 
  
})

BTS_gender_allcountry <- do.call(rbind, BTS_gender_allcountry) 

## Filter n > 30
BTS_gender_allcountry_filter <- BTS_gender_allcountry %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::filter(n > 30) %>% 
  dplyr::pull(ISO3)


BTS_gender_allcountry <- BTS_gender_allcountry %>% 
  dplyr::filter(ISO3 %in% BTS_gender_allcountry_filter) %>% 
  dplyr::group_by(ISO3,Gender) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Data_Source = "BTS")

## Add journal gender data
BTS_gender_allcountry <- BTS_gender_allcountry %>% 
  dplyr::mutate(n = ifelse(ISO3 == "CHN" & Gender == "Male", 247188+13811,n),
                n = ifelse(ISO3 == "CHN" & Gender == "Female", 286648 + 14171,n))

BTS_gender_allcountry_prop <- BTS_gender_allcountry %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) %>%
  dplyr::ungroup()




BTS_gender_allcountry_sum_prop <- BTS_gender_allcountry_prop %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::mutate(sum = sum(Proportion)) %>% 
  dplyr::ungroup()


## Set factor levels according to gender proportion
BTS_gender_allcountry_factor <- BTS_gender_allcountry_prop %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)


## combine WEIRD data to visualization
WEIRD_gender <- WEIRD %>% 
  dplyr::filter(!is.na(iso3c)) %>% 
  dplyr::filter(iso3c %in% BTS_gender_allcountry_factor)


H3_gender <- BTS_gender_allcountry_prop %>% 
  dplyr::left_join(WEIRD_gender,by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>% 
  dplyr::mutate(ISO3 = factor(ISO3,levels = BTS_gender_allcountry_factor)) %>% 
  dplyr::filter(!is.na(ISO3))
```

and I visualized gender data.

```{r}
H3_Fig_gender <- ggplot(H3_gender, aes(x=Proportion, y=ISO3,fill=Gender)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("Female","Male")) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free")


H3_Fig_gender


# SLO From Psychological_Science_Accelerator_Self_Determination_Theory_Collaboration_2022
# BRG  and SRP from Ruggeri_et_al_2022

# bts1 <- BTS[[23]]

## How many countries more than China
H3_gender_more_China <- H3_gender %>% 
  dplyr::filter(Gender == "Female") %>%  ## the prop female of China is 53.54
  dplyr::filter(Proportion > 53.54)
```


Secondly, I processed age data. Similarity, I processed age data in two classification. The one is PsyStages.
```{r}
## filter > 30
BTS_Psystages_allcountry_filter <-  BTS_age_PsyStages %>% 
  dplyr::filter(Article_Id != "Lucca_et_al_2024") %>%  ## filter target population is a and 3
  dplyr::group_by(ISO3) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::filter(n > 30) %>% 
  dplyr::ungroup() %>% 
  dplyr::pull(ISO3)


BTS_Psystages_allcountry <- BTS_age_PsyStages %>% 
  dplyr::filter(ISO3 %in% BTS_Psystages_allcountry_filter) %>% 
  dplyr::filter(ISO3 != "CHN") %>% ## drop Chinese data
  dplyr::group_by(ISO3,ageBins) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) %>% 
  dplyr::ungroup()


## calculate total sum
BTS_Psystages_allcountry_sum_prop <- BTS_Psystages_allcountry %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::summarise(sum = sum(Proportion)) %>% 
  dplyr::ungroup()


## Add Chinese data
Journal_BTS_PsyStages_CHN <- H2_age_Psystages_bayes_general %>% 
  dplyr::mutate(ISO3 = "CHN") %>% 
  dplyr::rename(Proportion = `Chinese subjects`)

sum(Journal_BTS_PsyStages_CHN$Proportion)


## Combine data
H3_PsyStages <- dplyr::bind_rows(BTS_Psystages_allcountry,Journal_BTS_PsyStages_CHN)

# table(H3_PsyStages$ageBins)

## Set factor
H3_PsyStages_factor <- H3_PsyStages %>% 
  dplyr::filter(ageBins == "18~25") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)

## Process WEIRD
H3_PsyStages2 <- H3_PsyStages %>% 
  dplyr::left_join(WEIRD, by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>%
  dplyr::mutate(ISO3 = factor(ISO3, levels = H3_PsyStages_factor)) %>% 
  dplyr::filter(!is.na(ageBins))


## The prop of 18~25 more than China (61.08)
H3_PsyStages2_more_China <- H3_PsyStages2 %>% 
  dplyr::filter(ageBins == "18~25") %>% 
  dplyr::filter(Proportion > 61.08)
```


And I visualized age data (PsyStages) for all countries in BTS.
```{r}
H3_Fig_PsyStages <- ggplot(H3_PsyStages2, aes(x=Proportion, y=ISO3, fill=ageBins)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("0~17", "18~25", "26~40", "41~60",">=61" )) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free") 


H3_Fig_PsyStages
```


The other is 10-year-old.
```{r}
## Filter > 30
BTS_interval10_allcountry_filter <-  BTS_age_interval10 %>% 
  dplyr::filter(Article_Id != "Lucca_et_al_2024") %>%  ## filter target population is a and 3
  dplyr::group_by(ISO3) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::filter(n > 30) %>% 
  dplyr::ungroup() %>% 
  dplyr::pull(ISO3)


BTS_interval10_allcountry <- BTS_age_interval10 %>% 
  dplyr::filter(ISO3 %in% BTS_interval10_allcountry_filter) %>% 
  dplyr::filter(ISO3 != "CHN") %>%  ## drop Chinese data
  dplyr::group_by(ISO3,ageBins) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) %>% 
  dplyr::ungroup()

## ## calculate total sum
BTS_interval10_allcountry_sum_prop <- BTS_interval10_allcountry %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::summarise(sum = sum(Proportion)) %>% 
  dplyr::ungroup()


## Add Chinese data
Journal_BTS_interval10_CHN <- H2_age_inteval10_bayes_general %>%
  dplyr::mutate(ISO3 = "CHN") %>% 
  dplyr::rename(Proportion = `Chinese subjects`)


## Combine data
H3_interval10 <- bind_rows(BTS_interval10_allcountry,Journal_BTS_interval10_CHN)


## Set factor
H3_interval10_factor <- H3_interval10 %>%
  # dplyr::add_row(ISO3 = "CUB",ageBins = "11~20",n = 0, Proportion =0) %>%
  ##add data to visualization 
  dplyr::filter(ageBins == "11~20") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)


## Process WEIRD
H3_interval10 <- H3_interval10 %>% 
  dplyr::left_join(WEIRD, by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>%
  dplyr::mutate(ISO3 = factor(ISO3, levels = H3_interval10_factor)) %>% 
  dplyr::filter(!is.na(ageBins) & !is.na(ISO3)) 


## each countries the max agebins
H3_interval10_max_agebins <-  H3_interval10 %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::mutate(Rank = dense_rank(desc(Proportion))) %>% 
  dplyr::filter(Rank == 1) 

table(H3_interval10_max_agebins$ageBins)
```

and I visualized age data (interval10) of all countries in BTS.

```{r}
H3_Fig_interval10 <- ggplot(H3_interval10, aes(x=Proportion, y=ISO3, fill=ageBins)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("0~10","11~20","21~30", "31~40", "41~50", "51~60", ">=61")) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free") 


H3_Fig_interval10
```


After the visualization of complete, I calculated BF. Firstly I defined a function to calculating BF for multiple countries.
```{r}
# create a new variable to store the BF values
Func_BFpairs <- function(df, countries_order, prop_name){
  
  # create a temp variable for storing 
  BF_mult_tmp <- data.frame(matrix(nrow = 0, ncol = 5))
  colnames(BF_mult_tmp) <- c("Observed", "Expected", "Log(BF10)_NonInform", "BF10_NonInform", "BF01_NonInform")
  
  for (ii in seq(length(countries_order))){
    country <- countries_order[ii]
    if (country != "CHN"){
      df_tmp <- df %>% dplyr::select(prop_name, one_of(country), "CHN")
      
      BF_tmp <- BayesMultiNomial(dataset = df_tmp, 
                                 factor = prop_name, observed = country, expected = "CHN")
      
      BF_mult_tmp[ii,] <- c(as.character(country), "CHN", 
                            BF_tmp$BF$LogBF10, BF_tmp$BF$BF10, BF_tmp$BF$BF01)
    } 
  }
  
  countries_order_age <- BF_mult_tmp %>% 
    tidyr::drop_na() %>%
    dplyr::mutate(`Log(BF10)_NonInform` = as.numeric(`Log(BF10)_NonInform`)) %>%
    dplyr::arrange(`Log(BF10)_NonInform`) %>%
    dplyr::pull(Observed)
  
  BF_mult_p_tmp <- BF_mult_tmp %>%
    tidyr::drop_na() %>%
    dplyr::select(1,2,3) %>%
    dplyr::mutate(Countries = factor(Observed, levels = countries_order_age),
                  `Log(BF10)_NonInform` = as.numeric(`Log(BF10)_NonInform`)) 
  
  return(BF_mult_p_tmp)
}
```


Secondly , I calculated gender BF and visualized gender BF.
```{r message=FALSE, warning=FALSE}
H3_BF_gender <- H3_gender %>% 
  dplyr::select(ISO3,Gender,Proportion) %>% 
  dplyr::rename(Countries = 1)


H3_BF_gender_factor <- H3_BF_gender %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Countries)


H3_BF_gender <- H3_BF_gender  %>% 
  dplyr::mutate(Countries = factor(Countries, levels = H3_BF_gender_factor)) %>% 
  tidyr::pivot_wider(names_from = "Countries",values_from = "Proportion") %>% 
  Func_BFpairs(countries_order = H3_BF_gender_factor,
               prop_name = "Gender")
```


```{r warning=FALSE}
H3_Fig_BF_gender <- ggplot(H3_BF_gender, aes( x = `Log(BF10)_NonInform`, y = Countries)) +
  geom_point() +
  scale_color_grey() +
  xlim(-3, 20) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  ggtitle("Gender Proportion") + 
  xlab("Log(BF10)")+
  theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              panel.border = element_blank(),
              text = element_text(family='Times'),
              axis.text.x = element_text (size = 6, color = 'black',  hjust = 1),
              axis.text.y = element_text (size = 6, color = 'black'),
              plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
              axis.text = element_text (size = 6, color = 'black'),
              axis.title = element_text (size = 16),
              axis.title.x = element_text (size = 16),
              axis.title.y = element_text( size = 16),
              axis.line.x = element_line(color='black', size = 1),
              axis.line.y = element_line(color='black', size = 1))


H3_Fig_BF_gender
```


Third, I calculted age BF in two classification. In this part, I calculated BF for this two categories.
```{r}
## PsyStages
H3_BF_PsyStages <- H3_PsyStages2 %>% 
  dplyr::select(ISO3,ageBins,Proportion) %>%
  dplyr::filter(!is.na(ISO3)) %>% 
  dplyr::rename(Countries = 1)

table(H3_BF_PsyStages$ageBins)

H3_BF_PsyStages_factor <- H3_BF_PsyStages %>% 
  dplyr::filter(ageBins == "18~25") %>%
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Countries)


 
H3_BF_PsyStages <- H3_BF_PsyStages %>%  
  dplyr::mutate(Countries = factor(Countries, levels = H3_BF_PsyStages_factor)) %>%  
  tidyr::pivot_wider(names_from = "Countries",values_from = "Proportion") %>%
  dplyr::mutate(across(2:last_col(), ~ifelse(is.na(.), 0, .))) %>%
  Func_BFpairs(countries_order = H3_BF_PsyStages_factor,
               prop_name = "ageBins")

# sum(H3_BF_PsyStages$AGO,na.rm = TRUE) ## 0

## interval10
H3_BF_interval10  <- H3_interval10 %>% 
  dplyr::select(ISO3,ageBins,Proportion) %>% 
  dplyr::rename(Countries = 1)


H3_BF_interval10_factor <- H3_BF_interval10 %>% 
  dplyr::filter(ageBins == "11~20") %>%
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Countries)


table(H3_BF_interval10$ageBins)


H3_BF_interval10 <- H3_BF_interval10 %>% 
  dplyr::mutate(Countries = factor(Countries, levels = H3_BF_interval10_factor)) %>% 
  tidyr::pivot_wider(names_from = "Countries",values_from = "Proportion") %>%
  dplyr::mutate(across(2:last_col(), ~ifelse(is.na(.), 1, .))) %>%
  Func_BFpairs(countries_order = H3_BF_PsyStages_factor,
               prop_name = "ageBins")
```


and I visualized PsyStages BF at first.
```{r warning=FALSE}
H3_Fig_BF_PsyStages <- ggplot(H3_BF_PsyStages, aes( x = `Log(BF10)_NonInform`, y = Countries)) +
  geom_point() +
  scale_color_grey() +
  xlim(-15,150) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10))  +
  ggtitle("Age distribution") +
  xlab("Log(BF10)")+
  theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              panel.border = element_blank(),
              text = element_text(family='Times'),
              axis.text.x = element_text (size = 6, color = 'black',  hjust = 1),
              axis.text.y = element_text (size = 6, color = 'black'),
              plot.title = element_text(lineheight=.6, face="bold", size = 18, margin=margin(0,0,20,0)),
              axis.text = element_text (size = 10, color = 'black'),
              axis.title = element_text (size = 16),
              axis.title.x = element_text (size = 16),
              axis.title.y = element_text( size = 16),
              axis.line.x = element_line(color='black', size = 1),    
              axis.line.y = element_line(color='black', size = 1))

H3_Fig_BF_PsyStages
```


Then I visualized another category.
```{r warning=FALSE}
H3_Fig_BF_interval10 <- ggplot(H3_BF_interval10, 
                            aes( x = `Log(BF10)_NonInform`, y = Countries)) +
  geom_point() +
  scale_color_grey() +
  xlim(-15,150) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10))  +
  ggtitle("Age distribution") +
  xlab("Log(BF10)")+
  theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              panel.border = element_blank(),
              text = element_text(family='Times'),
              axis.text.x = element_text (size = 6, color = 'black',  hjust = 1),
              axis.text.y = element_text (size = 6, color = 'black'),
              plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
              axis.text = element_text (size = 6, color = 'black'),
              axis.title = element_text (size = 16),
              axis.title.x = element_text (size = 16),
              axis.title.y = element_text( size = 16),
              axis.line.x = element_line(color='black', size = 1),    
              axis.line.y = element_line(color='black', size = 1))

H3_Fig_BF_interval10
```


Finally, I combined the these fig, as well as the figure that suppl document.
```{r warning=FALSE}
## gender
H3_Fig_gender2 <- H3_Fig_BF_gender + H3_Fig_gender +
  plot_annotation(tag_levels = 'A')  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))

ggsave("H3_Fig_gender.pdf", H3_Fig_gender2, device = "pdf", width=18, height = 18)

H3_Fig_gender2


## age
H3_Fig_age <- H3_Fig_BF_PsyStages + H3_Fig_PsyStages +
  plot_annotation(tag_levels = 'A')  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))

ggsave("H3_Fig_age.pdf", H3_Fig_age, device = "pdf", width=18, height = 18)

H3_Fig_age


## suppl
H3_Fig_age_suppl <- H3_Fig_BF_interval10 + H3_Fig_interval10 +
   plot_annotation(tag_levels =list(c("S2a","S2b")))  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))


ggsave("H3_Fig_age_suppl .pdf", H3_Fig_age_suppl , device = "pdf", width=18, height = 18)


H3_Fig_age_suppl 
```


### Region
In this part, I analysed and visualized all countries in our study. Firstly, I processed region data of BTS.
```{r}
H3_BTS_region <- BTS[names(BTS) != "BTS_Lucca_et_al_2024"]


H3_BTS_region_general <- lapply(H3_BTS_region,function(df){
  
  df <- df %>% 
    dplyr::select(Article_Id,ISO3,ISO2)
  
  return(df)
})

H3_BTS_region_general <- do.call(rbind,H3_BTS_region_general)


H3_BTS_region_general2 <- H3_BTS_region_general %>% 
  dplyr::filter(!is.na(ISO2)) %>%   ## ISO2 is used to subsequent visualize the spatial distribution in and filter out the data with countries as NA.
  dplyr::group_by(ISO2) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                Site = "BTS")

sum(H3_BTS_region_general2$Proportion)
```



```{r}
## creat a world map
world_map <- ggplot2::map_data(map = "world") %>% 
  dplyr::mutate(region = iso.alpha(region),
                region = ifelse(region == "TW","CN",region)) %>% 
  dplyr::filter(region != "AQ")


# ,
#                 long = ifelse(long >= -180 & long <= -30, long + 360, long),
#                 ))  

H3_sample_region <- H3_BTS_region_general2 %>% 
  dplyr::filter(ISO2 != "--") %>% 
  dplyr::mutate(ISO2 = case_when(ISO2 %in% c("TW","MO","HK") ~ "CN",
                                 TRUE ~ ISO2)) %>% 
  dplyr::select(-Proportion) %>% 
  dplyr::mutate(Proportion = n/sum(n)*100) %>%  ## I am not adding Journal data
  dplyr::mutate(Proportion_bins = if_else(Proportion >= 16, ">=16%",
                                          if_else(Proportion < 16 & Proportion >= 8, "8%-16%" ,
                                                  if_else(Proportion < 8 & Proportion >= 4, "4%-8%" , 
                                                          if_else(Proportion < 4 & Proportion >= 2, "2%-4%" , 
                                                                  if_else(Proportion < 0.02 & Proportion >= 1, "1%-2%" , 
                                                                          if_else(Proportion < 1 & Proportion >= 0.5, "0.5%-1%" ,         
                                                                                  if_else(Proportion < 0.5 & Proportion >= 0.25, "0.25%-0.5%", "0%-0.25%"))))))))
```


And I visualized geographic distribution of BTS.
```{r}
H3_Fig_sample_region <- H3_sample_region %>% 
  ggplot()+
  geom_map(aes(map_id = ISO2, fill = Proportion_bins), map = world_map,show.legend = TRUE) +
  geom_polygon(data = world_map, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  scale_fill_manual(name = "Proportion",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0%-0.25%", "0.25%-0.5%", "0.5%-1%", "1%-2%", "2%-4%", "4%-8%","8%-16%", "16%-1%"),
                    drop = FALSE) +
ggtitle("Geographical distribution of sample")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.position = "none")

H3_Fig_sample_region
```


Secondly, I processed and visualized geographic distribution of world population. Note: this data process and plot code from Liu weibiao and Hu chuanpeng, thanks them.
```{r}
wppdata <- read_csv("WPP2022.csv")

wppdata1 <- subset(wppdata, select = c("country_map","continent", "pop"))

wppdata3 <- dplyr::mutate(.data = wppdata1, percentage_pop = pop/7909295.151) 

#Merge data from Taiwan Province with data from mainland China
sum_of_cn <- sum(wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")])

wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")] <- sum_of_cn
# wppdata3$percentage_pop[wppdata3 $country_map == "GL"] <- NA


wppdata3 <- wppdata3 %>% 
  dplyr::mutate(percentage_pop = percentage_pop *100)

wppdata3$n_binned <- 
  if_else(wppdata3$percentage_pop >= 16, "16%-19%",
  if_else(wppdata3$percentage_pop < 16 & wppdata3$percentage_pop >= 8, "8%-16%" , 
   if_else(wppdata3$percentage_pop < 8 & wppdata3$percentage_pop >= 4, "4%-8%" , 
  if_else(wppdata3$percentage_pop < 4 & wppdata3$percentage_pop >= 2, "2%-4%" , 
   if_else(wppdata3$percentage_pop < 2 & wppdata3$percentage_pop >= 1, "1%-2%" , 
   if_else(wppdata3$percentage_pop < 1 & wppdata3$percentage_pop >= 0.5, "0.5%-1%" ,         
  if_else(wppdata3$percentage_pop < 0.5 & wppdata3$percentage_pop >= 0.25, "0.25%-0.5%",
      "0%-0.25%"
    )
  )
 )
))))


wppdata4 <- wppdata3[complete.cases(wppdata3$percentage_pop), ]

# map of World people data 
world_population_map <- ggplot2::ggplot(wppdata4) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map,show.legend = TRUE) +
  ggplot2::geom_polygon(data = world_map, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  scale_fill_manual(name = "Proportion",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0%-0.25%", "0.25%-0.5%", "0.5%-1%", "1%-2%", "2%-4%", "4%-8%","8%-16%", "16%-19%"),
                    drop = FALSE) +
ggtitle("Geographical distribution of world population")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )

world_population_map

H3_Fig_region <- H3_Fig_sample_region + world_population_map + 
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')

ggsave("H3_region.pdf",H3_region, device = "pdf", width=18, height = 9)

H3_Fig_region
```


I analysis region data of BTS based on different region cutoff.

The first cutoff is WEIRD and non-WEIRD
```{r}
H3_BTS_region_WEIRD_general <- H3_BTS_region_general2 %>% 
  dplyr::left_join(WEIRD, by = c("ISO2" = "iso2c")) %>% 
  dplyr::filter(ISO2 != "--") %>% 
  dplyr::select(ISO2,n,WEIRD) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO2 == "XK","WEIRD",WEIRD)) %>%
  dplyr::group_by(WEIRD) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                `Data source` = "BTS")

## load the world population data
load("WPP2021_gender_age.Rdata")


## Divide all country into WERID and non-WEIRD
H3_World_region_WERID <- WPP2021_gender_prop %>% 
  dplyr::mutate(ISO2 = ifelse(ISO3 == "NAM","NA",ISO2)) %>% 
  dplyr::left_join(WEIRD, by = c("ISO2" = "iso2c"))


## filter data those exist in BTS 
H3_BTS_region_general2_factor  <-  H3_BTS_region_general2$ISO2

H3_World_region_WERID2 <- H3_World_region_WERID %>% 
  dplyr::filter(ISO2 %in% H3_BTS_region_general2_factor) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO2 == "XK","WEIRD",WEIRD))

## calculate the WERID prop of all the wolrd population
H3_World_region_WERID_prop <- H3_World_region_WERID2 %>% 
  dplyr::group_by(WEIRD) %>% 
  dplyr::summarise(n=sum(Population)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Proportion = n/sum(n)*100,
                `Data source` = "World population")

```


visualize the first cutoff and calculate its BF
```{r}
## combine BTS data and world data
H3_region_WEIRD <- bind_rows(H3_BTS_region_WEIRD_general,H3_World_region_WERID_prop) %>% 
  dplyr::mutate(WEIRD = ifelse(WEIRD == "Non_WEIRD","Non-WEIRD",WEIRD))


## ggplot
H3_Fig_region_WEIRD <- ggplot(data = H3_region_WEIRD, aes(x = `Data source`, y = Proportion, fill = WEIRD)) +
  geom_col(position = "stack")+
  labs(fill = "Region")+
  theme_classic()+
  theme(legend.box.spacing = unit(2,"pt"),
        legend.position = "bottom",
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_text(size = 20, family = "serif"),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  guides(fill = guide_legend(ncol = 2))


ggsave("H3_Fig_region_WEIRD.pdf",H3_Fig_region_WEIRD, device = "pdf", width= 12, height = 9)

H3_Fig_region_WEIRD 


## BF
H3_region_WEIRD_bayes <- H3_region_WEIRD %>% 
  dplyr::select(-n) %>% 
  tidyr::pivot_wider(names_from = `Data source`,
                     values_from = Proportion)


H3_BF_region_WEIRD <- BayesMultiNomial(dataset = H3_region_WEIRD_bayes,
                                       factor = "WEIRD",
                                       observed = "BTS",
                                       expected = "World population")
```



In psychological research, the representativeness of a participant sample is determined by the population characteristics of the country it belongs to. Merely comparing it with China’s demographic patterns cannot determine whether a country’s sample is representative in terms of demographics. Next, I will compare data from each country in the BTS with global population data.

First of all, I will compare the gender data between the two data source
```{r}
H3_gender_ISO2 <- H3_gender$ISO3

H3_gender_WPP2021 <- WPP2021_gender_prop %>% 
  dplyr::filter(ISO3 %in% H3_gender_ISO2) %>% 
  dplyr::select(ISO3,Male_proportion,Female_proportion) %>% 
  tidyr::pivot_longer(cols = c(Male_proportion,Female_proportion),
                      names_to = "Gender",
                      values_to = "Proportion_World") %>% 
  dplyr::mutate(Gender = ifelse(Gender == "Male_proportion", "Male","Female"),
                `World population` = "World population")

##combine two data source
H3_gender_World_Psysample <- H3_gender %>% 
  dplyr::select(ISO3,Gender,Data_Source,Proportion,WEIRD) %>% 
  dplyr::rename(`BTS` = 3,Proportion_BTS = 4) %>% 
  dplyr::left_join(H3_gender_WPP2021, by = c("ISO3","Gender")) %>% 
  dplyr::select(ISO3,Gender,Proportion_BTS,Proportion_World,WEIRD) %>% 
  dplyr::filter(ISO3 != "PCN") 
```


Calculate BF
```{r}
groups <- unique(H3_gender_World_Psysample[, c("ISO3", "WEIRD")])


# create data.frame
H3_BF_gender_World_Psysample <- data.frame(ISO3 = character(),
                      WEIRD = character(),
                      LogBF10 = numeric(),
                      BF10 = numeric(),
                      BF01 = numeric(),
                      stringsAsFactors = FALSE)


# lappy iso and WEIRD
for (i in 1:nrow(groups)) {
  current_iso <- groups$ISO3[i]
  current_weird <- groups$WEIRD[i]
  

  group_data <- H3_gender_World_Psysample[H3_gender_World_Psysample$ISO3 == current_iso & H3_gender_World_Psysample$WEIRD == current_weird, ]
  

  if (nrow(group_data) == 0) next
  

  bayes_result <- BayesMultiNomial(
    dataset = group_data,
    factor = "Gender",
    observed = "Proportion_BTS",
    expected = "Proportion_World")
  
  H3_BF_gender_World_Psysample <- rbind(H3_BF_gender_World_Psysample, data.frame(
    ISO3 = current_iso,
    WEIRD = current_weird,
    LogBF10 = bayes_result$BF$LogBF10,
    BF10 = bayes_result$BF$BF10,
    BF01 = bayes_result$BF$BF01))
}


## set factor
H3_BF_gender_World_Psysample_factor <- H3_BF_gender_World_Psysample %>%
  dplyr::arrange(WEIRD,LogBF10) %>%
  dplyr::pull(ISO3)

# H3_BF_gender_world_BTS_factor <- H3_BF_gender_world_BTS_factor[-6]

H3_BF_gender_World_Psysample <- H3_BF_gender_World_Psysample %>%
  dplyr::mutate(ISO3 = factor(ISO3,
                              levels = H3_BF_gender_World_Psysample_factor),
                WEIRD = ifelse(WEIRD == "Non_WEIRD","Non-WEIRD","WEIRD"))

## divide WEIRD
H3_BF_gender_World_Psysample_WEIRD <- H3_BF_gender_World_Psysample %>%
  dplyr::filter(WEIRD == "WEIRD")

H3_BF_gender_World_Psysample_nonWEIRD <- H3_BF_gender_World_Psysample %>%
  dplyr::filter(WEIRD == "Non-WEIRD")
```


visualize BF
```{r warning=FALSE}
H3_Fig_BF_gender_World_Psysample_WEIRD <- ggplot(H3_BF_gender_World_Psysample_WEIRD, 
                                           aes(x = LogBF10, y = ISO3)) +
  geom_point() +
  scale_x_continuous(breaks = seq(-5, 15, by = 5), limits = c(-5, 15))+
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash"))+
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7,
            angle=90, size=3)+
  theme_classic()+
  theme(legend.position = "none",
        axis.title= element_text(size = 6,family = "serif"),
        axis.text = element_text(size = 6,family = "serif"),
        strip.text = element_text(size = 6,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  ylab("WEIRD countries")
  

H3_Fig_BF_gender_World_Psysample_WEIRD



H3_Fig_BF_gender_World_Psysample_nonWEIRD <- ggplot(H3_BF_gender_World_Psysample_nonWEIRD, 
                                           aes(x = LogBF10, y = ISO3)) +
  geom_point() +
  scale_x_continuous(breaks = seq(-5, 15, by = 5), limits = c(-5, 15))+
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash"))+
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7,
            angle=90, size=3)+
  theme_classic()+
  theme(legend.position = "none",
        axis.title= element_text(size = 6,family = "serif"),
        axis.text = element_text(size = 6,family = "serif"),
        strip.text = element_text(size = 6,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  ylab("Non-WEIRD countries")
  

H3_Fig_BF_gender_World_Psysample_nonWEIRD
```


And then, I will calculate age data.
PsyStages
```{r}
H3_PsyStages2_factor <-  H3_PsyStages2$ISO3

H3_PsyStages_WPP2021 <-  WPP2021_PsyStages %>% 
  dplyr::filter(ISO3 %in% H3_PsyStages2_factor) %>% 
  dplyr::select(ISO3,7:11) %>% 
  tidyr::pivot_longer(cols = c("0~17","18~25","26~40","41~60",">=61"),
                      names_to = "ageBins",
                      values_to = "Proportion_World") %>% 
  dplyr::mutate(ageBins = ifelse(ageBins == "0~17","<=17",ageBins))


## fill BTS ageBins

# Define the full list of age bins
PsyStages_ageBins <- c("<=17", "18~25", "26~40", "41~60", ">=61")  


# Generate all possible combinations of ISO3 and age bins
# Extract unique ISO3 codes from the original dataset
unique_iso3 <- H3_PsyStages2 %>% 
  distinct(ISO3) %>% 
  pull(ISO3)  

# Create a tibble with all combinations (cross join)
full_combinations <- crossing(
  ISO3 = unique_iso3, 
  ageBins = PsyStages_ageBins
)  

# Left join with original data and fill missing values
H3_PsyStages3 <- full_combinations %>% 
  dplyr::left_join(H3_PsyStages2, by = c("ISO3", "ageBins")) %>%  # Merge with original data
  tidyr::replace_na(list(Proportion = 0)) %>%  # Fill missing Prop values with 0 
  dplyr::group_by(ISO3) %>% 
  tidyr::fill(WEIRD, .direction = "downup") %>% 
  dplyr::ungroup()

## combine two data source
H3_PsyStages_World_Psysample <- H3_PsyStages3 %>% 
  dplyr::select(ISO3,ageBins,Proportion,WEIRD) %>% 
  dplyr::rename(Proportion_Psysample = 3) %>% 
  dplyr::left_join(H3_PsyStages_WPP2021, by = c("ISO3","ageBins")) %>% 
  dplyr::filter(ISO3 != "PCN")
```


calculate PsyStages BF
```{r}
# Extract unique combinations of country, age group, and WEIRD status
groups <- unique(H3_PsyStages_World_Psysample[, c("ISO3","WEIRD")])

# Initialize results data frame
H3_BF_PsyStages_World_Psysample <- data.frame(
  ISO3 = character(),
  WEIRD = character(),
  LogBF10 = numeric(),
  BF10 = numeric(),
  BF01 = numeric(),
  stringsAsFactors = FALSE
)

# Loop through each unique group combination
for (i in 1:nrow(groups)) {
  current_iso <- groups$ISO3[i]
  current_weird <- groups$WEIRD[i]
  
  # Filter data for current group
  group_data <- H3_PsyStages_World_Psysample[
    H3_PsyStages_World_Psysample$ISO3 == current_iso & 
    H3_PsyStages_World_Psysample$WEIRD == current_weird, 
  ]
  
  # Skip if no data found for this group
  if (nrow(group_data) == 0) next
  
  # Calculate Bayes Factor using BayesMultiNomial function
  bayes_result <- BayesMultiNomial(
    dataset = group_data,
    factor = "ageBins",
    observed = "Proportion_Psysample",
    expected = "Proportion_World"
  )
  
  # Append results to the results data frame
  H3_BF_PsyStages_World_Psysample <- rbind(H3_BF_PsyStages_World_Psysample, data.frame(
    ISO3 = current_iso,  # Fixed missing comma here
    WEIRD = current_weird,
    LogBF10 = bayes_result$BF$LogBF10,
    BF10 = bayes_result$BF$BF10,
    BF01 = bayes_result$BF$BF01
  ))
}


## set factor
H3_BF_PsyStages_World_Psysample_factor <- H3_BF_PsyStages_World_Psysample %>% 
  dplyr::arrange(WEIRD,LogBF10) %>% 
  dplyr::pull(ISO3)


H3_BF_PsyStages_World_Psysample <- H3_BF_PsyStages_World_Psysample %>% 
  dplyr::mutate(ISO3 = factor(ISO3,
                              levels = H3_BF_PsyStages_World_Psysample_factor),
                WEIRD = ifelse(WEIRD == "Non_WEIRD","Non-WEIRD","WEIRD"))


## divide WEIRD
H3_BF_PsyStages_World_Psysample_WERID <- H3_BF_PsyStages_World_Psysample %>% 
  dplyr::filter(WEIRD == "WEIRD")

H3_BF_PsyStages_World_Psysample_nonWERID <- H3_BF_PsyStages_World_Psysample %>% 
  dplyr::filter(WEIRD == "Non-WEIRD")
```


visualize PsyStages BF
```{r warning=FALSE}
H3_Fig_BF_PsyStages_World_Psysample_WERID <- ggplot(data = H3_BF_PsyStages_World_Psysample_WERID,aes(x = LogBF10, y = ISO3)) +
  geom_point() +
  scale_x_continuous(breaks = seq(-15, 160, by = 20), limits = c(-15, 160))+
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash"))+
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7,
            angle=90, size=3)+
  theme_classic()+
  theme(legend.position = "none",
        axis.title= element_text(size = 6,family = "serif"),
        axis.text = element_text(size = 6,family = "serif"),
        strip.text = element_text(size = 6,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  # facet_wrap(~ WEIRD, scales = "free", ncol = 2) +
  ylab("WEIRD countries")
  

H3_Fig_BF_PsyStages_World_Psysample_WERID


H3_Fig_BF_PsyStages_World_Psysample_nonWERID <- ggplot(data = H3_BF_PsyStages_World_Psysample_WERID,aes(x = LogBF10, y = ISO3)) +
  geom_point() +
  scale_x_continuous(breaks = seq(-15, 160, by = 20), limits = c(-15, 160))+
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash"))+
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7,
            angle=90, size=3)+
  theme_classic()+
  theme(legend.position = "none",
        axis.title= element_text(size = 6,family = "serif"),
        axis.text = element_text(size = 6,family = "serif"),
        strip.text = element_text(size = 6,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  ylab("Non-WEIRD countries")


H3_Fig_BF_PsyStages_World_Psysample_nonWERID


H3_Fig_BF_Gender_PsyStages <- H3_Fig_BF_gender_World_Psysample_nonWEIRD + 
  H3_Fig_BF_gender_World_Psysample_WEIRD + 
  H3_Fig_BF_PsyStages_World_Psysample_nonWERID + 
  H3_Fig_BF_PsyStages_World_Psysample_WERID +
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')

ggsave("H3_Fig_BF_Gender_PsyStages.pdf",
       H3_Fig_BF_Gender_PsyStages, device = "pdf", width=18, height = 18)

H3_Fig_BF_Gender_PsyStages
```


interval10
```{r}
H3_interval10_factor <-  H3_interval10$ISO3

H3_interval10_WPP2021 <-  WPP2021_interval10 %>% 
  dplyr::filter(ISO3 %in% H3_interval10_factor) %>% 
  dplyr::select(ISO3,7:13) %>% 
  tidyr::pivot_longer(cols = c("0~10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"),
                      names_to = "ageBins",
                      values_to = "Proportion_World") %>% 
  dplyr::mutate(ageBins = ifelse(ageBins == "0~10","<=10",ageBins))


## fill BTS ageBins

# Define the full list of age bins
interval10_ageBins <- c("<=10", "11~20","21~30", "31~40", "41~50", "51~60", ">=61")  


# Generate all possible combinations of ISO3 and age bins
# Extract unique ISO3 codes from the original dataset
unique_iso3 <- H3_interval10 %>% 
  distinct(ISO3) %>% 
  pull(ISO3)  

# Create a tibble with all combinations (cross join)
full_combinations <- crossing(
  ISO3 = unique_iso3, 
  ageBins = interval10_ageBins
)  

# Left join with original data and fill missing values
H3_interval102 <- full_combinations %>% 
  dplyr::left_join(H3_interval10, by = c("ISO3", "ageBins")) %>%  # Merge with original data
  tidyr::replace_na(list(Proportion = 0)) %>%  # Fill missing Prop values with 0 
  dplyr::group_by(ISO3) %>% 
  tidyr::fill(WEIRD, .direction = "downup") %>% 
  dplyr::ungroup()

## combine two data source
H3_interval10_World_Psysample <- H3_interval102 %>% 
  dplyr::select(ISO3,ageBins,Proportion,WEIRD) %>% 
  dplyr::rename(Proportion_Psysample = 3) %>% 
  dplyr::left_join(H3_interval10_WPP2021, by = c("ISO3","ageBins")) %>% 
  dplyr::filter(ISO3 != "PCN")
```


calculate interval10 BF
```{r}
# Extract unique combinations of country, age group, and WEIRD status
groups <- unique(H3_interval10_World_Psysample[, c("ISO3","WEIRD")])

# Initialize results data frame
H3_BF_interval10_World_Psysample <- data.frame(
  ISO3 = character(),
  WEIRD = character(),
  LogBF10 = numeric(),
  BF10 = numeric(),
  BF01 = numeric(),
  stringsAsFactors = FALSE
)

# Loop through each unique group combination
for (i in 1:nrow(groups)) {
  current_iso <- groups$ISO3[i]
  current_weird <- groups$WEIRD[i]
  
  # Filter data for current group
  group_data <- H3_interval10_World_Psysample[
    H3_interval10_World_Psysample$ISO3 == current_iso & 
    H3_interval10_World_Psysample$WEIRD == current_weird, 
  ]
  
  # Skip if no data found for this group
  if (nrow(group_data) == 0) next
  
  # Calculate Bayes Factor using BayesMultiNomial function
  bayes_result <- BayesMultiNomial(
    dataset = group_data,
    factor = "ageBins",
    observed = "Proportion_Psysample",
    expected = "Proportion_World"
  )
  
  # Append results to the results data frame
  H3_BF_interval10_World_Psysample <- rbind(H3_BF_interval10_World_Psysample, data.frame(
    ISO3 = current_iso,  # Fixed missing comma here
    WEIRD = current_weird,
    LogBF10 = bayes_result$BF$LogBF10,
    BF10 = bayes_result$BF$BF10,
    BF01 = bayes_result$BF$BF01
  ))
}


## set factor
H3_BF_interval10_World_Psysample_factor <- H3_BF_interval10_World_Psysample %>% 
  dplyr::arrange(WEIRD,LogBF10) %>% 
  dplyr::pull(ISO3)


H3_BF_interval10_World_Psysample <- H3_BF_interval10_World_Psysample %>% 
  dplyr::mutate(ISO3 = factor(ISO3,
                              levels = H3_BF_interval10_World_Psysample_factor),
                WEIRD = ifelse(WEIRD == "Non_WEIRD","Non-WEIRD","WEIRD"))


## divide WEIRD
H3_BF_interval10_World_Psysample_WERID <- H3_BF_interval10_World_Psysample %>% 
  dplyr::filter(WEIRD == "WEIRD")

H3_BF_interval10_World_Psysample_nonWERID <- H3_BF_interval10_World_Psysample %>% 
  dplyr::filter(WEIRD == "Non-WEIRD")
```


visualize interval10 BF
```{r warning=FALSE}
H3_Fig_BF_interval10_World_Psysample_WERID <- ggplot(data = H3_BF_PsyStages_World_Psysample_WERID,aes(x = LogBF10, y = ISO3)) +
  geom_point() +
  scale_x_continuous(breaks = seq(-15, 100, by = 20), limits = c(-15, 100))+
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash"))+
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7,
            angle=90, size=3)+
  theme_classic()+
  theme(legend.position = "none",
        axis.title= element_text(size = 6,family = "serif"),
        axis.text = element_text(size = 6,family = "serif"),
        strip.text = element_text(size = 6,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  # facet_wrap(~ WEIRD, scales = "free", ncol = 2) +
  ylab("WEIRD countries")
  

H3_Fig_BF_interval10_World_Psysample_WERID


H3_Fig_BF_interval10_World_Psysample_nonWERID <- ggplot(data = H3_BF_PsyStages_World_Psysample_WERID,aes(x = LogBF10, y = ISO3)) +
  geom_point() +
  scale_x_continuous(breaks = seq(-15, 100, by = 20), limits = c(-15, 100))+
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash"))+
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7,
            angle=90, size=3) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7,
            angle=90, size=3)+
  theme_classic()+
  theme(legend.position = "none",
        axis.title= element_text(size = 6,family = "serif"),
        axis.text = element_text(size = 6,family = "serif"),
        strip.text = element_text(size = 6,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  ylab("Non-WEIRD countries")


H3_Fig_BF_interval10_World_Psysample_nonWERID


H3_Fig_BF_interval10 <- H3_Fig_BF_interval10_World_Psysample_nonWERID + 
  H3_Fig_BF_interval10_World_Psysample_WERID +
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')

ggsave("H3_Fig_BF_interval10.pdf",
       H3_Fig_BF_interval10, device = "pdf", width=18, height = 9)

H3_Fig_BF_interval10
```

