---
title: "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V2"
author: "Lei Yue"
date: "2024-04-20"
output:
  prettydoc::html_pretty:
  theme: cayman
  highlight: github
---

In "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V1.Rmd"， I preprocess the journal code data. In this Rmd(V2), we enter the informal process data.

**Special Note:** To enhance the readability and accessibility of this document, we have provided a concise explanation for the naming convention of data

Journal\_: This prefix signifies data that has been coded and extracted from five mainstream Chinese journals.

BTS\_: This indicates data sourced from large-scale international collaborations.

H1\_: This indicates data use to test hypothesis 1.

H2\_: This indicates data use to test hypothesis 2.

H3\_: This indicates data use to test hypothesis 3.

Census\_: This prefix represents Census data published by the National Bureau of Statistics of China.

CFPS2018\_: This signifies data from the 2018 Chinese Family Panel Study.

The majority of data adhere to these naming conventions, with the prefixes typically followed by descriptive and comprehensible demographic variable names or other relevant terms to clarify the data content.

Furthermore, if "Fig" appears in the data name, it signifies that the content represents a data visualization result. Similarly, the presence of "bayes" indicates that the data or result pertains to the calculation of the Bayes factor.

Now, I start to analysis data. and the first thing is load library.

# Install and Load packages

```{r message=FALSE, warning=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")

# use package "pacman" as loading R packages tools

pacman::p_load("tidyverse","here","rio")
pacman::p_load("geojsonsf","sf","RColorBrewer","ggspatial","patchwork","ggrepel","maps")
pacman::p_load("truncnorm","BayesFactor", "gtools", "bruceR")
```

And then, I loaded the data. The data includes data from the first Stage 1 of the pre-registration report (primarily Census data and CFPS2018 data), Chinese journal coding data, and data from Big Team Science (BTS).

# Load data

## Load the data of stage 1 and Chinese journals coding data

```{r}
load("df_Pre_Stage2_Journal_Code.Rdata")

load("df_chinese_subj_rr_stage1.Rdata")

## Here, I remove some data sets to reduce data set clutter.
rm(df,df_PSA001,df_stage2_Journal_Code,Group1_bind,Group24567_bind,Group3_bind,df_regionCode)
```

## Load the data of BTS

Here, we first converted some data that is not in .xlsx format.

```{r}
library(haven)

## read data
## BTS_Van_Bavel_et_al_2022
BTS_Van_Bavel_et_al_2022 <- haven::read_sav("BTS_Van_Bavel_et_al_2022.sav") %>% 
  dplyr::mutate(Gender = ifelse(Gender == 1, "Male", "Female"))

## BTS_Manokara_et_al_2022
BTS_Manokara_et_al_2022 <- haven::read_sav("BTS_Manokara_et_al_2022.sav") %>% 
  dplyr::mutate(Gender = ifelse(Gender == 1, "Male", "Female"))

## save data
write.csv(BTS_Van_Bavel_et_al_2022, file = "BTS_Van_Bavel_et_al_2022.csv",row.names = FALSE)
write.csv(BTS_Manokara_et_al_2022, file = "BTS_Manokara_et_al_2022.csv",row.names = FALSE)

## Here, I remove some data sets to reduce data set clutter.
rm(BTS_Manokara_et_al_2022,BTS_Van_Bavel_et_al_2022)
```

Next, I loaded all BTS data and processed BTS data.

```{r message=FALSE, warning=FALSE, include=FALSE}
file_list <- list.files(here("D://chin-subj//2_Data_Extraction//2_1 CHN_Journal_Code//2_2_6_Data_Analysis"), ## If you need to learn or repeat the code document, please replace it with your local file address
                        pattern = ".csv",
                        full.names = TRUE,
                        recursive = TRUE)

BTS_data_list <- list()  
 
for (file in file_list) {  
    
  BTS_file <- readr::read_csv(file)  
  BTS_data_list[[tools::file_path_sans_ext(basename(file))]] <- BTS_file  

}  

BTS_data_list <- BTS_data_list[grepl("BTS_",names(BTS_data_list),ignore.case = TRUE)]

BTS <- BTS_data_list
rm(BTS_file)

## Here, I remove some data sets to reduce data set clutter.
rm(file,file_list,BTS_data_list)
```

### Process Country code of BTS

Uniform country codes facilitate subsequent data processing and analysis, especially for batch processing and analysis of data. Thus, I created a unified table of country codes.

```{r}
if(!require("countrycode")) install.packages("countrycode")

Countrycodelist <- codelist

Countrycodelist_iso2_iso3 <- Countrycodelist %>% 
  dplyr::select(country.name.en,iso2c,iso3c) %>% 
  dplyr::rename(Countryfullname = 1,ISO2 = 2, ISO3 = 3)

Countrycodelist_iso2_iso3$ISO2[Countrycodelist_iso2_iso3$Countryfullname == "Kosovo"] <- "XK"
Countrycodelist_iso2_iso3$ISO3[Countrycodelist_iso2_iso3$Countryfullname == "Kosovo"] <- "XKX"

## Here, I remove some data sets to reduce data set clutter.
rm(Countrycodelist)
```

The third hypothesis requires countries to be divided into WEIRD and non-WEIRD, so I created a data.frame of WEIRD countries to facilitate subsequent analysis and visualization.

```{r}
WEIRD <- codelist %>% 
  dplyr::select(3,6,iso2c,iso3c,region,region23) %>% 
  dplyr::mutate(WEIRD = ifelse(continent == "Europe" | region == "North America","WEIRD",NA),
                WEIRD = ifelse(continent %in% c("Africa","Asia") | region == "Latin America & Caribbean" | region == "East Asia & Pacific", "Non_WEIRD",WEIRD)) %>% 
  dplyr::mutate(WEIRD = ifelse(country.name.en %in% c("Israel","Australia","New Zealand"), "WEIRD",WEIRD),
                WEIRD = ifelse(is.na(WEIRD),"Non_WEIRD",WEIRD))
```

In this part, I tried to batch country code.

```{r}
## Handle some more specific encodings
BTS[[5]]$Country <- trimws(sub(".*-(\\s*)", "", BTS[[5]]$Country)) 
BTS[[14]]$Country <- trimws(sub(".*-(\\s*)", "", BTS[[14]]$Country)) 
names(BTS[[11]])[names(BTS[[11]]) == "Country_now"] <- "Country"

## Batch processing of country codes for different data sources
BTS <- lapply(BTS,function(df){
  
  df <- df %>% 
    mutate(#Country = toupper(Country),
           Country = case_when(Country %in% c("TW","HK","MO") ~ "CN",
                               Country %in% c("TWN","HKG","MAC") ~ "CHN",
                               Country %in% c("Taiwan","Macao","Hong Kong, China","Hong Kong") ~ "China",
                               Country %in% c("Bosnia and Herzegovina","Bosnia and. Herz.") ~ "Bosnia & Herzegovina",
                               Country %in% c("England","Northern Ireland","Wales") ~ "United Kingdom",
                               Country %in% c("SlovakRepublic") ~ "Slovakia",
                               Country %in% c("Czech Republic") ~ "Czechia",
                               Country %in% c("Macedonia") ~ "North Macedonia",
                               Country %in% c("The Netherlands") ~ "Netherlands",
                               #Country %in% c("US","USA") ~ "United States",
                               TRUE ~ Country
                               ),
           Country = toupper(Country),
           Country = ifelse(nchar(Country) > 3, str_to_title(Country),Country),
           Countrycode = ifelse(nchar(Country) > 3, "Countryfullname", 
                                ifelse(nchar(Country) == 3, "ISO3", "ISO2")))
  
  return(df)
  
})

## Check the country code of the BTS data
BTS_countrycode_check <- lapply(BTS, function(df){
  
  df <- df %>% 
    dplyr::group_by(Countrycode) %>% 
    dplyr::summarise(n=n()) %>% 
    dplyr::ungroup()
  
  return(df)
})

BTS_countrycode_check <- do.call(rbind, BTS_countrycode_check)

## process abnormal Countrycode
BTS[[4]] <- BTS[[4]] %>% 
  dplyr::mutate(Countrycode = ifelse(Country == "USA", "Countryfullname",Countrycode)) ## I found UEA, a non-country code

BTS[[5]] <- BTS[[5]] %>% 
  dplyr::mutate(Countrycode = ifelse(Country == "Ken, Na", "ISO3",Countrycode),
                Country = ifelse(Country == "Ken, Na", "KEN",Country))

BTS[[6]] <- BTS[[6]] %>% 
  dplyr::mutate(Countrycode = ifelse(Country == "Many", NA,Countrycode),
                Country = ifelse(Country == "Many", NA, Country))
  
## Combine the BTS_data and Countrycodelist_iso2_iso3
Countrycode_merge <- function(df, Countrycode) {  
  
  Countrycode_lengths <- nchar(as.character(df$Country))  
  Countrycode_lengths <- Countrycode_lengths[!is.na(Countrycode_lengths)]  
 
  if (all(Countrycode_lengths == 2)) {  
    
    merge_key <- "ISO2"  
  } else if (any(Countrycode_lengths > 3)) {  
   
    merge_key <- "Countryfullname"  
  } else {  
   
    merge_key <- "ISO3"  
  }  
    
  merged_df <- merge(df, Countrycode, by.x = "Country", by.y = merge_key, all.x = TRUE)  
    
  return(merged_df)  
}  
  
BTS <- lapply(BTS, Countrycode_merge, Countrycode = Countrycodelist_iso2_iso3)  

## Change the column name so that each BTS data has "ISO3"
BTS <- lapply(BTS,function(df){
  
  if(!"ISO3" %in% names(df)){
    
    df <- df %>% 
      dplyr::mutate(ISO3 = Country)
  }
  
  return(df)
  
})

## Change the column name so that each BTS data has "ISO2"
BTS <- lapply(BTS,function(df){
  
  if(!"ISO2" %in% names(df)){
    
    df <- df %>% 
      dplyr::mutate(ISO2 = Country)
  }
  
  return(df)
  
})

## Because the country code of the countrycode package is the full name, but some of the actual data set is recorded by abbreviation (for example: United States is USA), so this part is not converted properly, and is now found and processed separately.
BTS_na <- lapply(BTS, function(df){
  
  df <- df %>% 
    dplyr::filter(is.na(ISO3)) %>% 
    dplyr::select(Article_Id, Country, ISO3)
  
  return(df)
})

BTS_na <- do.call(rbind,BTS_na)

BTS_na_table <- data.frame(table(BTS_na$Country)) 

## Handle UK and UA separately
BTS <- lapply(BTS,function(df){
  
  df <- df %>% 
    dplyr::mutate(ISO2 = ifelse(Country == "UK" |Country == "UEA","GB",ISO2),
                  ISO2 = ifelse(Country == "US" | Country == "USA", "US",ISO2),
                  ISO3 = ifelse(Country == "UK"|Country == "UEA","GBR",ISO3),
                  ISO3 = ifelse(Country == "US" | Country == "USA", "USA",ISO3))
  
  return(df)
  
})
```

```{r include=FALSE}
## Here, I remove some data sets to reduce data set clutter.
rm(BTS_na_table,BTS_na,Countrycode_merge,BTS_countrycode_check)
gc()
```

Here, I used self-defined function in Stage1 to calculate Bayesian multinomial test.

# Define a Func to calculate Bayesian multinomial test

## Algorithm in R

```         
lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
```

Here, `alphas` defined the prior Dirichlet distribution, e.g., noninformative prior is a vector of $1$ s, `counts` are the observed frequencies.

To use the algorithm in R, we defined a function here:

```{r}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
    LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```

At this point, I have finished loading the package and data. Next, I analyzed the data and visualized it according to the logic of the written protocal.

I began by analyzing the basic case of the two data sets (BTS and Chinese journals).

# Overview of participants

## The basic situation of Chinese journals coding data

```{r warning=FALSE}
Journal <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) ## valid 1567 rows

Journal_articles_num <- Journal %>% 
  dplyr::distinct(Article_IDs) ## A total 962 articles

Journal_study_num <- Journal %>% 
  dplyr::distinct(Article_IDs,Study_Number) ## A total 1217 studies

Journal_sample_size <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size),
                Sample_Size = ifelse(Article_IDs == "20185082",33,Sample_Size))
# sum(Journal_sample_size$Sample_Size,na.rm = TRUE)  ## 538552

## Here, I remove some data sets to reduce data set clutter.
rm(Journal_articles_num,Journal_study_num,df_stage2_Journal_Code2)
```

## The basic situation about BTS data

```{r}
BTS_Overview <- lapply(BTS,function(df){
  
  df <- df %>% 
    dplyr::select(Article_Id,ISO3,ISO2)
  
  return(df)
})

BTS_Overview <- do.call(rbind,BTS_Overview)

BTS_Overview2 <- BTS_Overview %>% 
  dplyr::filter(!is.na(ISO2)) %>%   ## ISO2 is used to subsequent visualize the spatial distribution in and filter out the data with countries as NA.
  dplyr::group_by(ISO2) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2),
                FloorPro = floor(Proportion),
                index = Proportion - FloorPro,
                Site = "BTS")

sum(BTS_Overview2$Proportion)

BTS_Overview2_idx <- BTS_Overview2 %>% 
  group_by(Site) %>% 
  summarise(sum = sum(FloorPro)) %>% 
  ungroup()
```

## try percent 100

```{r}
# bts_overviewfill <- data.frame(matrix(ncol = ncol(BTS_Overview2),nrow = 0))
# colnames(bts_overviewfill) <- colnames(BTS_Overview2)
# 
# for (i in 1:nrow(BTS_Overview2_idx)) {
#   
#   df55 <- BTS_Overview2 %>% 
#     dplyr::filter(Site == BTS_Overview2_idx$Site[i]) %>% 
#     dplyr::arrange(desc(index))
#   
#   if(BTS_Overview2_idx$sum[i] < 100) {
#     
#     for(j in seq(100 - BTS_Overview2_idx$sum[i])){
#       
#       df55$FloorPro[j] <- df55$FloorPro[j] + 1
#     }
#       bts_overviewfill <- rbind(bts_overviewfill,df55)
#   }
# 
#    return(bts_overviewfill)
# 
# }
# 
# sum(bts_overviewfill$FloorPro)
```

## The reported situation of Chinese Journals

```{r}
Journal_report <- Journal %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())

report_list <- list()

for (i in names(Journal_report)){
  
  
  report_table <- data.frame(table(Journal_report[[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_report[i]),
                  proportion = round(Freq / sum(Freq),2))
  
  report_list[[i]] <- report_table
  
}

Journal_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 

### Calculate reported status of Educational_Attainment and Occupation
Journal_education_occupation <- Journal %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop")   ### 294 studies

# table(Educational_Occupation$Educational_Attainment_N) ## FALSE 162 TRUE 132
# table(Educational_Occupation$Occupation_N)  ## FALSE 193 TRUE 101

Journal_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(162,132,193,101),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(0.55,0.45,0.66,0.34))

Journal_report <- rbind(Journal_report,Journal_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment Method",
                                              "Recruitment Area","Educational Attainment",
                                              "Occupation","Sampling Method",
                                              "SES","Ethnicity","Religious"),
                                   levels = c("Gender","Age","Recruitment_Method",
                                              "Recruitment_Area","Educational_Attainment",
                                              "Occupation","Sampling_Method",
                                              "SES","Ethnicity","Religious")))
```

### Visualize subjects information reported situations in Chinese journals

```{r}
Fig_Journal_report <- ggplot(Journal_report,aes(col_names,proportion,fill=Var1))+
  geom_col()+
  labs(x="",y="%")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  scale_fill_manual(values = c("#00BFC4","#B2B2B2"))

Fig_Journal_report

ggsave("Fig_Journal_report.pdf", Fig_Journal_report, device = "pdf", width=16, height = 9)

## Here, I remove some data sets to reduce data set clutter.
rm(report_list,report_table,i,Journal_education_occupation,Journal_education_occupation_table)
```

### Specific reports on some demographic categories

```{r}
Journal_age_report_detail <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Age,M_age,SD_age,Other_age) %>%
  dplyr::filter(Age == 1)

### Age report studies num
Journal_age_report_detail_study_num <- Journal_age_report_detail %>%
    dplyr::distinct(Article_IDs,Study_Number) ## 989 studies
  
### Age fuzzy report studies num
Journal_age_fuzzy_report <- Journal_age_report_detail %>% 
  dplyr::filter(is.na(M_age)) 

## 20082227,20083017,20183340,20183097,20214027 Other age include Mage
##这里后面还需要重新处理一下部分Otherage包含Mage的情况

Journal_age_fuzzy_report_study_num <- Journal_age_fuzzy_report %>% 
  dplyr::distinct(Article_IDs,Study_Number) ## 130-5=125

## Here, I remove some data sets to reduce data set clutter.
rm(Journal_age_report_detail,Journal_age_report_detail_study_num,
   Journal_age_fuzzy_report,Journal_age_fuzzy_report_study_num)
```

In this section, I began by testing and analyzing three main hypotheses.

# Test three hypotheses

## Test the 1st hypothesis

### Gender

Process gender data from Chinese journals.

```{r warning=FALSE}
## Filter for information-rich key variables
Journal_key_variable <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group_N,
                Sample_Size,Target_Population_N,Sample_Type_N,
                Gender,Male_Num,Female_Num,Age,M_age,SD_age,Other_age,
                Subjects_Recruitment_Area,Remark1,Remark2,Remark3)

# names(Journal_key_variable)

## Filter gender related variables
Journal_gender <- Journal_key_variable %>% 
  dplyr::select(-c(10:17)) %>% 
  dplyr::filter(Gender == 1)

## Part of the gender data is the proportion recorded, and part is the number of people, so I deal with it separately.

Journal_gender_decimal <- Journal_gender %>% 
  dplyr::filter(Male_Num < 1 & Female_Num < 1)

Journal_gender_integer <- Journal_gender %>%
  dplyr::filter(Male_Num > 1 | Female_Num > 1) %>% 
  dplyr::mutate_at(vars(4:9),as.numeric)

## Multiple groups of data are removed during processing, so re-create the data.frame and then merge them.
Journal_gender_integer_add <- data.frame(Article_IDs = c("20185082","20213045","20213048","20213048"),
                                         Study_Number = c("1","1","1","2"),
                                         Subjects_Group_N = NA,
                                         Sample_Size = c(33,81,68,59),
                                         Target_Population_N = c(1,1,3,3),
                                         Sample_Type_N = c(3,5,5,5),
                                         Gender = 1,
                                         Male_Num = c(26,49,31,28),
                                         Female_Num = c(7,32,37,31))

Journal_gender_integer2 <- bind_rows(Journal_gender_integer,Journal_gender_integer_add) 

## Process decimal
Journal_gender_decimal2 <- Journal_gender_decimal %>% 
  dplyr::mutate_at(vars(4:9),as.numeric) %>%
  dplyr::mutate(Male_Num = floor(Sample_Size*Male_Num),
                Female_Num = Sample_Size - Male_Num)

## Combining journal gender data for both categories
Journal_gender2 <- bind_rows(Journal_gender_integer2,Journal_gender_decimal2)%>% 
  dplyr::filter(!is.na(Male_Num)) 

## total
Target_population_total_gender <- Journal_gender2 %>% 
  dplyr::summarise(Male_Num = sum(Male_Num,na.rm = TRUE),
                   Female_Num = sum(Female_Num,na.rm = TRUE),
                   Male_Proportion = round(Male_Num/(Male_Num + Female_Num),2)*100,
                   Female_Proportion = round(Female_Num/(Male_Num + Female_Num),2)*100,
                   Data_Source = "Target_population_total")

## general
Target_population_general_gender <- Journal_gender2 %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::summarise(Male_Num = sum(Male_Num,na.rm = TRUE),
                   Female_Num = sum(Female_Num,na.rm = TRUE),
                   Male_Proportion = round(Male_Num/(Male_Num + Female_Num),2)*100,
                   Female_Proportion = round(Female_Num/(Male_Num + Female_Num),2)*100,
                   Data_Source = "Target_population_general")

## special
Target_population_special_gender <- Journal_gender2 %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::summarise(Male_Num = sum(Male_Num,na.rm = TRUE),
                   Female_Num = sum(Female_Num,na.rm = TRUE),
                   Male_Proportion = round(Male_Num/(Male_Num + Female_Num),2)*100,
                   Female_Proportion = round(Female_Num/(Male_Num + Female_Num),2)*100,
                   Data_Source = "Target_population_special")

## target population is special and sample type is 23. 
Target_population_special_sampletype23_gender <- Journal_gender2 %>% 
  dplyr::filter(Target_Population_N == 1) %>%
  dplyr::filter(grepl("2",Sample_Type_N) | grepl("3",Sample_Type_N)) %>% 
  dplyr::summarise(Male_Num = sum(Male_Num,na.rm = TRUE),
                   Female_Num = sum(Female_Num,na.rm = TRUE),
                   Male_Proportion = round(Male_Num/(Male_Num + Female_Num),2)*100,
                   Female_Proportion = round(Female_Num/(Male_Num + Female_Num),2)*100,
                   Data_Source = "Target_population_special")

Journal_gender_different_categories <- bind_rows(Target_population_total_gender,Target_population_general_gender,
          Target_population_special_gender,Target_population_special_sampletype23_gender) 
```

Here, I remove some data sets to reduce data set clutter.

```{r}
rm(Journal_gender_decimal,Journal_gender_decimal2,
   Journal_gender_integer,Journal_gender_integer2,
   Journal_gender_integer_add,Journal_gender)
```

Process gender data from BTS.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
BTS_gender_list <- list()

for(i in seq_along(BTS)) {
  
  BTS_name <- names(BTS)[i] 
  
 if ("Gender" %in% names(BTS[[i]])) {  
   
  BTS_gender <- BTS[[i]] %>% 
    dplyr::mutate(Gender = str_to_title(Gender)) %>% 
    dplyr::filter(Gender == "Female" | Gender == "Male") %>% 
    dplyr::mutate(Data_Source =  BTS_name)
  
  BTS_gender_list[[BTS_name]] <- BTS_gender
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Gender' column.\n", BTS_name))  
  } 

}
```

Combine gender data from Chinese Journal and BTS.

```{r}
## Extracting Chinese data
BTS_gender_CHN <- lapply(BTS_gender_list, function(df){
  
  df %>% 
    dplyr::filter(grepl("CHN", ISO3, ignore.case = TRUE)) %>% 
    dplyr::select(ISO3,Data_Source,Gender) 

})

BTS_gender_CHN <- do.call(rbind, BTS_gender_CHN) %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n),2)*100) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate(Data_Source = "BTS Chinese")
  
## Combine CHN journal data and set factor
H1_gender <- BTS_gender_CHN %>% 
  dplyr::add_row(Gender = c("Female","Male"), n = c(273804,234047),
                 Proportion = c(54,46),Data_Source = "Journal")

H1_gender_factor <- H1_gender %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Data_Source)

H1_gender <- H1_gender %>% 
  dplyr::mutate(Data_Source = factor(Data_Source,
                                     levels = H1_gender_factor))
```

Visualize gender data for Chinese journals and BTS.

```{r}
H1_Fig_gender <- ggplot(data = H1_gender,aes(Data_Source,Proportion,fill = Gender))+
  geom_col()+
  geom_hline(yintercept = 50, linetype = "dashed", color = "#666666")+
  labs(y="Proportion")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))

H1_Fig_gender 
```

Here I tested whether the gender proportion distribution from Chinese five journal data are similar to that of the BTS data. I used Bayesian multinomial test (Bayesian goodness-of-fit test) to examine whether the observed (BTS data) fit the expected (Chinese five journal data).

$H_0$: $\theta = c$, where $c$ is defined by Chinese five journal data; $H_1$: $\theta$ is free to vary.

```{r}
H1_gender_bayes <- H1_gender %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

H1_BF_gender <- BayesMultiNomial(dataset = H1_gender_bayes,
                                             factor = "Gender",
                                             observed = "BTS Chinese",
                                             expected = "Journal") 

## Meanwhile, I calculate bayes factor based on target population
H1_gender_general_bayes <- H1_gender %>% 
  dplyr::add_row(Gender = c("Female","Male"),
                n = c(55366,45480),
                Proportion = c(55,45),
                Data_Source = "Journal general Population") %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)


H1_BF_gender_general <- BayesMultiNomial(dataset = H1_gender_general_bayes,
                                         factor = "Gender",
                                         observed = "BTS Chinese",
                                         expected = "Journal general Population")

```

I found moderate evidence for the $H_1$ that the gender proportion from Chinese five journal data is different from that of BTS data, with $Log(BF_{10})$ = `r H1_BF_gender$BF$LogBF10`.

However, I found there no different between BTS data and the general population of Chinese five journal data, with $Log(BF_{10})$ = `r H1_BF_gender_general$BF$LogBF10`.

At the end of gender data processing for hypothesis 1, I removed some data sets to reduce data set clutter.

```{r}
rm(BTS_gender_CHN,H1_gender_bayes,H1_gender_factor,i,BTS_data_name)
```

### Age

Reprocess age data from Chinese journals.

```{r warning=FALSE}
Journal_age <- Journal_key_variable %>% 
  dplyr::select(-c(7:9,14:17)) %>% 
  dplyr::filter(Age == 1 & !is.na(Sample_Size)) %>% 
  dplyr::filter(!is.na(M_age) & !is.na(SD_age))


## Filter M_age have multiple group data
Journal_strings_age <- Journal_age %>% 
  dplyr::filter(grepl(";|:|：|,",M_age)) %>% 
  dplyr::mutate(M_age = gsub("[;；]",";",M_age),
                SD_age = gsub("[;；]",";",SD_age)) %>% 
  tidyr::separate_rows(c(M_age,SD_age),sep = ";") %>% 
  dplyr::mutate(M_age = str_extract(M_age,"\\d+\\.\\d+|\\d+"),
                SD_age = str_extract(SD_age,"\\d+\\.\\d+|\\d+")) %>% 
  dplyr::slice(1:39,46:60) %>% 
  dplyr::mutate(Sample_Size = c(8,9,201,201,380,380,109,109,258,258,199,346,404,341,
                                166,265,174,35,30,25,24,30,31,30,30,29,30,15,11,
                                9,17,30,30,280,280,106,106,572,572,821,748,102,116,
                                62,68,213,192,14,19,27,27,27,169,135)) %>% 
  dplyr::mutate_at(vars(4:9),as.numeric)


Journal_strings_age$M_age[40:41] <- c(15.36,16.35)

## Filter M_age only have single values data
Journal_single_age <- Journal_age %>% 
  dplyr::filter(!grepl(";|:|：|,",M_age)) %>% 
  dplyr::mutate_at(vars(4:9),as.numeric)


## Combining journal age data for both categories 
Journal_age2 <- bind_rows(Journal_strings_age,Journal_single_age)
```

Since raw data is not available for papers in Chinese journals, I simulated the raw data using the method used in the Stges 1 of registration report. It is then combined with BTS and compared with census data.

First, I created a function that groups ages into five-year intervals for the purpose of creating a Population pyramid chart.

```{r}
Sim_Sens_mult_five <- function(Mean0, diff_age, SD0, sample_N=Sample_Size){

  
  ageData_five <-  c(pnorm(4, mean = Mean0, sd = SD0) * sample_N,
                 (pnorm(9, mean = Mean0, sd = SD0) - pnorm(4, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(14, mean = Mean0, sd = SD0) - pnorm(9, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(19, mean = Mean0, sd = SD0) - pnorm(14, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(24, mean = Mean0, sd = SD0) - pnorm(19, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(29, mean = Mean0, sd = SD0) - pnorm(24, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(34, mean = Mean0, sd = SD0) - pnorm(29, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(39, mean = Mean0, sd = SD0) - pnorm(34, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(44, mean = Mean0, sd = SD0) - pnorm(39, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(49, mean = Mean0, sd = SD0) - pnorm(44, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(54, mean = Mean0, sd = SD0) - pnorm(49, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(59, mean = Mean0, sd = SD0) - pnorm(54, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(64, mean = Mean0, sd = SD0) - pnorm(59, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(69, mean = Mean0, sd = SD0) - pnorm(64, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(74, mean = Mean0, sd = SD0) - pnorm(69, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(79, mean = Mean0, sd = SD0) - pnorm(74, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(84, mean = Mean0, sd = SD0) - pnorm(79, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(89, mean = Mean0, sd = SD0) - pnorm(84, mean = Mean0, sd = SD0)) *sample_N,
                 (pnorm(94, mean = Mean0, sd = SD0) - pnorm(89, mean = Mean0, sd = SD0)) *sample_N,
                 (1 - pnorm(94, mean = Mean0, sd = SD0)) * sample_N)
  
  
    # create a dataframe with ageData_five
  Sim_agefive_df <- setNames(data.frame(matrix(ncol = 2, nrow = 20)), c("ageBins", "sim1"))
  Sim_agefive_df$ageBins <- c("0~4","5~9","10~14","15~19","20~24",
                              "25~29","30~34","35~39","40~44","45~49",
                              "50~54","55~59","60~64","65~69","70~74",
                              "75~79","80~84","85~89", "90~94",">=95")
  Sim_agefive_df$sim1[1:20] <- ageData_five
  

  return(Sim_agefive_df)
}


## Use simulation function to process data.
Sim_Journal_age_five1 <- lapply(1:nrow(Journal_age2),function(i){
  
  Sim_Sens_mult_five(Mean0 = Journal_age2$M_age[i],
                diff_age = 0,
                SD0 = Journal_age2$SD_age[i],
                sample_N = Journal_age2$Sample_Size[i])
  
  })


Sim_Journal_age_five2 <- do.call(rbind,Sim_Journal_age_five1)


Sim_Journal_age_five3 <- Sim_Journal_age_five2 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                           "25~29","30~34","35~39","40~44","45~49",
                                           "50~54","55~59","60~64","65~69","70~74",
                                           "75~79","80~84","85~89", "90~94",">=95")))


## Calculate the sample difference between the coded data and the simulated data
sum(Journal_age2$Sample_Size)-sum(Sim_Journal_age_five3$sim1,na.rm = TRUE) 
```

I then continued to use the same steps to divide age into psychological developmental stages.

```{r}
Sim_Sens_mult_PsyStages <- function(Mean1, diff_age, SD1, sample_N=Sample_Size){
  
  
  ageData_PsyStages <-  c(pnorm(17, mean = Mean1, sd = SD1) * sample_N,
                          (pnorm(26, mean = Mean1, sd = SD1) - pnorm(17, mean = Mean1, sd = SD1)) *sample_N,
                          (pnorm(41, mean = Mean1, sd = SD1) - pnorm(26, mean = Mean1, sd = SD1)) *sample_N,
                          (pnorm(60, mean = Mean1, sd = SD1) - pnorm(41, mean = Mean1, sd = SD1)) *sample_N,
                          (1 - pnorm(60, mean = Mean1, sd = SD1)) * sample_N)
  
    
  # create a dataframe with ageData_PsyStages
  Sim_agePsyStages_df <- setNames(data.frame(matrix(ncol = 2, nrow = 5)), c("ageBins", "sim1"))
  Sim_agePsyStages_df$ageBins <- c("<=17", "18~25", "26~40", "41~60", ">=61")
  Sim_agePsyStages_df$sim1[1:5] <- ageData_PsyStages
  

  return(Sim_agePsyStages_df)
}


## Use simulation function to process data. 
Sim_Journal_age_PsyStages1 <- lapply(1:nrow(Journal_age2),function(i){
  
  Sim_Sens_mult_PsyStages(Mean1 = Journal_age2$M_age[i],
                diff_age = 0,
                SD1 = Journal_age2$SD_age[i],
                sample_N = Journal_age2$Sample_Size[i])
  
  })


Sim_Journal_age_PsyStages2 <- do.call(rbind,Sim_Journal_age_PsyStages1)


Sim_Journal_age_PsyStages3 <- Sim_Journal_age_PsyStages2 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=17","18~25", "26~40", "41~60", ">=61")))


## Calculate the sample difference between the coded data and the simulated data
sum(Journal_age2$Sample_Size)-sum(Sim_Journal_age_PsyStages3$sim1,na.rm = TRUE)
```

Meanwhile, I created func to process age data simulation in 10-year-old segment.

```{r}
Sim_Sens_mult_interval10 <- function(Mean2, diff_age2, SD2, sample_N2=Sample_Size){

  
  # 0~10, 11~20, 21~30, 31~40, 41~50, 51~60, 61~
  ageData_interval10 <-  c(pnorm(10, mean = Mean2, sd = SD2) * sample_N2,
                           (pnorm(21, mean = Mean2, sd = SD2) - pnorm(10, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(31, mean = Mean2, sd = SD2) - pnorm(21, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(41, mean = Mean2, sd = SD2) - pnorm(31, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(51, mean = Mean2, sd = SD2) - pnorm(41, mean = Mean2, sd = SD2)) *sample_N2,
                           (pnorm(61, mean = Mean2, sd = SD2) - pnorm(51, mean = Mean2, sd = SD2)) *sample_N2,
                           (1 - pnorm(61, mean = Mean2, sd = SD2)) * sample_N2  
)
  
  
    # create a dataframe with ageData1 and ageData2:
  Sim_ageinterval10_df <- setNames(data.frame(matrix(ncol = 2, nrow = 7)), c("ageBins", "sim1"))
  Sim_ageinterval10_df$ageBins <- c("<=10", "11~20", "21~30", "31~40", "41~50", "51~60", ">=61")
  Sim_ageinterval10_df$sim1[1:7] <- ageData_interval10
  
  
  return(Sim_ageinterval10_df)
}


Sim_Journal_age_interval101 <- lapply(1:nrow(Journal_age2),function(i){
  
  Sim_Sens_mult_interval10(Mean2 = Journal_age2$M_age[i],
                diff_age2 = 0,
                SD2 = Journal_age2$SD_age[i],
                sample_N2 = Journal_age2$Sample_Size[i])
  
  })


Sim_Journal_age_interval102 <- do.call(rbind,Sim_Journal_age_interval101)


## Use simulation function to process data. 
Sim_Journal_age_interval103 <- Sim_Journal_age_interval102 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=10", "11~20", "21~30", 
                                           "31~40", "41~50", "51~60", ">=61")))
  


## Calculate the sample difference between the coded data and the simulated data
sum(Journal_age2$Sample_Size)-sum(Sim_Journal_age_interval103$sim1,na.rm = TRUE)
```

In the following part, I will calculate other age data based on different target population.

The first is general population.

```{r}
## general target population
Target_general_population_age <-  Journal_age2 %>%
  dplyr::filter(Target_Population_N != 1)

## simulate different categories age data
### five-year-old
Sim_Journal_age_five1_general <- lapply(1:nrow(Target_general_population_age),function(i){
  
  Sim_Sens_mult_five(Mean0 = Target_general_population_age$M_age[i],
                diff_age = 0,
                SD0 = Target_general_population_age$SD_age[i],
                sample_N = Target_general_population_age$Sample_Size[i])
  
  })


Sim_Journal_age_five2_general <- do.call(rbind,Sim_Journal_age_five1_general)


Sim_Journal_age_five3_general <- Sim_Journal_age_five2_general %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                           "25~29","30~34","35~39","40~44","45~49",
                                           "50~54","55~59","60~64","65~69","70~74",
                                           "75~79","80~84","85~89", "90~94",">=95")))


## Calculate the sample difference between the coded data and the simulated data
sum(Target_general_population_age$Sample_Size)-sum(Sim_Journal_age_five3_general$sim1,na.rm = TRUE) 


## PsyStages
Sim_Journal_age_PsyStages1_general <- lapply(1:nrow(Target_general_population_age),function(i){
  
  Sim_Sens_mult_PsyStages(Mean1 = Target_general_population_age$M_age[i],
                diff_age = 0,
                SD1 = Target_general_population_age$SD_age[i],
                sample_N = Target_general_population_age$Sample_Size[i])
  
  })


Sim_Journal_age_PsyStages2_general <- do.call(rbind,Sim_Journal_age_PsyStages1_general)


Sim_Journal_age_PsyStages3_general <- Sim_Journal_age_PsyStages2_general %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=17","18~25", "26~40", "41~60", ">=61")))


## Calculate the sample difference between the coded data and the simulated data
sum(Target_general_population_age$Sample_Size)-sum(Sim_Journal_age_PsyStages3_general$sim1,na.rm = TRUE)


## interval10
Sim_Journal_age_interval101_general <- lapply(1:nrow(Target_general_population_age),function(i){
  
  Sim_Sens_mult_interval10(Mean2 = Target_general_population_age$M_age[i],
                diff_age2 = 0,
                SD2 = Target_general_population_age$SD_age[i],
                sample_N2 = Target_general_population_age$Sample_Size[i])
  
  })


Sim_Journal_age_interval102_general <- do.call(rbind,Sim_Journal_age_interval101_general)


## Use simulation function to process data. 
Sim_Journal_age_interval103_general <- Sim_Journal_age_interval102_general %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=10", "11~20", "21~30", 
                                           "31~40", "41~50", "51~60", ">=61")))
  


## Calculate the sample difference between the coded data and the simulated data
sum(Target_general_population_age$Sample_Size)-sum(Sim_Journal_age_interval103_general$sim1,na.rm = TRUE)
```

The others is special target population

```{r}
Target_special_population_age <- Journal_age2 %>% 
  dplyr::filter(Target_Population_N == 1)


## simulate different categories age data
### five-year-old
Sim_Journal_age_five1_special <- lapply(1:nrow(Target_special_population_age),function(i){
  
  Sim_Sens_mult_five(Mean0 = Target_special_population_age$M_age[i],
                diff_age = 0,
                SD0 = Target_special_population_age$SD_age[i],
                sample_N = Target_special_population_age$Sample_Size[i])
  
  })


Sim_Journal_age_five2_special <- do.call(rbind,Sim_Journal_age_five1_special)


Sim_Journal_age_five3_special <- Sim_Journal_age_five2_special %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                           "25~29","30~34","35~39","40~44","45~49",
                                           "50~54","55~59","60~64","65~69","70~74",
                                           "75~79","80~84","85~89", "90~94",">=95")))


## Calculate the sample difference between the coded data and the simulated data
sum(Target_special_population_age$Sample_Size)-sum(Sim_Journal_age_five3_special$sim1,na.rm = TRUE) 


## PsyStages
Sim_Journal_age_PsyStages1_special <- lapply(1:nrow(Target_special_population_age),function(i){
  
  Sim_Sens_mult_PsyStages(Mean1 = Target_special_population_age$M_age[i],
                diff_age = 0,
                SD1 = Target_special_population_age$SD_age[i],
                sample_N = Target_special_population_age$Sample_Size[i])
  
  })


Sim_Journal_age_PsyStages2_special <- do.call(rbind,Sim_Journal_age_PsyStages1_special)


Sim_Journal_age_PsyStages3_special <- Sim_Journal_age_PsyStages2_special %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=17","18~25", "26~40", "41~60", ">=61")))


## Calculate the sample difference between the coded data and the simulated data
sum(Target_special_population_age$Sample_Size)-sum(Sim_Journal_age_PsyStages3_special$sim1,na.rm = TRUE)


## ten-years-old
Sim_Journal_age_interval101_special <- lapply(1:nrow(Target_special_population_age),function(i){
  
  Sim_Sens_mult_interval10(Mean2 = Target_special_population_age$M_age[i],
                diff_age2 = 0,
                SD2 = Target_special_population_age$SD_age[i],
                sample_N2 = Target_special_population_age$Sample_Size[i])
  
  })


Sim_Journal_age_interval102_special <- do.call(rbind,Sim_Journal_age_interval101_special)


## Use simulation function to process data. 
Sim_Journal_age_interval103_special <- Sim_Journal_age_interval102_special %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(sim1 = round(sum(sim1,na.rm = TRUE))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins =factor(ageBins,
                                levels = c("<=10", "11~20", "21~30", 
                                           "31~40", "41~50", "51~60", ">=61")))
  


## Calculate the sample difference between the coded data and the simulated data
sum(Target_special_population_age$Sample_Size)-sum(Sim_Journal_age_interval103_special$sim1,na.rm = TRUE)
```

And I calculated the proportion of age data for different segments to facilitate visualization and Bayesian calculation.

```{r}
## 5-old-years
Sim_Journal_age_five3_prop <- Sim_Journal_age_five3 %>% 
  dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_five3_prop$Proportion) ## 100.02

## PsyStages
Sim_Journal_age_PsyStages3_prop <- Sim_Journal_age_PsyStages3 %>% 
    dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_PsyStages3_prop$Proportion) ## 99.99

## interval10
Sim_Journal_age_interval103_prop <- Sim_Journal_age_interval103 %>% 
    dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_interval103_prop$Proportion) ## 100

## general population 5-old-years
Sim_Journal_age_five3_general_prop <- Sim_Journal_age_five3_general %>% 
  dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_five3_general_prop$Proportion) ## 99.98

## general population PsyStages
Sim_Journal_age_PsyStages3_general_prop <- Sim_Journal_age_PsyStages3_general %>% 
    dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

# sum(Sim_Journal_age_PsyStages3_general_prop$Proportion) ## 99.99

## general population interval10
Sim_Journal_age_interval103_general_prop <- Sim_Journal_age_interval103_general %>% 
    dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_interval103_general_prop$Proportion) ## 99.99

## special population 5-old-years
Sim_Journal_age_five3_special_prop <- Sim_Journal_age_five3_special %>% 
  dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_five3_special_prop$Proportion) ## 100.03

## special population PsyStages
Sim_Journal_age_PsyStages3_special_prop <- Sim_Journal_age_PsyStages3_special %>% 
    dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_PsyStages3_special_prop$Proportion) ## 100

## special population interval10
Sim_Journal_age_interval103_special_prop <- Sim_Journal_age_interval103_special %>% 
    dplyr::mutate(Proportion = round((sim1/sum(sim1))*100,2),
                Data_Source = "Journal")

## sum(Sim_Journal_age_interval103_special_prop$Proportion) ## 99.99
```

To reduce data set clutter, I removed some data sets during processing Journal age above.

```{r}
rm(Sim_Journal_age_five1,Sim_Journal_age_five2,Sim_Journal_age_five3,
   Sim_Journal_age_interval101,Sim_Journal_age_interval102,Sim_Journal_age_interval103,
   Sim_Journal_age_PsyStages1,Sim_Journal_age_PsyStages2,Sim_Journal_age_PsyStages3,
   Sim_Journal_age_five1_general,Sim_Journal_age_five2_general,Sim_Journal_age_five3_general,
   Sim_Journal_age_interval101_general,Sim_Journal_age_interval102_general,Sim_Journal_age_interval103_general,
   Sim_Journal_age_PsyStages1_general,Sim_Journal_age_PsyStages2_general,Sim_Journal_age_PsyStages3_general,
   Sim_Journal_age_five1_special,Sim_Journal_age_five2_special,Sim_Journal_age_five3_special,
   Sim_Journal_age_interval101_special,Sim_Journal_age_interval102_special,Sim_Journal_age_interval103_special,
   Sim_Journal_age_PsyStages1_special,Sim_Journal_age_PsyStages2_special,Sim_Journal_age_PsyStages3_special)
```

Process age data from BTS.

```{r}
BTS_age_list <- list()

for(i in seq_along(BTS)){
  
  BTS_name <- names(BTS)[i]
  
  if("Age" %in% names(BTS[[i]])){
    
    BTS_age <- BTS[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,ISO3) %>% 
      #dplyr::group_by(ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(-Inf,4.5,9.5,14.5,19.5,24.5,
                                           29.5,34.5,39.5,44.5,49.5,
                                           54.5,59.5,64.5,69.5,74.5,
                                           79.5,84.5,89.5,94.5,Inf),
                                labels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" ),
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
  
BTS_age_list[[BTS_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name))  
  } 
}

## merge data.frame in list
BTS_age <-  bind_rows(BTS_age_list)
```

Filter CHN age data from BTS, Combine BTS CHN data and Chinese journals data.

```{r}
BTS_age_CHN <- BTS_age %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Data_Source = "BTS Chinese")

## add 2 rows of ageBins without data
BTS_age_CHN_2rows <- data.frame(ageBins = c("0~4","5~9"),
                                n = 0,
                                Proportion = 0,
                                Data_Source = "BTS Chinese")

## combine 2 dataframe
H1_age <- Sim_Journal_age_five3_prop %>% 
  dplyr::rename(n = 2) %>% 
  dplyr::bind_rows(BTS_age_CHN,BTS_age_CHN_2rows)


## set ageBins as factor to plot
H1_age <- H1_age %>% 
  dplyr::mutate(ageBins = factor(ageBins,
                                 levels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
```

Visualize age data from Chinese journals and census7.

```{r}
H1_Fig_age <- ggplot(data= H1_age, aes(x=ageBins, y=ifelse(Data_Source=="BTS Chinese", -Proportion, Proportion),fill = Data_Source)) +
  geom_col(alpha=0.8, width = 1) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  scale_fill_manual(values = c("BTS Chinese" = "#619CFF", "Journal" = "#7CAE00")) +
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))


H1_Fig_age


H1_Fig_gender_age <- H1_Fig_gender + H1_Fig_age +
  plot_annotation(tag_levels = 'A')


ggsave("H1_Fig_gender_age.pdf", H1_Fig_gender_age, device = "pdf", width=18, height = 9)


H1_Fig_gender_age
```

Process age for Bayesian multinomial test. First of all, I processed BTS CHN age in psychological development stages.

```{r}
BTS_age_PsyStages_list <- list()

for(i in seq_along(BTS)){
  
  BTS_name <- names(BTS)[i]
  
  if("Age" %in% names(BTS[[i]])){
    
    BTS_age <- BTS[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,ISO3) %>% 
      #dplyr::group_by(ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(0, 17.5, 25.5, 40.5, 60.5, Inf),
                                labels = c("<=17","18~25","26~40", "41~60", ">=61"),
                                levels = c("<=17","18~25","26~40", "41~60", ">=61")))
  
BTS_age_PsyStages_list[[BTS_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name))  
  } 
}


## merge data.frame in list
BTS_age_PsyStages <-  do.call(rbind,BTS_age_PsyStages_list)
```

Secondly, I processed BTS CHN age in 10-year-old segment.

```{r}
BTS_age_interval10_list <- list()

for(i in seq_along(BTS)){
  
  BTS_name <- names(BTS)[i]
  
  if("Age" %in% names(BTS[[i]])){
    
    BTS_age <- BTS[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(0, 10.5, 20.5, 30.5, 40.5, 50.5, 60.5, Inf),
                                labels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"),
                                levels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61")))
  
BTS_age_interval10_list[[BTS_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_name))  
  } 
}


## merge data.frame in list
BTS_age_interval10 <-  do.call(rbind,BTS_age_interval10_list)
```

And then, I filtered BTS CHN data.

```{r}
## psychological development stages in BTS
BTS_age_PsyStages_CHN <- BTS_age_PsyStages %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(1,4) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Data_Source = "BTS CHN age")


## 10-year-old segment in BTS
BTS_age_interval10_CHN <- BTS_age_interval10 %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(1,4) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Data_Source = "BTS CHN age") 
```

Next, I Combined two CHN data to Bayesian multinomial test in two different classifications (PsyStages and 10-year-old). One is PsyStages.

```{r}
## all subjects
H1_PsyStages_bayes <- Sim_Journal_age_PsyStages3_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_PsyStages_CHN) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

  
H1_BF_PsyStages <- BayesMultiNomial(dataset = H1_PsyStages_bayes,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "Journal")

## general population 
H1_PsyStages_general_bayes <- Sim_Journal_age_PsyStages3_general_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_PsyStages_CHN) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

H1_BF_PsyStages_general <- BayesMultiNomial(dataset = H1_PsyStages_general_bayes ,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "Journal")

## special population
H1_PsyStages_special_bayes <- Sim_Journal_age_PsyStages3_special_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_PsyStages_CHN) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

H1_BF_PsyStages_special <- BayesMultiNomial(dataset = H1_PsyStages_special_bayes ,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "Journal")
```

The other is interval10.

```{r}
# all subjects
BTS_age_interval10_CHN2 <- BTS_age_interval10_CHN %>% 
  dplyr::add_row(ageBins = "<=10", n = 0, Proportion = 0, Data_Source = "BTS CHN age")


H1_interval10_bayes <- Sim_Journal_age_interval103_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_interval10_CHN2) %>%
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)


H1_BF_interval10 <- BayesMultiNomial(dataset = H1_interval10_bayes,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "Journal")

## general population 
H1_interval10_general_bayes <- Sim_Journal_age_interval103_general_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_interval10_CHN2) %>%
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)


H1_BF_interval10_general <- BayesMultiNomial(dataset = H1_interval10_general_bayes,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "Journal")

## special
## general population 
H1_interval10_special_bayes <- Sim_Journal_age_interval103_special_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_interval10_CHN2) %>%
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)


H1_BF_interval10_special <- BayesMultiNomial(dataset = H1_interval10_special_bayes,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "Journal")
```

When I divide the age into 10 years,we found strong evidence for the $H_1$ that the age distribution from BTS data is different from that of Chinese journal data, with $Log(BF_{10})$ = `r H1_BF_interval10$BF$LogBF10`.

When I divide age into stages of psychological development, I found strong evidence for the $H_1$ that the age distribution from BTS data is different from that of Chinese journal data, with $Log(BF_{10})$ = `r H1_BF_PsyStages$BF$LogBF10`.

For different target population, I compared general population for them firstly, I found strong evidence for $H_1$ that the age distribution from the Chinese subjects data of BTS data is different form the Chinese journals data, the Bayesian multinomial test shows $Log(BF_{10})$ = `r H1_BF_PsyStages_general$BF$LogBF10`.

Meanwhile, I found strong evidence support $H_1$ for another age category,the Bayesian multinomial test shows $Log(BF_{10})$ = `r H1_BF_interval10_general$BF$LogBF10`.

## Test the 2st hypothesis

For hypothesis 2, I first tried to analyze the data in general. I would then compare certain demographic characteristics of the Chinese subjects in studies (BTS and Chinese journals) with those corresponding to Census data or other representative large general social surveys (e.g., CFPS2018) based on the target population.

Firstly, I analyzed data in general.

### Gender

In this part, first of all, I processed gender data of the Census 7th data and the CFPS2018 data.

```{r}
## Process the gender data of census 7
Census7_gender <- df_census7 %>%
  dplyr::select(c(6,7)) %>%        
  dplyr::slice(c(6)) %>%
  dplyr::rename(Male=1, 
                Female=2) %>%
  dplyr::mutate(Data_Source = "Census7") %>%
  tidyr::pivot_longer(c(Male, Female), 
                      names_to = "Gender",
                      values_to = "Proportion") %>%
  dplyr::mutate(Proportion = round(as.numeric(Proportion), 0))

## Process the gender data of CFPS2018
CFPS2018_gender <- df_CFPS2018 %>%
  dplyr::rename(Gender = QA002) %>%
  dplyr::count(Gender) %>%
  dplyr::filter(!is.na(Gender)) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2) * 100,
                Data_Source = "CFPS2018",
                Gender= ifelse(Gender == 1, "Male", "Female")) %>%
  dplyr::select(Data_Source, Gender, Proportion)
```

Secondly, I converted data format and combined three data sources.

```{r}
## Convert H1_gender data format
H1_gender2 <- H1_gender %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2),
                Data_Source = "Chinese subjects pool") %>% 
  dplyr::ungroup()

## combine the gender data from three data source
H2_gender <-  bind_rows(Census7_gender,CFPS2018_gender,H1_gender2)
```

And then, I combined all Chinese gender data and visualized them.

```{r}
H2_Fig_gender <- ggplot(H2_gender,aes(Data_Source,Proportion,fill= Gender))+
  geom_col()+
  geom_hline(yintercept = 50, linetype = "dashed", color = "#666666")+
  labs(y="Proportion",x = "Data Source")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))


H2_Fig_gender

# ggsave("H2_fig_gender.pdf", H2_fig_gender, device = "pdf", width=18, height = 9)
```

Finally, I calculated the bayes factor for gender.

```{r}
H2_gender_bayes <- H2_gender %>% 
  dplyr::select(2,3,1) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion)

## total
H2_BF_gender_Census7 <- BayesMultiNomial(dataset = H2_gender_bayes,
                                          factor = "Gender",
                                          observed = "Chinese subjects pool",
                                          expected = "Census7")


H2_BF_gender_CFPS2018 <- BayesMultiNomial(dataset = H2_gender_bayes,
                                          factor = "Gender",
                                          observed = "Chinese subjects pool",
                                          expected = "CFPS2018")
## general population
## 这里还继续处理，后续可以等BTS的编码后完善，类似的涉及到目标人群的BTS数据时都应如此。
```

The calculation results show that there is no significant difference between the data in Chinese subjects pool and Census7 and CFPS2018, and the calculation results are $Log(BF_{10})$ = `r H2_BF_gender_Census7$BF$LogBF10` and $Log(BF_{10})$ = `r H2_BF_gender_CFPS2018$BF$LogBF10` respectively.

### Age

Similarly, for age data, I first processed the Census data and the CFPS2018 data.

```{r}
## Process age data of the census 6
Census6_age_five5 <- df_census6 %>% 
  dplyr::filter(row_number() %% 6 == 0) %>%
  dplyr::select(1,2,5) %>% 
  dplyr::rename(ageBins = 1, Proportion = 3) %>% 
  dplyr::mutate(Proportion = as.numeric(Proportion)) %>% 
  dplyr::mutate(ageBins = str_remove(ageBins, "岁")) %>%
  dplyr::mutate(ageBins = str_replace_all(ageBins, "-", "~")) %>%
  dplyr::slice(-21) 

Census6_age_five5$ageBins[20] <- ">=95"

Census6_age_five5 <- Census6_age_five5 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(Proportion = sum(Proportion)) %>% 
  dplyr::mutate(Data_Source = "Census6") %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(ageBins) %>% 
  dplyr::mutate(ageBins = factor(ageBins, 
                                 levels =c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
  
## Process age data of the census 7 
Census7_age_five5 <- df_census7 %>%
  dplyr::rename(ageBins = 1,Proportion = 5) %>% 
  dplyr::filter(str_detect(ageBins,"岁")) %>%
  dplyr::select(1,2,5) %>% 
  dplyr::mutate(Proportion = as.numeric(Proportion)) %>% 
  dplyr::mutate(ageBins = str_remove(ageBins, "岁")) %>%
  dplyr::mutate(ageBins = str_replace_all(ageBins, "-", "~")) %>% 
  dplyr::slice(-21)

Census7_age_five5$ageBins[20] <- ">=95" 
Census7_age_five5$Proportion[20] <- 0.06+0.01


Census7_age_five5 <- Census7_age_five5 %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(Proportion = sum(Proportion)) %>% 
  dplyr::mutate(Data_Source = "Census7") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins = factor(ageBins, 
                                 levels =c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
```


Then, I convert the data format of H1_age.
```{r}
H2_age <- H1_age %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2)) %>% 
  dplyr::ungroup()

# sum(H2_age$Proportion) ## 99.99
```

Finally, I visualized all Chinese age data and combined figure of gender and age.

```{r}
H2_Fig_age <- ggplot(data= Census7_age_five5, 
       aes(x=ageBins, y = Proportion, fill="Census7")) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = H2_age, aes(x=ageBins, 
                y = Proportion,group = 1,color = "Chinese Subjects pool"),size =1)+
  scale_fill_manual(values=c("Census7"="#00BFC4")) +  
  scale_color_manual(values=c("Chinese Subjects pool" = "red")) +
  scale_y_continuous(limits = c(0,35))+
  coord_flip() +
  labs(y="Proportion", x = "Age bins")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))


H2_Fig_age


H2_Fig_gender_age <- H2_Fig_gender + H2_Fig_age +
  plot_annotation(tag_levels = 'A')


ggsave("H2_Fig_gender_age.pdf", H2_Fig_gender_age, device = "pdf", width=18, height = 9)


H2_Fig_gender_age
```

In addition, I calculated the bayes factor.

```{r}
##凡是BTS数据完善后涉及到合并Journal和BTS的都需要重新替换数据。切记切记！！！！！
# Firstly, I process Census data for the following analysis.
## process census data.
Census7_age <- df_census7 %>%
  dplyr::rename(ageBins = 1, n = 2, Proportion = 5) %>% 
  dplyr::slice(9:145) %>% 
  dplyr::filter(ageBins != "" & !grepl("岁",ageBins)) %>% 
  dplyr::select(1:2,5) %>% 
  dplyr::mutate_at(vars(1:3),as.numeric)

## PsyStages
Census7_age_PsyStages <- Census7_age %>% 
  dplyr::mutate(ageBins = cut(ageBins,
                                breaks = c(-Inf, 17.5, 25.5, 40.5, 60.5, Inf),
                                labels = c("<=17","18~25","26~40", "41~60", ">=61"),
                                levels = c("<=17","18~25","26~40", "41~60", ">=61"))) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n),Proportion = sum(Proportion)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(n = ifelse(ageBins == ">61", n+118866,n),
                Proportion = ifelse(ageBins == ">61", Proportion + 0.01,Proportion),
                Data_Source = "Census7")

# sum(Census7_age_PsyStages$Proportion) #100.02

## interval10
Census7_age_interval10 <- Census7_age %>% 
  dplyr::mutate(ageBins = cut(ageBins,
                              breaks = c(-Inf, 10.5, 20.5, 30.5, 40.5, 50.5, 60.5, Inf),
                              labels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"),
                              levels = c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"))) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n),Proportion = sum(Proportion)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(n = ifelse(ageBins == ">61", n+118866,n),
                Proportion = ifelse(ageBins == ">61", Proportion + 0.01,Proportion),
                Data_Source = "Census7")

# Then, I calculate bayes factor, for a start, I calculate it in total.
## PsyStages
H2_age_PsyStages_bayes <- bind_rows(Census7_age_PsyStages,Sim_Journal_age_PsyStages3_prop) %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion) %>% 
  dplyr::rename('Chinese subjects pool' = 3)

H2_BF_age_PsyStages <- BayesMultiNomial(dataset = H2_age_PsyStages_bayes,
                                        factor = "ageBins",
                                        observed = "Chinese subjects pool",
                                        expected = "Census7")

## interval10
H2_age_interval10_bayes <- bind_rows(Census7_age_interval10,Sim_Journal_age_interval103_prop) %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion) %>% 
  dplyr::rename('Chinese subjects pool' = 3)

H2_BF_age_interval10 <- BayesMultiNomial(dataset = H2_age_interval10_bayes,
                                        factor = "ageBins",
                                        observed = "Chinese subjects pool",
                                        expected = "Census7")
  

## Next, For target population, I need combine two source data firstly.
## PsySatges
Sim_Journal_age_PsyStages3_general_prop <- Sim_Journal_age_PsyStages3_general_prop %>% 
  dplyr::rename(n =2)


H2_age_Psystages_general_bayes <- bind_rows(BTS_age_PsyStages_CHN,Sim_Journal_age_PsyStages3_general_prop) %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2),
                Data_Source = "Chinese subjects pool") %>% # sum(H2_age_general_bayes$Proportion) ## 100.01
  dplyr::add_row(Census7_age_PsyStages) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion)
  
## interval10
Sim_Journal_age_interval103_general_prop <-  Sim_Journal_age_interval103_general_prop %>% 
  dplyr::rename(n = 2)

H2_age_inteval10_general_bayes <- bind_rows(BTS_age_interval10_CHN2,Sim_Journal_age_interval103_general_prop) %>% 
  dplyr::select(1:2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2),
                Data_Source = "Chinese subjects pool") %>% # sum(H2_age_general_bayes$Proportion) ## 100.01
  dplyr::add_row(Census7_age_interval10) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = Proportion)

## calculate bayes factor
H2_BF_age_Psystages_general <- BayesMultiNomial(dataset = H2_age_Psystages_general_bayes,
                              factor = "ageBins",
                              observed = "Chinese subjects pool",
                              expected = "Census7")


H2_BF_age_interval10_general <- BayesMultiNomial(dataset = H2_age_inteval10_general_bayes,
                              factor = "ageBins",
                              observed = "Chinese subjects pool",
                              expected = "Census7")
```

For age of H2, firstly, in total, I found two age categories both have strong evidence for $H_1$ that the age distribution of Chinese subjects pool are different from Census7. The Bayesian multinomial test are PsyStages: $Log(BF_{10})$ = `r H2_BF_age_PsyStages$BF$LogBF10` and interval10: $Log(BF_{10})$ = `r H2_BF_age_interval10$BF$LogBF10` respectively.

Then, I also found the Bayesian multinomial test shows strong evidence for comparing them in general population. PsyStages and interval10 are $Log(BF_{10})$ = `r H2_BF_age_Psystages_general$BF$LogBF10` and interval10: $Log(BF_{10})$ = `r H2_BF_age_interval10_general$BF$LogBF10` respectively.

### Region

As stated in RR stage1, I tried to analysis region data. As a first step, I processed Subjects_Recruitment_Area data from Chinese journals. 

All the data containing the region is processed.

```{r}
## single region
Journal_region_single <- Journal %>% 
  dplyr::select(3,5,7,37,40,16,30) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = gsub("[;；、，,]",";",Subjects_Recruitment_Area),
                Sample_Size = as.numeric(Sample_Size)) %>% 
  dplyr::filter(Subjects_Recruitment_Area != "0" & !grepl(";",Subjects_Recruitment_Area)) 


# sum(Journal_region_single$Sample_Size,na.rm = TRUE)+33
# 
# table(Journal_region_single$Subjects_Recruitment_Area)


Journal_region_single_tab <- Journal_region_single %>% 
  dplyr::select(Article_IDs,Target_Population_N,Sample_Size,Subjects_Recruitment_Area) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == "内蒙古自治区", "内蒙古",Subjects_Recruitment_Area),
                Sample_Size = ifelse(Article_IDs == "20185082",33,Sample_Size)) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(n = sum(Sample_Size)) %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% c("新疆","西藏","甘肃","青海","内蒙古",
                                                 "宁夏","四川","重庆","陕西","贵州","云南",
                                                 "北京","山西","河北","河南","湖北","湖南",
                                                 "广西","广东","香港","澳门","台湾","海南",
                                                 "黑龙江","吉林","辽宁","天津","山东","江苏",
                                                 "安徽","上海","浙江","江西","福建"))
  

## multiple regions
Journal_region_multiple <- Journal %>% 
  dplyr::select(3,5,7,37,40,16,30) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = gsub("[;；、，,]",";",Subjects_Recruitment_Area)) %>% 
  dplyr::filter(Subjects_Recruitment_Area != "0" & grepl(";",Subjects_Recruitment_Area)) 

# writexl::write_xlsx(Journal_region_multiple,"Journal_region_multiple.xlsx")

## re-input data and load dataa
Journal_region_multiple <- readxl::read_xlsx("Journal_region_multiple.xlsx") %>% 
  dplyr::filter(True_Value != "No specific value") 

Journal_region_multiple_tab <-  Journal_region_multiple %>% 
  dplyr::select(Article_IDs, Target_Population_N,True_Value) %>% 
  tidyr::separate_rows(True_Value,sep = ";") %>% 
  tidyr::separate(True_Value,c("Subjects_Recruitment_Area","Sample_Size"),sep = ":") %>% 
   dplyr::filter(Subjects_Recruitment_Area %in% c("新疆","西藏","甘肃","青海","内蒙古",
                                                 "宁夏","四川","重庆","陕西","贵州","云南",
                                                 "北京","山西","河北","河南","湖北","湖南",
                                                 "广西","广东","香港","澳门","台湾","海南",
                                                 "黑龙江","吉林","辽宁","天津","山东","江苏",
                                                 "安徽","上海","浙江","江西","福建")) %>% 
  dplyr::mutate(Sample_Size  = as.numeric(Sample_Size),
                Sample_Size = ifelse(Article_IDs == "20213104",ceiling(Sample_Size*2500),Sample_Size)) %>% 
  dplyr::select(Sample_Size,Subjects_Recruitment_Area) %>% 
  dplyr::rename(n = Sample_Size)


## combine data
Journal_region_tab <-bind_rows(Journal_region_single_tab,Journal_region_multiple_tab) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(n = sum(n),.groups = "drop") %>% 
  dplyr::mutate(Proportion = (round(n/sum(n),2))*100)


# sum(Journal_region_tab$Proportion) ## 1.01

# names(Journal)

Journal_region_tab2 <- Journal_region_tab %>% 
  dplyr::mutate(Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal_region_total")%>% 
  dplyr::rename(Region = 1)

# sum(Journal_region_tab2$n) 290,585
```


The data is processed when the target population is the general population.
```{r}
## single region
Journal_region_single_general <- Journal_region_single %>% 
  dplyr::filter(Target_Population_N != 1)

Journal_region_single_general_tab <- Journal_region_single_general %>% 
  dplyr::select(Article_IDs,Target_Population_N,Sample_Size,Subjects_Recruitment_Area) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == "内蒙古自治区", "内蒙古",Subjects_Recruitment_Area)) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(n = sum(Sample_Size)) %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% c("新疆","西藏","甘肃","青海","内蒙古",
                                                 "宁夏","四川","重庆","陕西","贵州","云南",
                                                 "北京","山西","河北","河南","湖北","湖南",
                                                 "广西","广东","香港","澳门","台湾","海南",
                                                 "黑龙江","吉林","辽宁","天津","山东","江苏",
                                                 "安徽","上海","浙江","江西","福建"))

## multiple regions
Journal_region_multiple_general <- Journal_region_multiple %>% 
  dplyr::filter(Target_Population_N != 1)


Journal_region_multiple_general_tab <-  Journal_region_multiple_general %>% 
  dplyr::select(Article_IDs, Target_Population_N,True_Value) %>% 
  tidyr::separate_rows(True_Value,sep = ";") %>% 
  tidyr::separate(True_Value,c("Subjects_Recruitment_Area","Sample_Size"),sep = ":") %>% 
   dplyr::filter(Subjects_Recruitment_Area %in% c("新疆","西藏","甘肃","青海","内蒙古",
                                                 "宁夏","四川","重庆","陕西","贵州","云南",
                                                 "北京","山西","河北","河南","湖北","湖南",
                                                 "广西","广东","香港","澳门","台湾","海南",
                                                 "黑龙江","吉林","辽宁","天津","山东","江苏",
                                                 "安徽","上海","浙江","江西","福建")) %>% 
  dplyr::mutate(Sample_Size  = as.numeric(Sample_Size),
                Sample_Size = ifelse(Article_IDs == "20213104",ceiling(Sample_Size*2500),Sample_Size)) %>% 
  dplyr::select(Sample_Size,Subjects_Recruitment_Area) %>% 
  dplyr::rename(n = Sample_Size)

## combine two data
Journal_region_general_tab <-bind_rows(Journal_region_single_general_tab,Journal_region_multiple_general_tab) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(n = sum(n),.groups = "drop") %>% 
  dplyr::mutate(Proportion = (round(n/sum(n),2))*100)

# sum(Journal_region_general_tab$Proportion) ## 100


Journal_region_general_tab2 <- Journal_region_general_tab %>% 
  dplyr::mutate(Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal_region_general_population")%>% 
  dplyr::rename(Region = 1)

# sum(Journal_region_general_tab2$n) 42,890
```


The second step, I processed of provincial distribution of population for census7.

```{r message=FALSE, warning=FALSE, include=FALSE}
Census7_region <- readxl::read_xls("A0101.xls") %>% 
  dplyr::select(1,5) %>% 
  dplyr::rename(Region = 1, n = 2) %>% 
  dplyr::filter(!is.na(Region)) %>% 
  dplyr::slice(-c(1:2)) %>% 
  dplyr::mutate(n = as.numeric(n))


Census7_3 <- data.frame(Region = c("台湾","香港","澳门"),n =c(23561236,7474200,683218))


Census7_region <- rbind(Census7_region,Census7_3) %>% 
  dplyr::mutate(Proportion = round((n / sum(n))*100,2)) %>% 
  dplyr::mutate(Count_Bins = cut(Proportion,
                                      breaks = c(-Inf,1,5,10,Inf),
                                      labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Census7")


Census7_region$Region <- gsub(" ", "", Census7_region$Region)  

# sum(Census7_region$n) 1,441,497,378
```

The third step, I processed of provincial distribution of population for CFPS2018.

```{r}
## process CFPS2018 province data
CFPS2018_region <- data.frame(table(df_CFPS2018$PROVCD18)) %>% 
  dplyr::rename(Region = 1,n=2) %>% 
  dplyr::mutate(Region = c("北京","天津","河北","山西","内蒙古","辽宁","吉林",
                             "黑龙江","上海","江苏","浙江","安徽","福建","江西",
                             "山东","河南","湖北","湖南","广东","广西","海南",
                             "重庆","四川","贵州","云南","西藏","陕西","甘肃",
                             "青海","宁夏","新疆")) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Count_Bins = cut(Proportion,
                                      breaks = c(-Inf,1,5,10,Inf),
                                      labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "CFPS2018")

# sum(CFPS2018_region$n) 37,104
```


Combine all region data and load color data

```{r}
## combine region data
Region_map_data <-  bind_rows(Census7_region,CFPS2018_region,
                              Journal_region_tab2,Journal_region_general_tab2)

## load color data
Region_map_color <- readxl::read_xlsx("colour.xlsx") %>% 
  dplyr::mutate(QUHUADAIMA = as.character(QUHUADAIMA)) %>% 
  dplyr::rename(Region = 1) %>% 
  dplyr::select(-2)

## combine color data and region data
Region_data <- dplyr::left_join(Region_map_data,Region_map_color,by = join_by(Region)) %>% 
  dplyr::mutate(QUHUADAIMA = ifelse(Region == "重庆", "500000", QUHUADAIMA),
                Color = ifelse(Count_Bins == "<1",1,
                               ifelse(Count_Bins == "1~5",2,
                                      ifelse(Count_Bins == "5~10",3,4))),
                Color = factor(Color, levels = c("1", "2", "3", "4"))) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = c(Proportion, Count_Bins,n,Color)) %>% 
  dplyr::mutate(across(3:ncol(.),~ifelse(is.na(.),0,.)))
```

Finally, I visualized geographic distribution and calculated Bayesian multinomial test for region.

```{r}
API_pre <-  "http://xzqh.mca.gov.cn/data/"
## 读取全国数据
China <-  st_read(dsn = paste0(API_pre, "quanguo.json"), stringsAsFactors=FALSE) 
## 使用 4326 地理坐标系
st_crs(China) <-  4326

# 读取国界线数据
China_line <-  st_read(dsn = paste0(API_pre, "quanguo_Line.geojson"), stringsAsFactors=FALSE) 
st_crs(China_line) <-  4326
## 选择区划代码为国界线的区域
gjx <- China_line[China_line$QUHUADAIMA == "guojiexian",]

China <- dplyr::left_join(China,Region_data,by= "QUHUADAIMA")



## Chinese journal papers in total
H2_Fig_region_total <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_region_total))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal subjects recruitment region distribution (290,585 subjects)") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.title = element_blank(),
        legend.position = c(0.2, 0.2),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())



## Chinese journal papers in general population
H2_Fig_region_general <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_region_general_population))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal general population region distribution (42,890 subjects)") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.title = element_blank(),
        legend.position = c(0.2, 0.2),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())

## census 7 
H2_Fig_CFPS2018_region <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_CFPS2018))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "CFPS2018 subjects recruitment region distribution (37,104 subjects)") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())


## CFPS 2018
H2_Fig_Census7_region <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Census7))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Census7 population region distribution (1,441,497,378 people)") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())



H2_region <- (H2_Fig_Census7_region + H2_Fig_CFPS2018_region)/( 
  H2_Fig_region_total + H2_Fig_region_general) +
  plot_layout(guides = "collect")+
  plot_annotation(tag_levels = 'A', title = "Area distribution",
                  theme = theme(plot.title = element_text(size = 24))) + 
  theme(plot.tag = element_text(size = 20))


ggsave("H2_region .pdf", H2_region , device = "pdf", width=18, height = 15)

H2_region 
```


## Visulize new region
```{r}
H2_Fig_Journal_region_new <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_region_new))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal actual subjects area distribution") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())

H2_Fig_Journal_region_new


H2_region2 <- H2_Fig_Census7_region + H2_Fig_CFPS2018_region + H2_Fig_Journal_region_new +
  plot_layout(guides = "collect")+
  plot_annotation(tag_levels = 'A', title = "Area distribution",
                  theme = theme(plot.title = element_text(size = 24))) + 
  theme(plot.tag = element_text(size = 20))


ggsave("H2_region2.pdf", H2_region2, device = "pdf", width=18, height = 15)

H2_region2 
```


```{r}
Journal_region_total <- Journal_region_total %>% 
  dplyr::mutate(Data_Source = "Journal")

## combine three source data
H2_region_bayes <- bind_rows(Journal_region_total,Journal_region_general,Journal_region_special,
                             Census7_region,CFPS2018_region) %>% 
  dplyr::select(1,3,5) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion) %>% 
  dplyr::mutate(across(everything(),~ifelse(is.na(.),1,.)))


H2_BF_Journal_Census7_region <- BayesMultiNomial(dataset = H2_region_bayes,
                                          factor = "Region",
                                          observed = "Journal",
                                          expected = "Census7")


H2_BF_Journal_CFPS2018_region <- BayesMultiNomial(dataset = H2_region_bayes,
                                          factor = "Region",
                                          observed = "Journal",
                                          expected = "CFPS2018")

## different target population compared
H2_BF_Journal_general_Census7_region <- BayesMultiNomial(dataset = H2_region_bayes,
                                          factor = "Region",
                                          observed = "Journal_general_population_region",
                                          expected = "Census7")

H2_BF_Journal_special_Census7_region <- BayesMultiNomial(dataset = H2_region_bayes,
                                          factor = "Region",
                                          observed = "Journal_special_population_region",
                                          expected = "Census7")
```


### Educational attainment

Try to process educational attainment data from Chinese journal.

```{r eval=FALSE, include=FALSE}
# Journal_edu <- Journal %>% 
#   dplyr::filter(Educational_Attainment_N == 1) %>% 
#   dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size,M_age,SD_age,
#                 Educational_Attainment_info_N) %>% 
#   dplyr::mutate(Higher_edu = NA,
#                 Below_higher_edu = NA,
#                 Compulsory_edu_above = NA,
#                 Compulsory_edu = NA ,
#                 M_edu_year = NA,
#                 SD_edu_year = NA)
# 
# writexl::write_xlsx(Journal_edu,"Journal_edu.xlsx")

Journal_edu2 <- readxl::read_xlsx("Journal_edu.xlsx")


## calculate the number of different categories 
Journal_edu2_tab <- Journal_edu2 %>% 
  dplyr::summarise(tab10 = sum(is.na(College_and_above)),
                   tab11 = sum(is.na(Below_college)),
                   tab12 = sum(is.na(High_school_and_above)),
                   tab13 = sum(is.na(Below_high_school)),
                   tab14 = sum(is.na(M_edu_year)),
                   tab15 = sum(is.na(SD_edu_year))) %>% 
  dplyr::select(1,3,5) %>% 
  dplyr::rename(Class_higher_edu = 1, ## 90/185
                Class_compulsory_edu = 2, ## 104/185
                Class_edu_year = 3)  ## 152/185
```


In our study, we have three categories of educational attainments. I process three class data respectively.
The first category is education years. I will use M and SD in the paper to simulate the number of subjects with the latter two categories of education level, and then combine them with the latter two categories respectively, and finally complete the subsequent analysis and visualization.
```{r}
Journal_edu2_year <- Journal_edu2 %>% 
  dplyr::select(1:15) %>% 
  dplyr::filter(!is.na(M_edu_year) & !is.na(SD_edu_year)) %>% 
  dplyr::filter(is.na(College_and_above))  ## If there is data for the other two categories, there is no need to simulate using years of education, which is a screening done after looking at the data
# sum(Journal_edu2_year$Sample_Size) ## 4662

## Simulation of education data based on normal distribution
College_threshold <- 15 ## The education years of college is set at 15
Highschool_threshold <- 12 ## The education years of high school is set at 15


## create a data.frame.
Journal_edu2_year_simul <- data.frame(Article_IDs = character(),
                      Study_Number = character(),
                      Subjects_Group = character(),
                      Sample_Size = integer(),
                      College_and_above = integer(),
                      Below_college = integer(),
                      High_school_and_above = integer(),
                      Below_high_school = integer())
 

# Calculate sample size for each educated stages
for (i in 1:nrow(Journal_edu2_year)) {
  Article_IDs = Journal_edu2_year$Article_IDs[i]
  Study_Number = Journal_edu2_year$Study_Number[i]
  Subjects_Group = Journal_edu2_year$Subjects_Group[i]
  Sample_Size <- Journal_edu2_year$Sample_Size[i] 
  M_edu_year <- Journal_edu2_year$M_edu_year[i]  
  SD_edu_year <- Journal_edu2_year$SD_edu_year[i] 
  
# Use the cumulative distribution function to calculate the proportion of subjects below each threshold
  Prob_college_and_above <- pnorm(College_threshold, mean = M_edu_year, sd = SD_edu_year, lower.tail = FALSE)
  Prob_highschool_and_above <- pnorm(Highschool_threshold, mean = M_edu_year, sd = SD_edu_year, lower.tail = FALSE)
  
#Count people by proportion.
  College_and_above_count <- round(Sample_Size * Prob_college_and_above)
  College_below_count <- Sample_Size - College_and_above_count
  Highschool_and_above_count <- round(Sample_Size * Prob_highschool_and_above)
  Highschool_below_count <- Sample_Size - Highschool_and_above_count
  

# Adds the result to the data.frame
Journal_edu2_year_simul <- rbind(Journal_edu2_year_simul, data.frame(Article_IDs = Article_IDs,
                                       Study_Number = Study_Number,
                                       Subjects_Group = Subjects_Group,
                                       Sample_Size = Sample_Size,
                                       College_and_above = College_and_above_count,
                                       Below_college = College_below_count,
                                       High_school_and_above = Highschool_and_above_count,
                                       Below_high_school = Highschool_below_count))
}
```


The second category is 'college and above' and 'below college'. 
```{r}
Journal_college <- Journal_edu2 %>% 
  dplyr::select(-c(5:9,12:15)) %>% 
  dplyr::filter(!is.na(College_and_above) & !is.na(Below_college))

##  both > 1
Journal_college_integer <- Journal_college  %>%
  dplyr::filter(College_and_above > 1 & Below_college > 1) %>%
  dplyr::summarise(College_and_above = sum(College_and_above),
                   Below_college = sum(Below_college)) ## sum 12,092
  

## both < 1
Journal_college_decimal <- Journal_college  %>%
  dplyr::filter(College_and_above <= 1 & Below_college <= 1) %>% 
  dplyr::mutate(Total_college_and_above = College_and_above + Below_college) %>% 
  dplyr::mutate(College_and_above_tab = floor(Sample_Size * College_and_above),
                Below_college_tab = ifelse(Total_college_and_above == 1, Sample_Size - College_and_above_tab, floor(Sample_Size * Below_college))) %>% 
  dplyr::mutate(tab = College_and_above_tab + Below_college_tab) %>% 
  dplyr::summarise(College_and_above = sum(College_and_above_tab),
                   Below_college = sum(Below_college_tab)) ## sum 9,315
```


The third category is 'high shcool and above' and 'below high school'
```{R}
Journal_high_school <- Journal_edu2 %>% 
  dplyr::select(4,12:13) %>% 
  dplyr::filter(!is.na(High_school_and_above) & !is.na(Below_high_school))

##  both > 1
Journal_high_school_integer <- Journal_high_school %>%
  dplyr::filter(High_school_and_above > 1 & Below_high_school > 1) %>%
  dplyr::summarise(High_school_and_above = sum(High_school_and_above),
                   Below_high_school = sum(Below_high_school)) ## sum 9,306
  
## both < 1
Journal_high_school_decimal <- Journal_high_school  %>%
  dplyr::filter(High_school_and_above <= 1 & Below_high_school <= 1) %>% 
  dplyr::mutate(Total_High_school = High_school_and_above + Below_high_school) %>% 
  dplyr::mutate(High_school_and_above_tab = floor(Sample_Size * High_school_and_above),
                Below_high_school_tab = ifelse(Total_High_school == 1, Sample_Size - High_school_and_above_tab, floor(Sample_Size * Below_high_school))) %>% 
  dplyr::mutate(tab = High_school_and_above_tab + Below_high_school_tab) %>% 
  dplyr::summarise(High_school_and_above = sum(High_school_and_above_tab),
                   Below_high_school = sum(Below_high_school_tab)) ## 4,685
```


Combine education year with the other categories respectively.
```{r}
Journal_edu2_year_simul_sum <- Journal_edu2_year_simul %>% 
  dplyr::summarise(College_and_above = sum(College_and_above),
                   Below_college = sum(Below_college),
                   High_school_and_above = sum(High_school_and_above),
                   Below_high_school = sum(Below_high_school))

## combine college data
Journal_college2 <- Journal_edu2_year_simul_sum %>% 
  dplyr::select(1:2) %>% 
  bind_rows(Journal_college_decimal, Journal_college_integer) %>% 
  dplyr::summarise(College_and_above = sum(College_and_above),
                   Below_college = sum(Below_college)) %>% 
  tidyr::pivot_longer(cols = c(College_and_above,Below_college),
                      names_to = "Educational_Attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = round(Num/sum(Num),2)*100)


## combine high school data
Journal_high_school2  <- Journal_edu2_year_simul_sum %>% 
  dplyr::select(3:4) %>% 
  bind_rows(Journal_high_school_integer, Journal_high_school_decimal) %>% 
  dplyr::summarise(High_school_and_above = sum(High_school_and_above),
                   Below_high_school = sum(Below_high_school)) %>% 
  tidyr::pivot_longer(cols = c(High_school_and_above,Below_high_school),
                      names_to = "Educational_Attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = round(Num/sum(Num),2)*100)
```


And visualization
```{r}
## college
H2_Fig_college <- ggplot(data = Journal_college2,aes(Educational_Attainment,Proportion,fill = Educational_Attainment,Proportion))+
  geom_col()+
  theme_classic()+
  xlab("Educational attainment (26,069 subjects)")+ ## 4662+12092+9315
  theme(legend.position = "none",    
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black"))

H2_Fig_college


## high school
H2_Fig_high_school <- ggplot(data = Journal_high_school2,aes(Educational_Attainment,Proportion,fill = Educational_Attainment,Proportion))+
  geom_col()+
  theme_classic()+
  xlab("Educational attainment (18,653 subjects)")+ ## 4662+9306+4685
  ylab("")+
  theme(legend.position = "none",    
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black"))

H2_Fig_high_school


H2_Fig_edu <- H2_Fig_college + H2_Fig_high_school +
   plot_annotation(tag_levels = "A")  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))


ggsave("H2_Fig_edu.pdf", H2_Fig_edu, device = "pdf", width=18, height = 9)


H2_Fig_edu
```

### Ethnicity

Try to analysis ethnicity data from Chinese journal

```{r}
Journal_ethnicity <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size,
                Ethnicity,Ethnicity_info) %>% 
  dplyr::filter(Ethnicity == 1) %>% 
  tidyr::separate_rows(Ethnicity_info,sep = ";") %>% 
  dplyr::filter(!grepl("少数|汉族|其他",Ethnicity_info))


#table(df_CHN_Ethnicity$Ethnicity) 1507~0, 63~1

Journal_ethnicity_tab <- data.frame(table(Journal_ethnicity$Ethnicity_info))

Journal_ethnicity_add <- c("土家族","回族","蒙古族","畲族","满族","苗族","壮族","黎族","彝族","布依族")

Journal_ethnicity_tab <- Journal_ethnicity_tab %>% 
  dplyr::mutate(Freq = ifelse(Var1 %in% Journal_ethnicity_add, Freq+1, Freq))


## sample size and different ethnicity
Journal_ethnicity$Sample_Size[2] <- 251
Journal_ethnicity$Sample_Size[3] <- 297
Journal_ethnicity$Sample_Size[4] <- 110
Journal_ethnicity$Sample_Size[5] <- 61

Journal_ethnicity$Sample_Size[6:21] <- c(14,16,18,9,20,10,18,12,19,10,
                                           19,12,17,15,21,13)

Journal_ethnicity$Sample_Size[32:33] <- c(4,0)

Journal_ethnicity$Sample_Size[34:62] <- c(139,108,71,51,50,40,38,31,
                                         27,24,18,16,16,11,9,6,5,4,
                                         3,3,3,2,2,1,1,1,1,1,1)

Journal_ethnicity$Sample_Size[63:64] <- c(30,60)

Journal_ethnicity$Sample_Size[65] <- 1006

Journal_ethnicity$Sample_Size[72] <- 30

## ethnicity sample size
Journal_ethnicity_group <- Journal_ethnicity %>% 
  dplyr::mutate(Sample_Size =as.numeric(Sample_Size)) %>% 
  dplyr::group_by(Ethnicity_info) %>% 
  dplyr::summarise(Sample = sum(Sample_Size)) %>% 
  dplyr::ungroup()


Journal_ethnicity_Articles_num <- Journal_ethnicity %>% 
  dplyr::distinct(Article_IDs)
### 17/997
```

## Test the 3st hypothesis

### Gender

As with the first two hypotheses, I dealt with gender data first.

```{r}
BTS_gender_allcountry <- lapply(BTS_gender_list, function(df){
  
  df %>% 
    dplyr::select(ISO3,Data_Source,Gender) 
  
})

BTS_gender_allcountry <- do.call(rbind, BTS_gender_allcountry) 

## Filter n > 30
BTS_gender_allcountry_tab <- BTS_gender_allcountry %>%
  dplyr::group_by(ISO3) %>%
  dplyr::summarise(n=n(),.groups = "drop") %>% 
  dplyr::filter(n > 30) %>%
  dplyr::pull(ISO3)

BTS_gender_allcountry <- BTS_gender_allcountry %>% 
  dplyr::filter(ISO3 %in% BTS_gender_allcountry_tab) %>% 
  dplyr::group_by(ISO3,Gender) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Data_Source = "BTS")

## Add journal gender data
BTS_gender_allcountry <- BTS_gender_allcountry %>% 
  dplyr::mutate(n = ifelse(ISO3 == "CHN" & Gender == "Male", 247188+13811,n),
                n = ifelse(ISO3 == "CHN" & Gender == "Female", 286648 + 14171,n))

BTS_gender_allcountry_prop <- BTS_gender_allcountry %>% 
  dplyr::group_by(ISO3) %>% 
  dplyr::mutate(Proportion = round(n/sum(n),2)*100) %>%
  dplyr::ungroup()

## Set factor levels according to gender proportion
BTS_gender_allcountry_factor <- BTS_gender_allcountry_prop %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)


## combine WEIRD data to visualization
WEIRD_gender <- WEIRD %>% 
  dplyr::filter(!is.na(iso3c)) %>% 
  dplyr::filter(iso3c %in% BTS_gender_allcountry_factor)


H3_gender <- BTS_gender_allcountry_prop %>% 
  dplyr::left_join(WEIRD_gender,by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>% 
  dplyr::mutate(ISO3 = factor(ISO3,levels = BTS_gender_allcountry_factor)) %>% 
  dplyr::filter(!is.na(ISO3))
```

and I visualized gender data.

```{r}
H3_Fig_gender <- ggplot(H3_gender, aes(x=Proportion, y=ISO3,fill=Gender)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("Female","Male")) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free")


H3_Fig_gender
```

Secondly, I processed age data. Similarity, I processed age data in two classification. The one is PsyStages.

```{r}
BTS_Psystages_allcountry <- BTS_age_PsyStages %>% 
  dplyr::filter(ISO3 %in% BTS_gender_allcountry_tab) %>% 
  dplyr::filter(ISO3 != "CHN") %>% ## drop Chinese data
  dplyr::group_by(ISO3,ageBins) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2)) %>% 
  dplyr::ungroup()


## Add Chinese data
Journal_BTS_PsyStages_CHN <- Sim_Journal_age_PsyStages3_prop %>% 
  dplyr::rename(n = 2) %>% 
  dplyr::bind_rows(BTS_age_PsyStages_CHN) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n=sum(n)) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                ISO3 = "CHN")

# sum(Journal_BTS_PsyStages_CHN$Proportion) # 100
  

## Combine data
H3_PsyStages <- dplyr::bind_rows(BTS_Psystages_allcountry,Journal_BTS_PsyStages_CHN)


## Set factor
H3_PsyStages_factor <- H3_PsyStages %>% 
  dplyr::filter(ageBins == "18~25") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)


## Process WEIRD
H3_PsyStages <- H3_PsyStages %>% 
  dplyr::left_join(WEIRD_gender, by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>%
  dplyr::mutate(ISO3 = factor(ISO3, levels = H3_PsyStages_factor)) %>% 
  dplyr::filter(!is.na(ageBins))
```

And I visualized age data (PsyStages) for all countries in BTS.

```{r}
H3_Fig_PsyStages <- ggplot(H3_PsyStages, aes(x=Proportion, y=ISO3, fill=ageBins)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("0~17", "18~25", "26~40", "41~59",">=60" )) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free") 


H3_Fig_PsyStages
```

The other is 10-year-old.

```{r}
BTS_interval10_allcountry <- BTS_age_interval10 %>% 
  dplyr::filter(ISO3 %in% BTS_gender_allcountry_tab) %>% 
  dplyr::filter(ISO3 != "CHN") %>%  ## drop Chinese data
  dplyr::group_by(ISO3,ageBins) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2)) %>% 
  dplyr::ungroup()


## Add Chinese data
Journal_BTS_interval10_CHN <- Sim_Journal_age_interval103_prop %>% 
  dplyr::rename(n = 2) %>% 
  bind_rows(BTS_age_interval10_CHN2) %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(n=sum(n)) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                ISO3 = "CHN")


## Combine data
H3_interval10 <- bind_rows(BTS_interval10_allcountry,Journal_BTS_interval10_CHN)


## Set factor
H3_interval10_factor <- H3_interval10 %>%
  dplyr::add_row(ISO3 = "CUB",ageBins = "11~20",n = 0, Proportion =0) %>%
  ##add data to visualization 
  dplyr::filter(ageBins == "11~20") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)


## Process WEIRD
H3_interval10 <- H3_interval10 %>% 
  dplyr::left_join(WEIRD_gender, by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>%
  dplyr::mutate(ISO3 = factor(ISO3, levels = H3_interval10_factor)) %>% 
  dplyr::filter(!is.na(ageBins) & !is.na(ISO3)) 

```

and I visualized age data (interval10) of all countries in BTS.

```{r}
H3_Fig_interval10 <- ggplot(H3_interval10, aes(x=Proportion, y=ISO3, fill=ageBins)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("0~10","11~20","21~30", "31~40", "41~50", "51~60", ">=61")) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free") 


H3_Fig_interval10
```

After the visualization of complete, I calculated BF. Firstly I defined a function to calculating BF for multiple countries.

```{r}
# create a new variable to store the BF values
Func_BFpairs <- function(df, countries_order, prop_name){
  
  # create a temp variable for storing 
  BF_mult_tmp <- data.frame(matrix(nrow = 0, ncol = 5))
  colnames(BF_mult_tmp) <- c("Observed", "Expected", "Log(BF10)_NonInform", "BF10_NonInform", "BF01_NonInform")
  
  for (ii in seq(length(countries_order))){
    country <- countries_order[ii]
    if (country != "CHN"){
      df_tmp <- df %>% dplyr::select(prop_name, one_of(country), "CHN")
      
      BF_tmp <- BayesMultiNomial(dataset = df_tmp, 
                                 factor = prop_name, observed = country, expected = "CHN")
      
      BF_mult_tmp[ii,] <- c(as.character(country), "CHN", 
                            BF_tmp$BF$LogBF10, BF_tmp$BF$BF10, BF_tmp$BF$BF01)
    } 
  }
  
  countries_order_age <- BF_mult_tmp %>% 
    tidyr::drop_na() %>%
    dplyr::mutate(`Log(BF10)_NonInform` = as.numeric(`Log(BF10)_NonInform`)) %>%
    dplyr::arrange(`Log(BF10)_NonInform`) %>%
    dplyr::pull(Observed)
  
  BF_mult_p_tmp <- BF_mult_tmp %>%
    tidyr::drop_na() %>%
    dplyr::select(1,2,3) %>%
    dplyr::mutate(Countries = factor(Observed, levels = countries_order_age),
                  `Log(BF10)_NonInform` = as.numeric(`Log(BF10)_NonInform`)) 
  
  return(BF_mult_p_tmp)
}
```

Secondly , I calculated gender BF and visualized gender BF.

```{r message=FALSE, warning=FALSE}
H3_BF_gender <- H3_gender %>% 
  dplyr::select(ISO3,Gender,Proportion) %>% 
  dplyr::rename(Countries = 1)


H3_BF_gender_factor <- H3_BF_gender %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Countries)


H3_BF_gender <- H3_BF_gender  %>% 
  dplyr::mutate(Countries = factor(Countries, levels = H3_BF_gender_factor)) %>% 
  tidyr::pivot_wider(names_from = "Countries",values_from = "Proportion") %>% 
  Func_BFpairs(countries_order = H3_BF_gender_factor,
               prop_name = "Gender")
```

```{r warning=FALSE}
H3_Fig_BF_gender <- ggplot(H3_BF_gender, aes( x = `Log(BF10)_NonInform`, y = Countries)) +
  geom_point() +
  scale_color_grey() +
  xlim(-3, 25) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  ggtitle("Gender Proportion") + 
  xlab("Log(BF10)")+
  theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              panel.border = element_blank(),
              text = element_text(family='Times'),
              axis.text.x = element_text (size = 12, color = 'black',  hjust = 1),
              axis.text.y = element_text (size = 12, color = 'black'),
              plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
              axis.text = element_text (size = 16, color = 'black'),
              axis.title = element_text (size = 16),
              axis.title.x = element_text (size = 16),
              axis.title.y = element_text( size = 16),
              axis.line.x = element_line(color='black', size = 1),
              axis.line.y = element_line(color='black', size = 1))


H3_Fig_BF_gender
```

Third, I calculted age BF in two classification. In this part, I calculated BF for this two categories.

```{r}
## PsyStages
H3_BF_PsyStages <- H3_PsyStages %>% 
  dplyr::select(ISO3,ageBins,Proportion) %>% 
  dplyr::rename(Countries = 1) %>% 
  dplyr::mutate(Countries = factor(Countries, levels = H3_BF_gender_factor)) %>% 
  tidyr::pivot_wider(names_from = "Countries",values_from = "Proportion") %>%
  dplyr::mutate(across(2:last_col(), ~ifelse(is.na(.), 0, .))) %>%
  Func_BFpairs(countries_order = H3_BF_gender_factor,
               prop_name = "ageBins")

# sum(H3_BF_PsyStages$AGO,na.rm = TRUE) ## 0

## interval10
H3_BF_interval10  <- H3_interval10 %>% 
  dplyr::select(ISO3,ageBins,Proportion) %>% 
  dplyr::rename(Countries = 1) %>% 
  dplyr::mutate(Countries = factor(Countries, levels = H3_BF_gender_factor)) %>% 
  tidyr::pivot_wider(names_from = "Countries",values_from = "Proportion") %>%
  dplyr::mutate(across(2:last_col(), ~ifelse(is.na(.), 1, .))) %>%
  Func_BFpairs(countries_order = H3_BF_gender_factor,
               prop_name = "ageBins")
```

and I visualized PsyStages BF at first.

```{r warning=FALSE}
H3_Fig_BF_PsyStages <- ggplot(H3_BF_PsyStages, aes( x = `Log(BF10)_NonInform`, y = Countries)) +
  geom_point() +
  scale_color_grey() +
  xlim(-10,200) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10))  +
  ggtitle("Age distribution") +
  xlab("Log(BF10)")+
  theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              panel.border = element_blank(),
              text = element_text(family='Times'),
              axis.text.x = element_text (size = 12, color = 'black',  hjust = 1),
              axis.text.y = element_text (size = 12, color = 'black'),
              plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
              axis.text = element_text (size = 16, color = 'black'),
              axis.title = element_text (size = 16),
              axis.title.x = element_text (size = 16),
              axis.title.y = element_text( size = 16),
              axis.line.x = element_line(color='black', size = 1),    
              axis.line.y = element_line(color='black', size = 1))

H3_Fig_BF_PsyStages
```

Then I visualized another category.

```{r warning=FALSE}
H3_Fig_BF_interval10 <- ggplot(H3_BF_interval10, 
                            aes( x = `Log(BF10)_NonInform`, y = Countries)) +
  geom_point() +
  scale_color_grey() +
  xlim(-10,100) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10))  +
  ggtitle("Age distribution") +
  xlab("Log(BF10)")+
  theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              panel.border = element_blank(),
              text = element_text(family='Times'),
              axis.text.x = element_text (size = 12, color = 'black',  hjust = 1),
              axis.text.y = element_text (size = 12, color = 'black'),
              plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
              axis.text = element_text (size = 16, color = 'black'),
              axis.title = element_text (size = 16),
              axis.title.x = element_text (size = 16),
              axis.title.y = element_text( size = 16),
              axis.line.x = element_line(color='black', size = 1),    
              axis.line.y = element_line(color='black', size = 1))

H3_Fig_BF_interval10
```

Finally, I combined the four figure for gender and age, as well as the figure that suppl document.

```{r warning=FALSE}
H3_Fig_gender_age <- (H3_Fig_BF_gender + H3_Fig_BF_PsyStages) /
   (H3_Fig_gender + H3_Fig_PsyStages) +
  plot_annotation(tag_levels = 'A')  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))

ggsave("H3_Fig_gender_age.pdf", H3_Fig_gender_age, device = "pdf", width=18, height = 18)

H3_Fig_gender_age

## suppl
H3_Fig_gender_age_suppl <- H3_Fig_BF_interval10 + H3_Fig_interval10 +
   plot_annotation(tag_levels =list(c("S1a","S1b")))  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))


ggsave("H3_Fig_gender_age_suppl .pdf", H3_Fig_gender_age_suppl , device = "pdf", width=18, height = 18)


H3_Fig_gender_age_suppl 
```

### Region

In this part, I analysed and visualized all countries in our study. Firstly, I processed region data of BTS.

```{r}
## creat a world map
world_map <- ggplot2::map_data(map = "world") %>% 
  dplyr::mutate(region = iso.alpha(region),
                long = ifelse(long >= -180 & long <= -30, long + 360, long),
                region = ifelse(region == "TW","CN",region))  

H3_sample_region <- BTS_Overview2 %>%  ## 按照scheme,这里应该是BTS + Jounal，但是这可能歪曲数据
  dplyr::mutate(Proportion = Proportion * 0.01) %>% 
  dplyr::mutate(Proportion_bins = if_else(Proportion >= 0.16, "0.16-1",
                                          if_else(Proportion < 0.16 & Proportion >= 0.08, "0.08-0.16" ,
                                                  if_else(Proportion < 0.08 & Proportion >= 0.04, "0.04-0.08" , 
                                                          if_else(Proportion < 0.04 & Proportion >= 0.02, "0.02-0.04" , 
                                                                  if_else(Proportion < 0.02 & Proportion >= 0.01, "0.01-0.02" , 
                                                                          if_else(Proportion < 0.01 & Proportion >= 0.005, "0.005-0.01" ,         
                                                                                  if_else(Proportion < 0.005 & Proportion >= 0.0025, "0.0025-0.005", "0-0.0025"))))))))
```

And I visualized geographic distribution of BTS.

```{r}
H3_Fig_sample_region <- ggplot(H3_sample_region)+
  geom_map(aes(map_id = ISO2, fill = Proportion_bins), map = world_map,show.legend = TRUE) +
  geom_polygon(data = world_map, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  scale_fill_manual(name = "Sample Proportion",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of sample")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"), 
        legend.key.width = unit(15, "pt")  
        )

H3_Fig_sample_region
```

Secondly, I processed and visualized geographic distribution of world population. Note: this data process and plot code from Liu weibiao and Hu chuanpeng, thanks them.

```{r}
wppdata <- read_csv("WPP2022.csv")

wppdata1 <- subset(wppdata, select = c("country_map","continent", "pop"))

wppdata3 <- dplyr::mutate(.data = wppdata1, percentage_pop = pop/7909295.151) 

#Merge data from Taiwan Province with data from mainland China
sum_of_cn <- sum(wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")])

wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")] <- sum_of_cn
wppdata3$percentage_pop[wppdata3 $country_map == "GL"] <- NA


wppdata3$n_binned <- 
  if_else(wppdata3$percentage_pop >= 0.16, "0.16-1",
  if_else(wppdata3$percentage_pop < 0.16 & wppdata3$percentage_pop >= 0.08, "0.08-0.16" , 
   if_else(wppdata3$percentage_pop < 0.08 & wppdata3$percentage_pop >= 0.04, "0.04-0.08" , 
  if_else(wppdata3$percentage_pop < 0.04 & wppdata3$percentage_pop >= 0.02, "0.02-0.04" , 
   if_else(wppdata3$percentage_pop < 0.02 & wppdata3$percentage_pop >= 0.01, "0.01-0.02" , 
   if_else(wppdata3$percentage_pop < 0.01 & wppdata3$percentage_pop >= 0.005, "0.005-0.01" ,         
  if_else(wppdata3$percentage_pop < 0.005 & wppdata3$percentage_pop >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))


wppdata4 <- wppdata3[complete.cases(wppdata3$percentage_pop), ]

# map of World people data 
world_population_map <- ggplot2::ggplot(wppdata4) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map,show.legend = TRUE) +
  ggplot2::geom_polygon(data = world_map, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
   xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "World People Proportion",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1"),
                    drop = FALSE) +
ggtitle("Geographical distribution of world population")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )

world_population_map

H3_region <- H3_Fig_sample_region + world_population_map + 
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')

ggsave("H3_region.pdf",H3_region, device = "pdf", width=18, height = 9)

H3_region
```


In addition to the above analysis, I also conducted some exploratory analysis of the data.

# Exploratory analysis

## Abstract1 subjects information reported of Chinese journal

```{r message=FALSE, warning=FALSE}
Journal_abstract1_report <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(Sample_Type_N != 5) %>%
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(Abstract1 == "0" ,"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)


## university students reported in abstract when sample type is 1
Journal_abstract2_report <- Journal %>% 
  dplyr::filter(grepl("1",Sample_Type_N)) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Abstract2_same = n_distinct(Abstract2) == 1) %>%  ## check multiple subjects group Abstract2 whether is consistent.
  dplyr::slice(1) %>% ## for one articles have multiple rows, only save the first row
  dplyr::ungroup() %>% 
  dplyr::group_by(Abstract2) %>% 
  dplyr::summarise(report = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(proportion = round(report/sum(report),2),
                Abstract2 = ifelse(Abstract2 == 0 ,"Unreported","Reported")) %>% 
  dplyr::rename(n = 2)
```

## Bibliometrics Analysis

```{r eval=FALSE, include=FALSE}
```

## Target population explore

```{r}
# table(Journal$Sample_Type_N)

Target_population_tab <-  Journal %>%
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N) %>% 
  dplyr::mutate(Sample_Type_N = ifelse(Sample_Type_N == 1,"University students",
                                       ifelse(Sample_Type_N == 2, "Students but not university students",
                                              ifelse(Sample_Type_N == 3 ,"Infants or preschool children",
                                                     ifelse(Sample_Type_N == 4 ,"Adults who are not students",
                                                            ifelse(Sample_Type_N == 5 ,"Others",
                                                                   ifelse(Sample_Type_N == 12 ,"University and primary school students", 
                                                                          ifelse(Sample_Type_N == 14,"University students and audlts and primary and secondary students",
                                                                                 ifelse(Sample_Type_N == 23,"Children and primary and secondary students", Sample_Type_N))))))))) %>%
  dplyr::group_by(Article_IDs) %>%
  dplyr::mutate(unique_sample_types = n_distinct(Sample_Type_N),  # Check if Sample_Type_N is unique
    Study_Type = if_else(  
      unique_sample_types == 1,  
      as.character(Sample_Type_N[1]),  
      toString(sort(unique(Sample_Type_N))) %>% str_replace_all(", ", " & ")  
    )  # If unique, Study_Type is the value of the Sample_Type_N (here we convert to character type for later processing)
# If not unique, create a string representing all Sample_Type_N
# Take the first value as the representative (because they are the same)
# Merge all unique Sample_Type_N values with to String, separated by "&"
  ) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Target_Population_N,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Target_Population_N,values_from = n) %>% 
  dplyr::rename(stated_specific_population = 2, stated_general_population = 3, inferred_general_population = 4)


table(Journal$Sample_Type_N)
# table(Target_population_tab$Study_Type)


Target_population_check <- Journal %>% 
  dplyr::select(Article_IDs,Article_Title,Target_Population_N,Coding_Basis_N,Sample_Type_N) %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1)


writexl::write_xlsx(Target_population_check,"Target_population_check.xlsx")


Journal_institution <-  Journal %>% 
  dplyr::select(Article_IDs,Article_Title) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::mutate(institution = NA)

writexl::write_xlsx(Journal_institution,"Journal_institution.xlsx")
```
