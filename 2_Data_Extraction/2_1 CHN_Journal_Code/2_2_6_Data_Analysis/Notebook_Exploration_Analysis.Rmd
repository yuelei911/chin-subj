---
title: "Notebook_Exploration_Analysis"
author: "Lei Yue"
date: "2025-05-13"
output: html_document
---



## intall library
```{r}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")

p_load("tidyverse","ggplot2","ggwordcloud",
       "ggrepel","xlsx","patchwork",
       "sf","ggspatial","pcutils","igraph",
       "MetaNet")
```



## Load data
```{r}
load("Journal.Rdata")
```


## Journal report
different period
```{r}
Journal_year2008_report <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2008") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_year2008_report )){
  
  
  report_table <- data.frame(table(Journal_year2008_report [[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_year2008_report [i]),
                  proportion = Freq / sum(Freq))
  
  report_list[[i]] <- report_table
  
}

Journal_year2008_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_year2008_education_occupation <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2008") %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_year2008_education_occupation$Educational_Attainment_N) ## FALSE 32 TRUE 30
table(Journal_year2008_education_occupation$Occupation_N)  ## FALSE 35 TRUE 27


Journal_year2008_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(34,31,36,29),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(34/(34+31),31/(34+31),
                                                                  36/(36+29),29/(36+29)))

Journal_year2008_report2 <- rbind(Journal_year2008_report,
                                  Journal_year2008_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Recruitment Method",
                                              "Recruitment Area",
                                              "Age","Educational Attainment",
                                              "Occupation","Sampling Method",
                                              "SES","Ethnicity","Religious"),
                                   levels = c("Gender","Recruitment_Method",
                                              "Recruitment_Area",
                                              "Age","Educational_Attainment",
                                              "Occupation","Sampling_Method",
                                              "SES","Ethnicity","Religious")),
                proportion = proportion *100) %>% 
  dplyr::mutate(Year = "2008")

```


```{r}
Journal_year2018_report <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2018") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_year2018_report )){
  
  
  report_table <- data.frame(table(Journal_year2018_report [[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_year2018_report [i]),
                  proportion = Freq / sum(Freq))
  
  report_list[[i]] <- report_table
  
}

Journal_year2018_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_year2018_education_occupation <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2018") %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_year2018_education_occupation$Educational_Attainment_N) ## FALSE 73 TRUE 69
table(Journal_year2018_education_occupation$Occupation_N)  ## FALSE 84 TRUE 58


Journal_year2018_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(73,76,90,59),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(73/(73+76),76/(73+76),
                                                                  90/(90+59),59/(90+59)))

Journal_year2018_report2 <- rbind(Journal_year2018_report,
                                  Journal_year2018_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment Method",
                                              "Recruitment Area",
                                              "Educational Attainment",
                                              "Occupation","Sampling Method",
                                              "SES","Ethnicity","Religious"),
                                   levels = c("Gender","Age","Recruitment_Method",
                                              "Recruitment_Area",
                                              "Educational_Attainment",
                                              "Occupation","Sampling_Method",
                                              "SES","Ethnicity","Religious")),
                proportion = proportion *100)%>% 
  dplyr::mutate(Year = "2018")

```


```{r}
Journal_year2021_report <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2021") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_year2021_report )){
  
  
  report_table <- data.frame(table(Journal_year2021_report [[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_year2021_report [i]),
                  proportion = Freq / sum(Freq))
  
  report_list[[i]] <- report_table
  
}

Journal_year2021_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_year2021_education_occupation <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2021") %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_year2021_education_occupation$Educational_Attainment_N) ## FALSE 55 TRUE 33
table(Journal_year2021_education_occupation$Occupation_N)  ## FALSE 72 TRUE 16


Journal_year2021_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(58,34,75,17),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(58/(58+34),34/(58+34),
                                                                  75/(75+17),75/(75+17)))

Journal_year2021_report2 <- rbind(Journal_year2021_report,
                                  Journal_year2021_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment Method",
                                              "Recruitment Area","Sampling Method",
                                              "Educational Attainment",
                                              "SES","Occupation",
                                              "Ethnicity","Religious"),
                                   levels = c("Gender","Age","Recruitment_Method",
                                              "Recruitment_Area","Sampling_Method",
                                              "Educational_Attainment",
                                              "SES","Occupation",
                                              "Ethnicity","Religious")),
                proportion = proportion *100)%>% 
  dplyr::mutate(Year = "2021")
```


combine three data
```{r}
Journal_report <- bind_rows(Journal_year2008_report2,Journal_year2018_report2,Journal_year2021_report2) %>% 
  dplyr::filter(Var1 == "Reported") %>% 
  dplyr::add_row(data.frame(Var1 = c("Reported","Reported"),
                            Freq = c(0,0),
                            col_names = c("Religious","Religious"),
                            proportion = c(0,0),
                            Year = c("2008","2021"))) %>% 
  dplyr::mutate(col_names = factor(col_names,
                                   levels = c("Gender","Recruitment Method","Recruitment Area",
                                              "Age","Educational Attainment","Occupation",
                                              "Sampling Method","SES","Ethnicity",
                                              "Religious"),
                                   labels = c("Sex","Recruitment method","Recruitment area",
                                              "Age","Educational attainment","Occupation",
                                              "Sampling method","Socioeconomic status","Ethnicity",
                                              "Religious belief")))

Journal_report_year <- Journal_report %>% 
  ggplot(aes(x = Year, y = proportion, color = col_names, group = col_names))+
  geom_line(size = 1)+
  geom_point(size = 3)+
  labs(y="Proportion", x = "Year")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

ggsave("Journal_report_year.pdf", Journal_report_year, device = "pdf", width=12, height = 9)


Journal_report_year
```


different target population
general
```{r}
Journal_general_population <- Journal %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_general_population)){
  
  
  report_table <- data.frame(table(Journal_general_population[[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_general_population[i]),
                  proportion = Freq / sum(Freq))
  
  report_list[[i]] <- report_table
  
}

Journal_general_population_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_general_education_occupation <- Journal %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_general_education_occupation$Educational_Attainment_N) ## FALSE 73 TRUE 42
table(Journal_general_education_occupation$Occupation_N)  ## FALSE 101 TRUE 14


Journal_general_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(73,42,101,14),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(73/(73+42),42/(73+42),
                                                                  101/(101+14),14/(101+14)))

Journal_general_report2 <- rbind(Journal_general_population_report,
                                  Journal_general_education_occupation_table) %>%
  dplyr::mutate(proportion = proportion *100) %>% 
  dplyr::mutate(Target_population = "General population")

```


special
```{r}
Journal_special_population <- Journal %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_special_population)){
  
  
  report_table <- data.frame(table(Journal_special_population[[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_special_population[i]),
                  proportion = Freq / sum(Freq))
  
  report_list[[i]] <- report_table
  
}

Journal_special_population_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_special_education_occupation <- Journal %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_special_education_occupation$Educational_Attainment_N) ## FALSE 92 TRUE 100
table(Journal_special_education_occupation$Occupation_N)  ## FALSE 101 TRUE 91


Journal_special_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(92,100,101,91),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(92/(92+100),100/(92+100),
                                                                  101/(101+91),91/(101+91)))

Journal_special_report2 <- rbind(Journal_special_population_report,
                                  Journal_special_education_occupation_table) %>%
  dplyr::mutate(proportion = proportion *100) %>% 
  dplyr::mutate(Target_population = "Special population")
```


combine two data.frame and visualize
```{r}
Journal_target_population_report <- full_join(Journal_general_report2,
                                              Journal_special_report2,
                                              by = c("col_names", "Var1", "Freq", "proportion","Target_population")) %>% 
  dplyr::filter(Var1 == "Reported")


## set factor
Journal_target_population_report_factor <- Journal_target_population_report %>% 
  dplyr::filter(Target_population == "General population") %>% 
  dplyr::arrange(desc(proportion)) %>% 
  dplyr::pull(col_names)


Journal_target_population_report2 <- Journal_target_population_report %>% 
dplyr::mutate(col_names = factor(col_names,
                                 levels = Journal_target_population_report_factor,
                                 labels = c(labels = c("Sex", "Age","Recruitment method","Educational attainment",
                                                       "Recruitment area","Socioeconomic status","Sampling method",
                                               "Occupation", "Ethnicity", "Religious belief"))))


## plot
Journal_report_target_population <- Journal_target_population_report2 %>% 
  ggplot(aes(x = col_names, y = proportion, fill = Target_population, group = Target_population))+
  geom_bar(stat = "identity", position = position_dodge(width = 0.8))+
  labs(y="Proportion", x = "Target population")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  scale_x_discrete(guide = guide_axis(angle = 45))

ggsave("Journal_report_target_population.pdf", Journal_report_target_population, device = "pdf", width=12, height = 9)

Journal_report_target_population
```


create BF func, It is consistent with the analyzed function in the formal Rmd.
```{r}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
     LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```


<!-- calculate BF within terget population in different demographic dimension -->
```{r}
## convert data form
# Journal_target_population_report_bayes <- Journal_target_population_report2 %>% 
#   dplyr::select(col_names,proportion,Target_population) %>% 
#   tidyr::pivot_wider(names_from = col_names,
#                      values_from = proportion)

```


## Two data sources are respectively compared with the census data and CFPS

load data
```{r}
load("H2_BTS_Journal_age_edu.RData")
load("H2_gender_exploration.Rdata")
```


and then, I process the data of gender, age and edu.

## gender
process data
```{r}
## process census 6th
Census6_gender2 <- Census6_gender %>% 
  dplyr::rename(Data_Source = 1) %>% 
  dplyr::mutate(n = NA)

## combine data
SupplH2_gender_general <- H2_gender_general %>% 
  dplyr::rename(Data_Source = Data_source) %>% 
  rbind(H1_gender_general) %>% 
  dplyr::filter(Data_Source != "Chinese participants") %>% 
  rbind(Census6_gender2) %>% 
  dplyr::mutate(Data_Source = factor(Data_Source,
                                     levels = c("Census6","Census7",
                                                "BTS Chinese","CFPS2018", 
                                                "Journal")))
```


visulize
```{r}
Suppl_Fig_H2_gender_general <- ggplot(SupplH2_gender_general,aes(Data_Source,Proportion,fill= Gender))+
  geom_col()+
  geom_hline(yintercept = 50, linetype = "dashed", color = "#666666")+
  labs(y="Proportion",x = "Data source")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))


ggsave("Suppl_Fig_H2_gender_general.pdf",Suppl_Fig_H2_gender_general, device = "pdf", width=18, height = 9)
Suppl_Fig_H2_gender_general

```


BF calculate
```{r}
SupplH2_gender_general_bayes <- SupplH2_gender_general %>% 
  dplyr::select(Gender,Data_Source,Proportion) %>% 
  pivot_wider(names_from = Data_Source,values_from = Proportion)


## Journal VS Census6
SupplH2_BF_gender_Journal_Census6 <- BayesMultiNomial(dataset = SupplH2_gender_general_bayes,
                                             factor = "Gender",
                                             observed = "Journal",
                                             expected = "Census6")

## BTS VS Census6
SupplH2_BF_gender_BTS_Census6 <- BayesMultiNomial(dataset = SupplH2_gender_general_bayes,
                                             factor = "Gender",
                                             observed = "BTS Chinese",
                                             expected = "Census6")

## Journal VS Census7
SupplH2_BF_gender_Journal_Census7 <- BayesMultiNomial(dataset = SupplH2_gender_general_bayes,
                                             factor = "Gender",
                                             observed = "Journal",
                                             expected = "Census7")

## BTS VS Census7
SupplH2_BF_gender_BTS_Census7 <- BayesMultiNomial(dataset = SupplH2_gender_general_bayes,
                                             factor = "Gender",
                                             observed = "BTS Chinese",
                                             expected = "Census7")

## Journal VS CFPS2018
SupplH2_BF_gender_Journal_CFPS <- BayesMultiNomial(dataset = SupplH2_gender_general_bayes,
                                             factor = "Gender",
                                             observed = "Journal",
                                             expected = "CFPS2018")

## BTS VS CFPS2018
SupplH2_BF_gender_BTS_CFPS <- BayesMultiNomial(dataset = SupplH2_gender_general_bayes,
                                             factor = "Gender",
                                             observed = "BTS Chinese",
                                             expected = "CFPS2018")
```


## age
process data 
```{r}
## BTS
H1_age_general_BTS <- H1_age_general %>% 
  dplyr::filter(Data_Source == "BTS Chinese")

## Journal
H1_age_general_Journal <- H1_age_general %>% 
  dplyr::filter(Data_Source == "Journal")

# ## combine census6 and census7
# Census_age_five <- rbind(Census6_age_five5,Census7_age_five5)

```


visualize Census7, BTS Chinese and Journal 
```{r}
SupplH2_Census7_age_general <- ggplot(data= Census7_age_five5,
                              aes(x=ageBins, 
                                  y= Proportion, fill=Data_Source)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = H1_age_general_BTS, 
            aes(x = ageBins, y = Proportion, group = 1, color = "BTS Chinese"), 
            size = 1) +
  geom_line(data = H1_age_general_Journal, 
            aes(x = ageBins, y = Proportion, group = 1, color = "Journal"), 
            size = 1) +
  scale_fill_manual(values = c("Census7" = "#00BFC4")) +  
  scale_color_manual(values = c("BTS Chinese" = "blue", "Journal" = "red")) +
  scale_y_continuous(limits = c(0,50))+
  coord_flip() +
  labs(y="Proportion", x = "Age bins")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

ggsave("SupplH2_Census7_age_general.pdf",SupplH2_Census7_age_general, device = "pdf", width=18, height = 9)

SupplH2_Census7_age_general
```


visualize Census6, BTS Chinese and Journal 
```{r}
SupplH2_Census6_age_general <- ggplot(data= Census6_age_five5,
                              aes(x=ageBins, 
                                  y= Proportion, fill=Data_Source)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = H1_age_general_BTS, 
            aes(x = ageBins, y = Proportion, group = 1, color = "BTS Chinese"), 
            size = 1) +
  geom_line(data = H1_age_general_Journal, 
            aes(x = ageBins, y = Proportion, group = 1, color = "Journal"), 
            size = 1) +
  scale_fill_manual(values = c("Census6" = "#00BFC4")) +  
  scale_color_manual(values = c("BTS Chinese" = "blue", "Journal" = "red")) +
  scale_y_continuous(limits = c(0,50))+
  coord_flip() +
  labs(y="Proportion", x = "Age bins")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

ggsave("SupplH2_Census6_age_general.pdf",SupplH2_Census6_age_general, device = "pdf", width=18, height = 9)

SupplH2_Census6_age_general
```


BF data
```{r}
## Census6 PsyStages
Suppl_Census6_age_PsyStages <- Census6_age_PsyStages %>% 
  dplyr::select(ageBins,Proportion) %>% 
  dplyr::rename(Census6 = 2)

## Census7 PsyStages
Suppl_Census7_age_PsyStages <- Census7_age_PsyStages %>% 
  dplyr::select(ageBins,Proportion) %>% 
  dplyr::rename(Census7 = 2)


## Census6 interval10
Suppl_Census6_age_interval10 <- Census6_age_interval10 %>% 
  dplyr::select(ageBins,Proportion) %>% 
  dplyr::rename(Census6 = 2)

## Census7 interval10
Suppl_Census7_age_interval10 <- Census7_age_interval10 %>% 
  dplyr::select(ageBins,Proportion) %>% 
  dplyr::rename(Census7 = 2)


## combine data
## PsyStages
Suppl_PsyStages_bayes <- left_join(H1_PsyStages_bayes_general,
                                Suppl_Census7_age_PsyStages,
                                by = "ageBins") %>% 
  left_join(Suppl_Census6_age_PsyStages,
            by = "ageBins")


## interval10
Suppl_interval10_bayes <- left_join(H1_interval10_bayes_general,
                                 Suppl_Census7_age_interval10,
                             by = "ageBins") %>% 
  left_join(Suppl_Census6_age_interval10,
            by = "ageBins")

```


Census6, BTS Chinese, and Journal
```{r}
## BTS PsyStages VS Census6
SupplH2_BF_Psystages_BTS_Census6 <- BayesMultiNomial(dataset = Suppl_PsyStages_bayes,
                                             factor = "ageBins",
                                             observed = "BTS Chinese",
                                             expected = "Census6")


## BTS interval10 VS Census6
SupplH2_BF_interval10_BTS_Census6 <- BayesMultiNomial(dataset = Suppl_interval10_bayes,
                                             factor = "ageBins",
                                             observed = "BTS Chinese",
                                             expected = "Census6")


## Journal PsyStages VS Census6
SupplH2_BF_Psystages_Journal_Census6 <- BayesMultiNomial(dataset = Suppl_PsyStages_bayes,
                                             factor = "ageBins",
                                             observed = "Journal",
                                             expected = "Census6")

## Journal interval10 VS Census6
SupplH2_BF_interval10_Journal_Census6 <- BayesMultiNomial(dataset =Suppl_interval10_bayes,
                                             factor = "ageBins",
                                             observed = "Journal",
                                             expected = "Census6")
```


Census7, BTS Chinese, and Journal
```{r}
## BTS PsyStages VS Census7
SupplH2_BF_Psystages_BTS_Census7 <- BayesMultiNomial(dataset = Suppl_PsyStages_bayes,
                                             factor = "ageBins",
                                             observed = "BTS Chinese",
                                             expected = "Census7")


## BTS interval10 VS Census7
SupplH2_BF_interval10_BTS_Census7 <- BayesMultiNomial(dataset = Suppl_interval10_bayes,
                                             factor = "ageBins",
                                             observed = "BTS Chinese",
                                             expected = "Census7")


## Journal PsyStages VS Census7
SupplH2_BF_Psystages_Journal_Census7 <- BayesMultiNomial(dataset = Suppl_PsyStages_bayes,
                                             factor = "ageBins",
                                             observed = "Journal",
                                             expected = "Census7")

## Journal interval10 VS Census7
SupplH2_BF_interval10_Journal_Census7 <- BayesMultiNomial(dataset =Suppl_interval10_bayes,
                                             factor = "ageBins",
                                             observed = "Journal",
                                             expected = "Census7")
```


## edu
process Census6 data
```{r warning=FALSE}
Census6_edu <- readxl::read_xlsx("Census6_edu.xlsx")

Suppl_Census6_edu_adults <- Census6_edu %>%
  dplyr::select(1,2,5,8,11,14,17,20,23) %>%
  dplyr::rename(Age = 1,n = 2,
                Never_attended_school = 3,  Primary_school = 4,
                Junior_high_school = 5, Senior_high_school = 6,
                Junior_college = 7,Undergraduate_education = 8,
                Graduate_education = 9) %>% 
  dplyr::slice(21:22, seq(23,101,by = 6)) %>% 
  dplyr::mutate(across(-1,as.numeric)) 
  
 
## college
Suppl_Census6_college <- Suppl_Census6_edu_adults %>% 
  dplyr::summarise(`Below college` = sum(across(3:6)),
                   `College and above` = sum(across(7:9))) %>% 
  tidyr::pivot_longer(cols = c(1,2),
                      names_to = "Educational_attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100) %>% 
  dplyr::select(-Num) %>% 
  dplyr::rename(Census6 = 2)

## high school
Suppl_Census6_high_school <- Suppl_Census6_edu_adults %>% 
  dplyr::summarise(`Below high school` = sum(across(3:5)),
                   `High school and above` = sum(across(6:9))) %>% 
  tidyr::pivot_longer(cols = c(1,2),
                      names_to = "Educational_attainment",
                      values_to = "Num") %>% 
  dplyr::mutate(Proportion = Num/sum(Num)*100) %>% 
  dplyr::select(-Num)%>% 
  dplyr::rename(Census6 = 2)
```


process Census7 data
```{r}
## Census
Suppl_Census7_college <- Census7_college %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(Census7 = 2)

Suppl_Census7_high_school <- Census7_high_school %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(Census7 = 2)
```


process CFPS2018 data
```{r}
Suppl_CFPS2018_edu_college <- CFPS2018_edu_college %>%
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(CFPS2018 = 2)


Suppl_CFPS2018_edu_high_school <- CFPS2018_edu_high_school %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(CFPS2018 = 2)
```


combine all edu data
```{r}
## college
Suppl_college <- left_join(H1_edu_college_bayes, 
                           Suppl_Census7_college, 
                           by = "Educational_attainment") %>%
  left_join(Suppl_CFPS2018_edu_college,
            by = "Educational_attainment") %>% 
  left_join(Suppl_Census6_college,
             by = "Educational_attainment")


## high school
Suppl_highschool <- left_join(H1_edu_highschool_bayes, 
                              Suppl_Census7_high_school, 
                              by = "Educational_attainment") %>% 
  left_join(Suppl_CFPS2018_edu_high_school,by = "Educational_attainment") %>% 
  left_join(Suppl_Census6_high_school,
             by = "Educational_attainment")
```


BF Journal, BTS and Census6
```{r}
## College
Suppl_BF_college_BTS_Census6 <-  BayesMultiNomial(dataset = Suppl_college,
                                             factor = "Educational_attainment",
                                             observed = "BTS Chinese",
                                             expected = "Census6")

Suppl_BF_college_Journal_Census6 <-  BayesMultiNomial(dataset = Suppl_college,
                                             factor = "Educational_attainment",
                                             observed = "Journal",
                                             expected = "Census6")


## high school
Suppl_BF_highschool_BTS_Census6 <-  BayesMultiNomial(dataset = Suppl_highschool,
                                             factor = "Educational_attainment",
                                             observed = "BTS Chinese",
                                             expected = "Census6")

Suppl_BF_highschool_Journal_Census6 <-  BayesMultiNomial(dataset = Suppl_highschool,
                                             factor = "Educational_attainment",
                                             observed = "Journal",
                                             expected = "Census6")
```


BF Journal, BTS and Census7
```{r}
## College
Suppl_BF_college_BTS_Census7 <-  BayesMultiNomial(dataset = Suppl_college,
                                             factor = "Educational_attainment",
                                             observed = "BTS Chinese",
                                             expected = "Census7")

Suppl_BF_college_Journal_Census7 <-  BayesMultiNomial(dataset = Suppl_college,
                                             factor = "Educational_attainment",
                                             observed = "Journal",
                                             expected = "Census7")


## high school
Suppl_BF_highschool_BTS_Census7 <-  BayesMultiNomial(dataset = Suppl_highschool,
                                             factor = "Educational_attainment",
                                             observed = "BTS Chinese",
                                             expected = "Census7")

Suppl_BF_highschool_Journal_Census7 <-  BayesMultiNomial(dataset = Suppl_highschool,
                                             factor = "Educational_attainment",
                                             observed = "Journal",
                                             expected = "Census7")
```


## Abstract report
Abstract1 subjects information reported of Chinese journal

all data
```{r message=FALSE, warning=FALSE}
Journal_abstract1_report_all <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(Sample_Type_N != 5) %>%
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(Abstract1 == "0" ,"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)


## Chi
matrix_Journal_abstract1_report_all <- matrix(c(33, 9, # College students & other populations
                                            227, 204, # Only college students
                                            434, 28), # Only sample outside colleges
                                          nrow = 3,
                                          byrow = TRUE,
                                          dimnames = list(Study_Type = c("College students & other", "Only college students", "Only outside colleges"),
                                                          Sample_Status = c("Sample not mentioned", "Samples mentioned")))

# Chi test
matrix_Journal_abstract1_result_all <- chisq.test(matrix_Journal_abstract1_report_all)
matrix_Journal_abstract1_result_all
```


general population
```{r}
Journal_abstract1_report_general <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(Sample_Type_N != 5) %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(Abstract1 == "0" ,"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)


## Chi
matrix_Journal_abstract1_report_general <- matrix(c(10, 7, # College students & other populations
                                            91, 198, # Only college students
                                            32, 11), # Only sample outside colleges
                                          nrow = 3,
                                          byrow = TRUE,
                                          dimnames = list(Study_Type = c("College students & other", "Only college students", "Only outside colleges"),
                                                          Sample_Status = c("Sample not mentioned", "Samples mentioned")))

# Chi test
matrix_Journal_abstract1_result_general <- chisq.test(matrix_Journal_abstract1_report_general)
matrix_Journal_abstract1_result_general
```


Abstract 2 reported

all data.
```{r}

## check info consisitency
# Journal_abstract2_report_CE <- Journal %>% 
#    dplyr::select(Article_IDs_N,Study_Number_N,Subjects_Group_N,
#                 Target_Population_N,Sample_Type_N,Abstract2) %>% 
#   dplyr::filter(!is.na(Abstract2)) %>% 
#   dplyr::group_by(Article_IDs_N) %>% 
#   dplyr::summarise(Distinct_ab2 = n_distinct(Abstract2)) %>% 
#   dplyr::ungroup()
  
Journal_abstract2_report <- Journal %>% 
  dplyr::select(Article_IDs_N,Study_Number_N,Subjects_Group_N,
                Target_Population_N,Sample_Type_N,Abstract2) %>% 
  dplyr::filter(!is.na(Abstract2)) %>% 
  dplyr::group_by(Article_IDs_N) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()



## Chi-aquare test
Journal_ab2_tab <- table(Journal_abstract2_report$Abstract2)
Journal_ab2_tab

Journal_ab2_tab_chi_test <- chisq.test(Journal_ab2_tab, p = c(0.5,0.5))
Journal_ab2_tab_chi_test
```


general population
```{r}
Journal_abstract2_report_general <- Journal %>% 
  dplyr::select(Article_IDs_N,Study_Number_N,Subjects_Group_N,
                Target_Population_N,Sample_Type_N,Abstract2) %>% 
  dplyr::filter(!is.na(Abstract2)) %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::group_by(Article_IDs_N) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()



## Chi-aquare test
Journal_ab2_general_tab <- table(Journal_abstract2_report_general$Abstract2)
Journal_ab2_general_tab

Journal_ab2_general_tab_chi_test <- chisq.test(Journal_ab2_general_tab, p = c(0.5,0.5))
Journal_ab2_general_tab_chi_test
```


## Reason for current data pattern
```{r}
Journal_subjects_recruitment <- Journal %>% 
  dplyr::select(Article_IDs,Article_Title,Study_Number_N,Subjects_Group_N,
                Target_Population_N,Sample_Type_N,Sampling_Method,Subjects_Recruitment_Method_N,
                Subjects_Recruitment_Method_info_N)

table(Journal_subjects_recruitment$Sampling_Method)  ## 0(1107),1(223),2(298)

table(Journal_subjects_recruitment$Subjects_Recruitment_Method_N)

## each articles 
Journal_subjects_recruitment_articles <- Journal_subjects_recruitment %>% 
  dplyr::group_by(Article_IDs) %>% 
  mutate(Subjects_Recruitment_Method_cate = ifelse(all(Subjects_Recruitment_Method_N == "0"),"unreported",
                                                       ifelse(any(grepl("1", Subjects_Recruitment_Method_N)),"have offline","other"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()

table(Journal_subjects_recruitment_articles$Subjects_Recruitment_Method_cate)

(949+7)/(949+7+78)
606/(606+46)
```


```{r}
Journal_subjects_recruitment2 <- Journal_subjects_recruitment %>% 
  dplyr::filter(Target_Population_N != 1)

table(Journal_subjects_recruitment2$Subjects_Recruitment_Method_N)
```


## sample size in different study type
the sample size of different study type
```{r} 
load("Journal_region.RData")


Journal_general_experi <- Journal %>% 
  dplyr::select(Article_IDs_N,Study_Number_N,Study_Type,Sample_Size,Target_Population_N) %>% 
  dplyr::mutate(Sample_Size = ifelse(Article_IDs_N == "20185082", 33, Sample_Size)) %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::filter(Study_Type == 1) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size)) %>% 
  dplyr::filter(!is.na(Sample_Size))


Journal_general_experi_papernum <- Journal_general_experi %>% 
  dplyr::distinct(Article_IDs_N) 
Journal_general_experi_studynum <-  Journal_general_experi %>% 
  dplyr::distinct(Article_IDs_N,Study_Number_N)
sum(Journal_general_experi$Sample_Size,rm.na = TRUE)  ## 46183


## questionnaire
Journal_general_questionaire <- Journal %>% 
  dplyr::select(Article_IDs_N,Study_Number_N,Study_Type,Sample_Size,Target_Population_N) %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  dplyr::filter(Study_Type == 2) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size)) %>% 
  dplyr::filter(!is.na(Sample_Size))


Journal_general_questionaire_papernum <- Journal_general_questionaire %>% 
  dplyr::distinct(Article_IDs_N)
Journal_general_questionaire_studynum <- Journal_general_questionaire %>% 
  dplyr::distinct(Article_IDs_N,Study_Number_N)
sum(Journal_general_questionaire$Sample_Size)
```


exploration analysis region data of Journal based on study type
```{r}
## single region
Journal_region_single_studytype <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Study_Type) %>% 
  dplyr::inner_join(Journal_region_single,
                    by = c("Article_IDs","Study_Number","Subjects_Group"))

Journal_region_single_studytype2 <- Journal_region_single_studytype %>% 
  dplyr::filter(Target_Population_N != 1)


## multiple region
Journal_region_multiple_IDs <- Journal_region_multiple %>% 
  dplyr::pull(Article_IDs)

Journal_studytype <- Journal %>% 
  dplyr::filter(Article_IDs %in% Journal_region_multiple_IDs) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Study_Type)
  # dplyr::slice(-c(4,11)) %>% 


Journal_region_multiple_studytype <- Journal_region_multiple %>% 
  dplyr::inner_join(Journal_studytype, by = c("Article_IDs","Study_Number","Subjects_Group")) %>% 
  dplyr::filter(Target_Population_N != 1) ## only one row data

Journal_region_multiple_studytype2 <- Journal_region_multiple_studytype %>% 
  tidyr::separate_rows(True_Value,sep = ";") %>% 
  tidyr::separate(True_Value,c("Subjects_Recruitment_Area","Sample_Size"),sep = ":") %>% 
  dplyr::mutate(Sample_Size = as.numeric(trimws(Sample_Size)),
                Sample_Size = ceiling(2500 * Sample_Size)) %>% ## sample size is 2500
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Study_Type,Target_Population_N,Sample_Type_N,
                Sample_Size,Subjects_Recruitment_Area)
  

## combine single region data and multiple region data
Journal_region <- bind_rows(Journal_region_single_studytype2,Journal_region_multiple_studytype2)


## group by study type
Journal_region_experi <- Journal_region %>% 
  dplyr::filter(Study_Type == 1) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(Sample_Size = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
  dplyr::mutate(Proportion = Sample_Size/sum(Sample_Size)*100,
                Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal_experi") %>% 
  dplyr::rename(Region = Subjects_Recruitment_Area)


Journal_region_questionaire <- Journal_region %>% 
  dplyr::filter(Study_Type == 2) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(Sample_Size = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
  dplyr::mutate(Proportion = Sample_Size/sum(Sample_Size)*100,
                Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal_questionaire") %>% 
  dplyr::rename(Region = Subjects_Recruitment_Area)
```


convert Journal data into four regions and seven regions
```{r}
## four regions & experi
Journal_region_four_experi <- merge(Journal_region_experi,China_region_four,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_four) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(n = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(experi_Prop = n / sum(n) * 100) 

sum(Journal_region_four_experi$experi_Prop)


## seven regions & experi
Journal_region_seven_experi <- merge(Journal_region_experi,China_region_seven,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_seven) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(n = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(experi_Prop = n / sum(n) * 100) 

sum(Journal_region_seven_experi$experi_Prop)

## four regions & questionaire
Journal_region_four_questionaire <- merge(Journal_region_questionaire, China_region_four,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_four) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(n = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(questionaire_Prop = n / sum(n) * 100)  

sum(Journal_region_four_questionaire$questionaire_Prop)


##seven regions & questionaire
Journal_region_seven_questionaire <- merge(Journal_region_questionaire, China_region_seven,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_seven) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(n = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(questionaire_Prop = n / sum(n) * 100) 

sum(Journal_region_seven_questionaire$questionaire_Prop)
```

add census6' regional data 
```{r}
Census6_region <- readxl::read_xlsx("Census6_region.xlsx") %>% 
  dplyr::select(1,5) %>% 
  dplyr::slice(-c(1:7)) %>% 
  dplyr::rename(Region = 1, n = 2) %>% 
  dplyr::mutate(n = as.numeric(n,
                               Region = gsub(" ","",Region)))

Census6_3 <- data.frame(Region = c("","",""),n =c(170283,234829,21201))


Census6_region <- rbind(Census6_region,Census6_3) %>% 
  dplyr::mutate(Proportion = n / sum(n)*100) %>% 
  dplyr::mutate(Count_Bins = cut(Proportion,
                                      breaks = c(-Inf,1,5,10,Inf),
                                      labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Census6")

sum(Census6_region$n) #1,333,237,182
sum(Census6_region$Proportion) ## 100


## four regions
Census6_region_four <- merge(Census6_region,China_region_four,by = "Region") %>%
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(Census6_n=sum(n)) %>% 
  dplyr::mutate(Census6_Prop = Census6_n/sum(Census6_n)*100) %>% 
  dplyr::select(1,3)

sum(Census6_region_four$Census6_Prop)

## seven regions
Census6_region_seven <- merge(Census6_region,China_region_seven,by= "Region") %>% 
  dplyr::select(1,2,6) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(Census6_n=sum(n)) %>% 
  dplyr::mutate(Census6_Prop = Census6_n/sum(Census6_n)*100) %>% 
  dplyr::select(1,3)

sum(Census6_region_seven$Census6_Prop)
```


visualize the two cutoff regions
first four region
```{r}
SupplH2_region_four_studytype <- full_join(Journal_region_four_experi,
                                      Journal_region_four_questionaire,
                            by = "Region_four") %>% 
  dplyr::select(-c(n.x,n.y)) %>% ## remove n cols
  dplyr::full_join(H2_region_four,
                   by = "Region_four") %>% 
  dplyr::full_join(Census6_region_four,
                   by= "Region_four")

SupplH2_region_four_studytype2 <- SupplH2_region_four_studytype %>% 
  pivot_longer(cols = -Region_four,
             names_to = "Data Source",
             values_to = "Proportion") %>% 
  dplyr::mutate(Region_four = factor(Region_four,
                                     levels = c("Northeast China","West China",
                                                "Central China","East China")))


## Visualization
SupplH2_Fig_region_four_studytype <- ggplot(data = SupplH2_region_four_studytype2, aes(x = `Data Source`, y = Proportion, fill = Region_four)) +
  geom_col(position = "stack")+
  labs(fill = "Region",x = "Data source")+
  scale_x_discrete(labels =c("experi_Prop" = "Journal experiment study",
                             "questionaire_Prop" = "Journal quantionaire study",
                             "Journal_Prop" = "Journal",
                              "CFPS2018_Prop" = "CFPS2018",
                              "Census7_Prop" = "Census7",
                             "Census6_Prop" = "Census6"))+
  coord_flip()+
  theme_classic()+
  theme(legend.box.spacing = unit(2,"pt"),
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 15, family = "serif"),
        legend.title = element_text(size = 15, family = "serif"),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  guides(fill = guide_legend(ncol = 3))


SupplH2_Fig_region_four_studytype 
```

second, seven region
```{r}
SupplH2_region_seven_studytype <- full_join(Journal_region_seven_experi,
                                      Journal_region_seven_questionaire,
                            by = "Region_seven") %>% 
  dplyr::select(-c(n.x,n.y)) %>% ## remove n cols
  dplyr::full_join(H2_region_seven,
                   by = "Region_seven") %>% 
  dplyr::full_join(Census6_region_seven,
                   by= "Region_seven")

SupplH2_region_seven_studytype2 <- SupplH2_region_seven_studytype %>% 
  pivot_longer(cols = -Region_seven,
             names_to = "Data Source",
             values_to = "Proportion") %>% 
  dplyr::mutate(Region_seven = factor(Region_seven,
                                     levels = c("Northeast China","Northwest China",
                                                "Southwest China","South China",
                                                "North China","Central China",
                                                "East China")))


## Visualization
SupplH2_Fig_region_seven_studytype <- ggplot(data = SupplH2_region_seven_studytype2, aes(x = `Data Source`, y = Proportion, fill = Region_seven)) +
  geom_col(position = "stack")+
  labs(fill = "Region",x = "Data source")+
  scale_x_discrete(labels =c("experi_Prop" = "Journal experiment study",
                             "questionaire_Prop" = "Journal quantionaire study",
                             "Journal_Prop" = "Journal",
                              "CFPS2018_Prop" = "CFPS2018",
                              "Census7_Prop" = "Census7",
                             "Census6_Prop" = "Census6"))+
  coord_flip()+
  theme_classic()+
  theme(legend.box.spacing = unit(2,"pt"),
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 15, family = "serif"),
        legend.title = element_text(size = 15, family = "serif"),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  guides(fill = guide_legend(ncol = 3))


SupplH2_Fig_region_seven_studytype 
```


To use func in main protocal 
```{r}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
     LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```


BF four region on Journal
```{r}
SupplH2_region_four_bayes <- H2_region_four_bayes %>% 
  left_join(Census6_region_four,by = "Region_four") %>% 
  dplyr::rename(Census6 = Census6_Prop)


## Census6
SupplH2_BF_Journal_Census6_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_bayes,
                                          factor = "Region_four",
                                          observed = "Journal",
                                          expected = "Census6")

## Census7
SupplH2_BF_Journal_Census7_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_bayes,
                                          factor = "Region_four",
                                          observed = "Journal",
                                          expected = "Census7")

## CFPS2018
SupplH2_BF_Journal_CFPS2018_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_bayes,
                                          factor = "Region_four",
                                          observed = "Journal",
                                          expected = "CFPS2018")
```


BF seven region on Journal
```{r}
SupplH2_region_seven_bayes <- H2_region_seven_bayes %>% 
  left_join(Census6_region_seven,by = "Region_seven") %>% 
  dplyr::rename(Census6 = Census6_Prop)

## Census6
SupplH2_BF_Journal_Census6_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal",
                                          expected = "Census6")

## Census7
SupplH2_BF_Journal_Census7_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal",
                                          expected = "Census7")

## CFPS2018
SupplH2_BF_Journal_CFPS2018_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal",
                                          expected = "CFPS2018")
```


BF four region on experi 
```{r}
Journal_region_four_experi2 <- Journal_region_four_experi %>% 
  dplyr::select(-n) %>% 
  dplyr::rename(`Journal experiment study` = experi_Prop)

SupplH2_region_four_experi_bayes <- left_join(H2_region_four_bayes,
                                              Journal_region_four_experi2,
                                              by = "Region_four") %>% 
  left_join(Census6_region_four,by = "Region_four") %>% 
  dplyr::rename(Census6 = Census6_Prop)


## Census6
SupplH2_BF_experi_Census6_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_experi_bayes,
                                          factor = "Region_four",
                                          observed = "Journal experiment study",
                                          expected = "Census6")

## Census7
SupplH2_BF_experi_Census7_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_experi_bayes,
                                          factor = "Region_four",
                                          observed = "Journal experiment study",
                                          expected = "Census7")

## CFPS2018
SupplH2_BF_experi_CFPS2018_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_experi_bayes,
                                          factor = "Region_four",
                                          observed = "Journal experiment study",
                                          expected = "CFPS2018")
```


BF seven region on experi 
```{r}
Journal_region_seven_experi2 <- Journal_region_seven_experi %>% 
  dplyr::select(-n) %>% 
  dplyr::rename(`Journal experiment study` = experi_Prop)

SupplH2_region_seven_experi_bayes <- left_join(H2_region_seven_bayes,
                                             Journal_region_seven_experi2,
                                             by = "Region_seven") %>%
  left_join(Census6_region_seven,by="Region_seven") %>% 
  dplyr::rename(Census6 = Census6_Prop)
  

## Census6
SupplH2_BF_experi_Census6_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_experi_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal experiment study",
                                          expected = "Census6")

## Census7
SupplH2_BF_experi_Census7_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_experi_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal experiment study",
                                          expected = "Census7")

## CFPS2018
SupplH2_BF_experi_CFPS2018_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_experi_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal experiment study",
                                          expected = "CFPS2018")
```


BF four region on questionaire
```{r}
Journal_region_four_questionaire2 <- Journal_region_four_questionaire %>% 
  dplyr::select(-n) %>% 
  dplyr::rename(`Journal questionaire study` = questionaire_Prop)


SupplH2_region_four_questionaire_bayes <- left_join(H2_region_four_bayes,
                                               Journal_region_four_questionaire2,
                                            by = "Region_four") %>%
  left_join(Census6_region_four,by = "Region_four") %>% 
  dplyr::rename(Census6 = Census6_Prop)

  

## census6
SupplH2_BF_questionaire_Census6_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_questionaire_bayes,
                                          factor = "Region_four",
                                          observed = "Journal questionaire study",
                                          expected = "Census6")

## census7
SupplH2_BF_questionaire_Census7_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_questionaire_bayes,
                                          factor = "Region_four",
                                          observed = "Journal questionaire study",
                                          expected = "Census7")

## CFPS2018
SupplH2_BF_questionaire_CFPS2018_region_four <- BayesMultiNomial(dataset = SupplH2_region_four_questionaire_bayes,
                                          factor = "Region_four",
                                          observed = "Journal questionaire study",
                                          expected = "CFPS2018")
```


BF seven region on questionaire
```{r}
Journal_region_seven_questionaire2 <- Journal_region_seven_questionaire %>% 
  dplyr::select(-n) %>% 
  dplyr::rename(`Journal questionaire study` = questionaire_Prop)

SupplH2_region_seven_questionaire_bayes <- left_join(H2_region_seven_bayes,
                                             Journal_region_seven_questionaire2,
                                            by = "Region_seven")%>%
  left_join(Census6_region_seven,by="Region_seven") %>% 
  dplyr::rename(Census6 = Census6_Prop)


## census6
SupplH2_BF_questionaire_Census6_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_questionaire_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal questionaire study",
                                          expected = "Census6")

## census7
SupplH2_BF_questionaire_Census7_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_questionaire_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal questionaire study",
                                          expected = "Census7")

## CFPS2018
SupplH2_BF_questionaire_CFPS2018_region_seven <- BayesMultiNomial(dataset = SupplH2_region_seven_questionaire_bayes,
                                          factor = "Region_seven",
                                          observed = "Journal questionaire study",
                                          expected = "CFPS2018")
```


And then, I will visualize the map for the region data of Chinese subjects
Combine all region data and load color data
```{r}
## combine region data
Journal_region_experi2 <- Journal_region_experi %>% 
  dplyr::rename(n = Sample_Size)
Journal_region_questionaire <- Journal_region_questionaire %>% 
  dplyr::rename(n = Sample_Size)

Region_map_data <-  bind_rows(Journal_region_experi2,
                              Journal_region_questionaire,
                              Journal_region_general_tab2,
                              Census7_region,
                              Census6_region)

## combine color data and region data
Region_data <- dplyr::left_join(Region_map_data,Region_map_color,by = join_by(Region)) %>% 
  dplyr::mutate(QUHUADAIMA = ifelse(Region == "", "500000", QUHUADAIMA),
                Color = ifelse(Count_Bins == "<1",1,
                               ifelse(Count_Bins == "1~5",2,
                                      ifelse(Count_Bins == "5~10",3,4))),
                Color = factor(Color, levels = c("1", "2", "3", "4"))) %>% 
  tidyr::pivot_wider(names_from = Data_Source,values_from = c(Proportion, Count_Bins,n,Color)) %>% 
  dplyr::mutate(across(3:ncol(.),~ifelse(is.na(.),0,.)))
```


Finally, I visualized geographic distribution and calculated Bayesian multinomial test for region.
```{r}
API_pre <-  "http://xzqh.mca.gov.cn/data/"
## 
China <-  st_read(dsn = paste0(API_pre, "quanguo.json"), stringsAsFactors=FALSE) 
##  4326 
st_crs(China) <-  4326

# 
China_line <-  st_read(dsn = paste0(API_pre, "quanguo_Line.geojson"), stringsAsFactors=FALSE) 
st_crs(China_line) <-  4326
## 
gjx <- China_line[China_line$QUHUADAIMA == "guojiexian",]

China <- dplyr::left_join(China,Region_data,by= "QUHUADAIMA")



## Chinese journal papers in general population
SupplH2_Fig_region_general <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_region_general_population))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5,
                                  margin = margin(b = 5)),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering(),
                         height = unit(0.8, "cm"),
                         width = unit(0.6, "cm") )



## Journal experi
SupplH2_Fig_Journal_experi_region <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_experi))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal experiment study") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5,
                                  margin = margin(b = 5)),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.margin = margin(t = 5, b = 5), 
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())


## questionaire
SupplH2_Fig_Journal_questionaire_region <- ggplot() +
  geom_sf(data = China,aes(fill = factor(Color_Journal_questionaire))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Journal questionaire study") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5,
                                  margin = margin(b = 5)),
        legend.title = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())


SupplH2_Fig_region_studytype <- SupplH2_Fig_region_general + SupplH2_Fig_Journal_experi_region + SupplH2_Fig_Journal_questionaire_region +
  plot_layout(ncol = 3, nrow = 1, heights = c(2,2))+
  plot_annotation(tag_levels = 'A',
                  theme = theme(plot.title = element_text(size = 16))) + 
  theme(plot.tag = element_text(size = 16))


ggsave("SupplH2_Fig_region_studytype.pdf", SupplH2_Fig_region_studytype, device = "pdf", width=10, height = 6)

SupplH2_Fig_region_studytype
```


## Bibliometric Analysis
BTS data
```{r}
## load BTS data
BTS_keywords <- readxl::read_xlsx("D://chin-subj//2_Data_Extraction//2_2_BTS//BTS_keywords.xlsx")

## split keyword
BTS_keywords_split_rows <- BTS_keywords %>% 
  dplyr::filter(!is.na(Article_Keywords)) %>% 
  tidyr::separate_rows(Article_Keywords,sep = ";") %>% 
  dplyr::mutate(Article_Keywords =  str_to_title(Article_Keywords),
                Article_Keywords = ifelse(Article_Keywords == "Covid-19", "COVID-19",
                                          Article_Keywords))

                
## tab
BTS_keywords_tab <- BTS_keywords_split_rows %>% 
  dplyr::group_by(Article_Keywords) %>% 
  dplyr::summarise(n = n())

sum(BTS_keywords_tab$n)
```


BTS wordcloud
```{r}
Fig_BTS_wordcloud <- ggplot(BTS_keywords_tab, 
                        aes(label = Article_Keywords, 
                            size = n, 
                            color = Article_Keywords)) +
  geom_text_wordcloud(shape = "square", 
                      alpha = 0.8) +
  scale_size_area(max_size = 8) +
  theme_void()

ggsave("Fig_BTS_wordcloud.pdf", Fig_BTS_wordcloud, device = "pdf", width=10, height = 6)

Fig_BTS_wordcloud
```


Journal data
```{r}
Journal_keywords <- read.xlsx("C://Users//ynian//Desktop//cnki//Chin_Subj_Journal_Keywords.xlsx",
                              sheetIndex = 1)


Journal_keywords2 <- Journal_keywords %>% 
  dplyr::select(Article_IDs,Article_Title,`Keyword.`,`Year.`) %>% 
  dplyr::rename(Keywords = 3 , Year = 4) %>% 
  tidyr::separate_rows(3, sep = "[;,.\\s|]+") %>% 
  group_by(Keywords) %>%
  summarise(tab = n(), .groups = "drop") %>%
  arrange(desc(tab))


## split year
Journal_keywords_tab <- Journal_keywords %>% 
  dplyr::select(Article_IDs,Article_Title,`Keyword.`,`Year.`) %>% 
  dplyr::rename(Keywords = 3 , Year = 4) %>% 
  tidyr::separate_rows(3, sep = "[;,.\\s|]+") %>% 
  dplyr::mutate(Year = case_when(Year %in% c("2017","2018") ~ "2018",
                                 Year %in% c("2020","2021") ~ "2021",
                                 TRUE ~ Year)) %>% 
  group_by(Year, Keywords) %>%
  summarise(tab = n(), .groups = "drop") %>%
  arrange(Year, desc(tab))


## filter 69
## total
Journal_keywords_tab69 <- Journal_keywords_tab %>% 
  arrange(desc(tab)) %>% 
  select(Keywords,tab) %>% 
  slice(1:84)

## different period
Journal_keywords_tab2008 <- Journal_keywords_tab %>% 
  dplyr::filter(Year == "2008") %>% 
  select(Keywords,tab) %>% 
  arrange(desc(tab)) %>% 
  slice(1:84)


Journal_keywords_tab2018 <- Journal_keywords_tab %>% 
  dplyr::filter(Year == "2018") %>% 
  select(Keywords,tab) %>% 
  arrange(desc(tab)) %>% 
  slice(1:84)


Journal_keywords_tab2021 <- Journal_keywords_tab %>% 
  dplyr::filter(Year == "2021") %>% 
  select(Keywords,tab) %>% 
  arrange(desc(tab)) %>% 
  slice(1:84)
```


Journal wordcloud
```{r}
# library(pcutils)
# set_pcutils_config('baidu_appid', "20240711002097071")
# set_pcutils_config('baidu_key', "8m0lLVSrtwvfMVxk5")


Journal_keywords3 <- Journal_keywords2 %>% 
  arrange(desc(tab)) %>% 
  slice(1:84) 

## save data and convert Chinese keywords into English keywords

# writexl::write_xlsx(Journal_keywords3,"Journal_keywords3.xlsx")


Journal_keywords4 <-  readxl::read_xlsx("Journal_keywords3.xlsx") %>% 
  dplyr::group_by(en) %>% 
  dplyr::mutate(tab = sum(tab)) %>%
  dplyr::slice(1) %>%
  dplyr::arrange(desc(tab))


## plot
Journal_wordcloud <- Journal_keywords4 %>% 
  ggplot(aes(label = en, 
             size = tab, 
             color = en)) +
  geom_text_wordcloud(shape = "square", 
                      alpha = 0.8) +
  scale_size_area(max_size = 8) +
  theme_void()



ggsave("Journal_wordcloud.pdf", Journal_wordcloud, device = "pdf", width=10, height = 6)


Journal_wordcloud 


```


Venn diagram
```{r}
# install.packages("ggvenn")
# library(ggvenn)

BTS_keywords_venn <- BTS_keywords_tab %>%
  dplyr::rename(Keywords = 1, Freq_en = 2) %>% 
  dplyr::mutate(Keywords = str_to_lower(Keywords))

# writexl::write_xlsx(BTS_keywords_upset,"BTS_keywords_upset.xlsx")


Journal_keywords_venn <- Journal_keywords4 %>%
  dplyr::select(en,tab) %>%
  dplyr::rename(Keywords = 1, Freq_ch = 2) %>% 
  dplyr::mutate(Keywords = str_to_lower(Keywords))

# writexl::write_xlsx(Journal_keywords_upset,"Journal_keywords_upset.xlsx")


# Keywords_venn_data <- list(BTS = BTS_keywords_venn$Keywords,
#      Journal = Journal_keywords_venn$Keywords)

key2 <- full_join(BTS_keywords_venn,Journal_keywords_venn, by = "Keywords") %>% 
  dplyr::mutate(BTS = ifelse(is.na(Freq_en),0,Freq_en),
                Journal = ifelse(is.na(Freq_ch),0,Freq_ch)) %>% 
  dplyr::select(Keywords,BTS,Journal)

# Keywords_venn <- ggvenn(key2,
#        element_column = "Keywords",
#        label_sep = " ")
# 
# Keywords_venn
# 
# ggsave("Keywords_venn.pdf", Keywords_venn, device = "pdf", width=10, height = 6)


key2 <- as.data.frame(key2)
rownames(key2) <- key2$Keywords

key2 <- key2 %>% 
  dplyr::select(-1)

pdf("Keywords_venn.pdf", width=10, height=6)

venn(key2, mode = "network",label = 2,  
     vertex.label.cex = 0.8)

dev.off()
```
