---
title: "Notebook_Exploration_Analysis"
author: "Lei Yue"
date: "2025-05-13"
output: html_document
---



## intall library
```{r}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")

p_load("tidyverse","ggplot2")
```



## Load data
```{r}
load("Journal.Rdata")
```


## Journal report
```{r}
Journal_year2008_report <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2008") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_year2008_report )){
  
  
  report_table <- data.frame(table(Journal_year2008_report [[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_year2008_report [i]),
                  proportion = round(Freq / sum(Freq),4))
  
  report_list[[i]] <- report_table
  
}

Journal_year2008_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_year2008_education_occupation <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2008") %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_year2008_education_occupation$Educational_Attainment_N) ## FALSE 32 TRUE 30
table(Journal_year2008_education_occupation$Occupation_N)  ## FALSE 35 TRUE 27


Journal_year2008_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(34,31,36,29),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(0.52,0.48,0.55,0.45))

Journal_year2008_report2 <- rbind(Journal_year2008_report,
                                  Journal_year2008_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Recruitment Method",
                                              "Recruitment Area",
                                              "Age","Educational Attainment",
                                              "Occupation","Sampling Method",
                                              "SES","Ethnicity","Religious"),
                                   levels = c("Gender","Recruitment_Method",
                                              "Recruitment_Area",
                                              "Age","Educational_Attainment",
                                              "Occupation","Sampling_Method",
                                              "SES","Ethnicity","Religious")),
                proportion = proportion *100) %>% 
  dplyr::mutate(Year = "2008")

```


```{r}
Journal_year2018_report <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2018") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_year2018_report )){
  
  
  report_table <- data.frame(table(Journal_year2018_report [[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_year2018_report [i]),
                  proportion = round(Freq / sum(Freq),4))
  
  report_list[[i]] <- report_table
  
}

Journal_year2018_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_year2018_education_occupation <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2018") %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_year2018_education_occupation$Educational_Attainment_N) ## FALSE 73 TRUE 69
table(Journal_year2018_education_occupation$Occupation_N)  ## FALSE 84 TRUE 58


Journal_year2018_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(73,76,90,59),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(0.49,0.51,0.60,0.40))

Journal_year2018_report2 <- rbind(Journal_year2018_report,
                                  Journal_year2018_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment Method",
                                              "Recruitment Area",
                                              "Educational Attainment",
                                              "Occupation","Sampling Method",
                                              "SES","Ethnicity","Religious"),
                                   levels = c("Gender","Age","Recruitment_Method",
                                              "Recruitment_Area",
                                              "Educational_Attainment",
                                              "Occupation","Sampling_Method",
                                              "SES","Ethnicity","Religious")),
                proportion = proportion *100)%>% 
  dplyr::mutate(Year = "2018")

```


```{r}
Journal_year2021_report <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2021") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0,
                   .groups = "drop") %>% 
  dplyr::select(3:last_col())


report_list <- list()

for (i in names(Journal_year2021_report )){
  
  
  report_table <- data.frame(table(Journal_year2021_report [[i]])) %>% 
    dplyr::mutate(col_names = names(Journal_year2021_report [i]),
                  proportion = round(Freq / sum(Freq),4))
  
  report_list[[i]] <- report_table
  
}

Journal_year2021_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 


### Calculate reported status of Educational_Attainment and Occupation
Journal_year2021_education_occupation <- Journal %>% 
  dplyr::filter(substr(Article_IDs_N,1,4) == "2021") %>% 
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                   Occupation_N = max(Occupation_N) > 0,.groups = "drop") 



table(Journal_year2021_education_occupation$Educational_Attainment_N) ## FALSE 55 TRUE 33
table(Journal_year2021_education_occupation$Occupation_N)  ## FALSE 72 TRUE 16


Journal_year2021_education_occupation_table <- data.frame(Var1 = c("Unreported","Reported",
                                                            "Unreported","Reported"),
                                                   Freq = c(57,34,74,17),
                                                   col_names= c("Educational_Attainment",
                                                                "Educational_Attainment",
                                                                "Occupation","Occupation"),
                                                   proportion = c(0.63,0.37,0.81,0.19))

Journal_year2021_report2 <- rbind(Journal_year2021_report,
                                  Journal_year2021_education_occupation_table) %>%
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment Method",
                                              "Recruitment Area","Sampling Method",
                                              "Educational Attainment",
                                              "SES","Occupation",
                                              "Ethnicity","Religious"),
                                   levels = c("Gender","Age","Recruitment_Method",
                                              "Recruitment_Area","Sampling_Method",
                                              "Educational_Attainment",
                                              "SES","Occupation",
                                              "Ethnicity","Religious")),
                proportion = proportion *100)%>% 
  dplyr::mutate(Year = "2021")
```


combine three data
```{r}
Journal_report <- bind_rows(Journal_year2008_report2,Journal_year2018_report2,Journal_year2021_report2) %>% 
  dplyr::filter(Var1 == "Reported") %>% 
  dplyr::add_row(data.frame(Var1 = c("Reported","Reported"),
                            Freq = c(0,0),
                            col_names = c("Religious","Religious"),
                            proportion = c(0,0),
                            Year = c("2008","2021"))) %>% 
  dplyr::mutate(col_names = factor(col_names,
                                   levels = c("Gender","Recruitment Method","Recruitment Area",
                                              "Age","Educational Attainment","Occupation",
                                              "Sampling Method","SES","Ethnicity",
                                              "Religious"),
                                   labels = c("Gender","Recruitment Method","Recruitment Area",
                                              "Age","Educational Attainment","Occupation",
                                              "Sampling Method","SES","Ethnicity",
                                              "Religious")))

Journal_report_year <- Journal_report %>% 
  ggplot(aes(x = Year, y = proportion, color = col_names, group = col_names))+
  geom_line(size = 1)+
  geom_point(size = 3)+
  labs(y="Proportion", x = "Year")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

ggsave("Journal_report_year.pdf", Journal_report_year, device = "pdf", width=12, height = 9)


Journal_report_year
```


## Two data sources are respectively compared with the census data and CFPS

load data
```{r}
load("H2_BTS_Journal_age_edu.RData")
```


create BF func, It is consistent with the analyzed function in the formal Rmd.
```{r}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
     LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```

and then, I process the data of age and edu
## age

visualize
```{r}
## BTS
H1_age_general_BTS <- H1_age_general %>% 
  dplyr::filter(Data_Source == "BTS Chinese")

## Journal
H1_age_general_Journal <- H1_age_general %>% 
  dplyr::filter(Data_Source == "Journal")


S3_age_general <- ggplot(data= Census7_age_five5, 
       aes(x=ageBins, y = Proportion, fill="Census7")) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = H1_age_general_BTS, 
            aes(x = ageBins, y = Proportion, group = 1, color = "BTS Chinese"), 
            size = 1) +
  geom_line(data = H1_age_general_Journal, 
            aes(x = ageBins, y = Proportion, group = 1, color = "Journal"), 
            size = 1) +
  scale_fill_manual(values = c("Census7" = "#00BFC4")) +  
  scale_color_manual(values = c("BTS Chinese" = "blue", "Journal" = "red")) +
  scale_y_continuous(limits = c(0,50))+
  coord_flip() +
  labs(y="Proportion", x = "Age bins")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))


S3_age_general






ggsave("S3_age_general.pdf",S3_age_general, device = "pdf", width=18, height = 9)

S3_age_general
```


BF
```{r}
## PsyStages
S_Census7_age_PsyStages <- Census7_age_PsyStages %>% 
  dplyr::select(ageBins,Proportion) %>% 
  dplyr::rename(Census7 = 2)


## interval10
S_Census7_age_interval10 <- Census7_age_interval10 %>% 
  dplyr::select(ageBins,Proportion) %>% 
  dplyr::rename(Census7 = 2)


## combine data
## PsyStages
S_BF_PsyStages <- left_join(H1_PsyStages_bayes_general,S_Census7_age_PsyStages,by = "ageBins")


## interval10
S_BF_interval10 <- left_join(H1_interval10_bayes_general,S_Census7_age_interval10,
                             by = "ageBins")


## BF
## BTS PsyStages
S3_BF_Psystages_BTS_Census <- BayesMultiNomial(dataset = S_BF_PsyStages,
                                             factor = "ageBins",
                                             observed = "BTS Chinese",
                                             expected = "Census7")


## BTS interval10
S3_BF_interval10_BTS_Census <- BayesMultiNomial(dataset = S_BF_PsyStages,
                                             factor = "ageBins",
                                             observed = "BTS Chinese",
                                             expected = "Census7")


## Journal PsyStages
S3_BF_Psystages_Journal_Census <- BayesMultiNomial(dataset = S_BF_interval10,
                                             factor = "ageBins",
                                             observed = "Journal",
                                             expected = "Census7")

## Journal interval10
S3_BF_interval10_Journal_Census <- BayesMultiNomial(dataset = S_BF_interval10,
                                             factor = "ageBins",
                                             observed = "Journal",
                                             expected = "Census7")
```


## edu
process data
```{r}
## Census
S_Census7_college <- Census7_college %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(Census7 = 2)

S_Census7_high_school <- Census7_high_school %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(Census7 = 2)


## CFPS
S_CFPS2018_edu_college <- CFPS2018_edu_college %>%
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(CFPS2018 = 2)


S_CFPS2018_edu_high_school <- CFPS2018_edu_high_school %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(CFPS2018 = 2)


## combine all data
S_college <- left_join(H1_edu_college_bayes, S_Census7_college, by = "Educational_attainment") %>% 
  left_join(S_CFPS2018_edu_college,by = "Educational_attainment")


S_highschool <- left_join(H1_edu_highschool_bayes, S_Census7_high_school, by = "Educational_attainment") %>% 
  left_join(S_CFPS2018_edu_high_school,by = "Educational_attainment")
```


BF
```{r}
## College
S_BF_college_BTS_Census <-  BayesMultiNomial(dataset = S_college,
                                             factor = "Educational_attainment",
                                             observed = "BTS Chinese",
                                             expected = "Census7")

S_BF_college_Journal_Census <-  BayesMultiNomial(dataset = S_college,
                                             factor = "Educational_attainment",
                                             observed = "Journal",
                                             expected = "Census7")


## high school
S_BF_highschool_BTS_Census <-  BayesMultiNomial(dataset = S_highschool,
                                             factor = "Educational_attainment",
                                             observed = "BTS Chinese",
                                             expected = "Census7")

S_BF_highschool_Journal_Census <-  BayesMultiNomial(dataset = S_highschool,
                                             factor = "Educational_attainment",
                                             observed = "Journal",
                                             expected = "Census7")
```


## Abstract report
Abstract1 subjects information reported of Chinese journal
```{r message=FALSE, warning=FALSE}
## all data
Journal_abstract1_report <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(Sample_Type_N != 5) %>%
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(Abstract1 == "0" ,"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)


## Chi
matrix_Journal_abstract1_report <- matrix(c(223, 195), nrow = 1)
colnames(matrix_Journal_abstract1_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_Journal_abstract1_report) <- "Only college students"

matrix_Journal_abstract1_result <- chisq.test(matrix_Journal_abstract1_report)
matrix_Journal_abstract1_result 
```


I would like to explore whether there are differences in specific demographic information.

Mention in sample type
```{r}
## all data
Journal_abstract1_sampletype_report <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(Sample_Type_N != 5) %>%
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(grepl("1", Abstract1),"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)
```


Chi-sqaure test
```{r}
## sample type mentioned for colleges
matrix_abstract1_sampletype_report <- matrix(c(212, 206), nrow = 1)
colnames(matrix_abstract1_sampletype_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_abstract1_sampletype_report) <- "Only college students"


matrix_abstract1_sampletype_result <- chisq.test(matrix_abstract1_sampletype_report)
matrix_abstract1_sampletype_result



## I also try to analysis "Only sample outside colleges"
matrix_outside_colleges_report <- matrix(c(43, 401), nrow = 1)
colnames(matrix_outside_colleges_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_outside_colleges_report) <- "Only sample outside colleges"


matrix_matrix_outside_colleges_result <- chisq.test(matrix_outside_colleges_report)
matrix_matrix_outside_colleges_result


## colleges and others samples
matrix_colleges_andothers_report <- matrix(c(11, 30), nrow = 1)
colnames(matrix_colleges_andothers_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_colleges_andothers_report) <- "College students & other populations"


matrix_colleges_andothers_result <- chisq.test(matrix_colleges_andothers_report)
matrix_colleges_andothers_result 
```


Filter  2021 article and analysis abstract1 report
```{r} 
## all data
Journal_abstract1_year2021_report <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(substr(Article_IDs,1,4) == "2021") %>% 
  dplyr::filter(Sample_Type_N != 5) %>%
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(Abstract1 == "0" ,"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)


## sample type
Journal_abstract1_year2021_sampletype_report <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Target_Population_N,Sample_Type_N,Abstract1) %>% 
  dplyr::filter(substr(Article_IDs,1,4) == "2021") %>% 
  dplyr::filter(Sample_Type_N != 5) %>%
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Study_Type = ifelse(all(Sample_Type_N == 1),"Only college students",ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),"College students & other populations","Only sample outside colleges"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Sample_Mentioned = ifelse(grepl("1", Abstract1),"Samples mentioned", "Sample not mentioned")) %>% 
  dplyr::group_by(Sample_Mentioned,Study_Type) %>% 
  dplyr::count() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = Sample_Mentioned, values_from = n)
```


```{r}
## sample type mentioned for colleges
matrix_abstract1_sampletype_year2021_report <- matrix(c(62, 42), nrow = 1)
colnames(matrix_abstract1_sampletype_year2021_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_abstract1_sampletype_year2021_report) <- "Only college students"


matrix_abstract1_sampletype_year2021_result <- chisq.test(matrix_abstract1_sampletype_year2021_report)
matrix_abstract1_sampletype_year2021_result



## I also try to analysis "Only sample outside colleges"
matrix_outside_colleges_year2021_report <- matrix(c(99, 4), nrow = 1)
colnames(matrix_outside_colleges_year2021_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_outside_colleges_year2021_report) <- "Only sample outside colleges"


matrix_matrix_outside_colleges_year2021_result <- chisq.test(matrix_outside_colleges_year2021_report)
matrix_matrix_outside_colleges_year2021_result


## colleges and others samples
matrix_colleges_andothers_year2021_report <- matrix(c(16, 1), nrow = 1)
colnames(matrix_colleges_andothers_year2021_report) <- c("Sample not mentioned", "Samples mentioned")
rownames(matrix_colleges_andothers_year2021_report) <- "College students & other populations"


matrix_colleges_andothers_year2021_result <- chisq.test(matrix_colleges_andothers_year2021_report)
matrix_colleges_andothers_year2021_result 
```


Abstract2 report
university students reported in abstract when sample type is 1
```{r}
Journal_abstract2_report <- Journal %>% 
  dplyr::filter(grepl("1",Sample_Type_N)) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Abstract2_same = n_distinct(Abstract2) == 1) %>%  ## check multiple subjects group Abstract2 whether is consistent.
  dplyr::slice(1) %>% ## for one articles have multiple rows, only save the first row
  dplyr::ungroup() %>% 
  dplyr::group_by(Abstract2) %>% 
  dplyr::summarise(report = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(proportion = round(report/sum(report),2),
                Abstract2 = ifelse(Abstract2 == 0 ,"Unreported","Reported")) %>% 
  dplyr::rename(n = 2)


## Chi
matrix_abstract2_report <- matrix(c(241, 218), nrow = 1)
colnames(matrix_abstract2_report) <- c("Unreported", "Reported")

abstract2_result <- chisq.test(matrix_abstract2_report)
abstract2_result
```



## Reason for current data pattern
```{r}
Journal_subjects_recruitment <- Journal %>% 
  dplyr::select(Article_IDs,Article_Title,Study_Number_N,Subjects_Group_N,
                Target_Population_N,Sample_Type_N,Sampling_Method,Subjects_Recruitment_Method_N,
                Subjects_Recruitment_Method_info_N)

table(Journal_subjects_recruitment$Sampling_Method)  ## 0(1064),1(219),2(284)

table(Journal_subjects_recruitment$Subjects_Recruitment_Method_N)
```


```{r}
Journal_subjects_recruitment2 <- Journal_subjects_recruitment %>% 
  dplyr::filter(Target_Population_N != 1)

table(Journal_subjects_recruitment2$Subjects_Recruitment_Method_N)
```


## sample size in different study type
the sample size of different study type
```{r} 
load("Journal_region.RData")


Journal_general_experi <- Journal %>% 
  dplyr::select(Article_IDs_N,Study_Number_N,Study_Type,Sample_Size,Target_Population_N) %>% 
  dplyr::mutate(Sample_Size = ifelse(Article_IDs_N == "20185082", 33, Sample_Size)) %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::filter(Study_Type == 1) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size))


Journal_general_experi_tab <- Journal_general_experi %>% 
  dplyr::distinct(Article_IDs_N,Study_Number_N)  ## distinct article 170  ## distinct article and study number 200

sum(Journal_general_experi$Sample_Size)  ## 22361

## article ~ sample size 
22361/170
## article & study number ~ sample size 
22361/200


## questionnaire
Journal_general_questionaire <- Journal %>% 
  dplyr::select(Article_IDs_N,Study_Number_N,Study_Type,Sample_Size,Target_Population_N) %>% 
  dplyr::filter(Target_Population_N == 1) %>% 
  dplyr::filter(Study_Type == 2) %>% 
  dplyr::mutate(Sample_Size = as.numeric(Sample_Size))



Journal_general_questionaire_tab <- Journal_general_questionaire %>% 
  dplyr::distinct(Article_IDs_N)  ## distinct article 438  ## distinct article and study number 448

sum(Journal_general_questionaire$Sample_Size)  ## 414319

## article ~ sample size 
414319/438
## article & study number ~ sample size 
414319/448
```


exploration analysis region data of Journal based on study type
```{r}
## single region
Journal_region_single_studytype <- Journal %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Study_Type) %>% 
  dplyr::inner_join(Journal_region_single,
                    by = c("Article_IDs","Study_Number","Subjects_Group"))

Journal_region_single_studytype2 <- Journal_region_single_studytype %>% 
  dplyr::filter(Target_Population_N != 1)


## multiple region
Journal_region_multiple_IDs <- Journal_region_multiple %>% 
  dplyr::pull(Article_IDs)

Journal_studytype <- Journal %>% 
  dplyr::filter(Article_IDs %in% Journal_region_multiple_IDs) %>% 
  dplyr::slice(-c(4,11)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Study_Type)

Journal_region_multiple_studytype <- Journal_region_multiple %>% 
  dplyr::inner_join(Journal_studytype, by = c("Article_IDs","Study_Number","Subjects_Group"))

Journal_region_multiple_studytype2 <- Journal_region_multiple_studytype %>% 
  dplyr::filter(Target_Population_N != 1) %>% 
  tidyr::separate_rows(True_Value,sep = ";") %>% 
  tidyr::separate(True_Value,c("Subjects_Recruitment_Area","Sample_Size"),sep = ":") %>% 
  dplyr::mutate(Sample_Size = as.numeric(trimws(Sample_Size)),
                Sample_Size = ceiling(2500 * Sample_Size)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,
                Study_Type,Target_Population_N,Sample_Type_N,
                Sample_Size,Subjects_Recruitment_Area)
  

## combine single region data and multiple region data
Journal_region <- bind_rows(Journal_region_single_studytype2,Journal_region_multiple_studytype2)


## group by study type
Journal_region_experi <- Journal_region %>% 
  dplyr::filter(Study_Type == 1) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(Sample_Size = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
  dplyr::mutate(Proportion = Sample_Size/sum(Sample_Size)*100,
                Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal experi") %>% 
  dplyr::rename(Region = Subjects_Recruitment_Area)


Journal_region_questionaire <- Journal_region %>% 
  dplyr::filter(Study_Type == 2) %>% 
  dplyr::group_by(Subjects_Recruitment_Area) %>% 
  dplyr::summarise(Sample_Size = sum(Sample_Size)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% China_province) %>% 
  dplyr::mutate(Proportion = Sample_Size/sum(Sample_Size)*100,
                Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")),
                Data_Source = "Journal questionaire") %>% 
  dplyr::rename(Region = Subjects_Recruitment_Area)
```


convert Journal data into four regions and seven regions
```{r}
## four regions & experi
Journal_region_experi_four <- merge(Journal_region_experi,China_region_four,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_four) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(Regionfour_n=sum(Sample_Size)) 


## seven regions & experi
Journal_region_experi_seven <- merge(Journal_region_experi,China_region_seven,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_seven) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(Regionseven_n=sum(Sample_Size)) 


## four regions & questionaire
Journal_region_questionaire_four <- merge(Journal_region_questionaire, China_region_four,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_four) %>% 
  dplyr::group_by(Region_four) %>% 
  dplyr::summarise(Regionfour_n=sum(Sample_Size)) 

##seven regions & questionaire
Journal_region_questionaire_seven <- merge(Journal_region_questionaire, China_region_seven,
                              by = "Region") %>% 
  dplyr::select(Region, Sample_Size, Data_Source, Region_seven) %>% 
  dplyr::group_by(Region_seven) %>% 
  dplyr::summarise(Regionfour_n=sum(Sample_Size)) 
```


