---
title: "Notebook_Chi_Square_BF_CHN_Sample_Stage2_RR_V1"
author: "Lei Yue"
date: "2024-04-20"
output:
  prettydoc::html_pretty:
  theme: cayman
  highlight: github
---

In this document, I use Chi-Square bayes analysis to enhance the robustness of the Bayesian multinomial test results. The naming of data variables is consistent with "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V2".


Now, I start to analysis data. and the first thing is load library.


# Install and Load packages
```{r message=FALSE, warning=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")

# use package "pacman" as loading R packages tools

pacman::p_load("tidyverse","here","rio")
pacman::p_load("geojsonsf","sf","RColorBrewer","ggspatial","patchwork","ggrepel","maps")
pacman::p_load("truncnorm","BayesFactor", "gtools", "bruceR")
```


And then, I loaded the data. The data includes data from the first Stage 1 of the pre-registration report (primarily Census data and CFPS2018 data), Chinese journal coding data, and data from large-scale international collaboration projects (BTS).


# Load data

```{r}
load("Chi_Square_bayes.RData")
```


Here, I define the function for converting chi square values and df to Bayesian factors.

The purpose of subtracting thresh in the froot() function is to compute the optimal noncentral parameter lambda. To calculate the Bayes factor, use the front_bf() function.


```{r}
froot_bf <- function(x, lambda, df){
 dchisq(x, df, ncp = lambda)/dchisq(x, df)
}

froot <- function(x, lambda, thresh, df){
 dchisq(x, df, ncp = lambda)/dchisq(x, df) - thresh
 }

 f1 <- function(lambda, thresh, df){
 r <- uniroot(froot, lambda = lambda, thresh = thresh, df = df, c(0.01, 1000))$root
 }
 vf1 <- Vectorize(f1)
 
 UMPBT <- function(df, thresh){
 optout <- optimize(vf1, c(0, 100),thresh = thresh, df = df)
 z <- optout$minimum
 return(z)
 }
```
 
 
And then, I test three hypothesis respectively.

# Test three hypotheses
## Test the 1st hypothesis
### Gender

Here I tested whether the gender proportion distribution from Chinese five journal data are similar to that of the BTS data. I used the self-define func to calculate.

$H_0$: $\theta = c$, where $c$ is defined by Chinese five journal data; $H_1$: $\theta$ is free to vary.

I compared the general population between the two.


The target population is genderal
```{r}
## convert data
H1_gender_bayes_general <- H1_gender_general %>% 
  dplyr::filter(Data_Source == "BTS Chinese") %>% 
  dplyr::select(Gender, `BTS Chinese` = n) %>% 
  dplyr::left_join(H1_gender_general %>% 
                     filter(Data_Source == "Journal") %>% 
                     select(Gender, Journal = Proportion),
                   by = "Gender") %>% 
  dplyr::mutate(Journal = Journal*0.01)


## trans 2000
H1_gender_bayes_general <- H1_gender_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`BTS Chinese`),
                `BTS Chinese New` = floor(Scaling_factor *`BTS Chinese`),
                Dif = 2000 - sum(`BTS Chinese New`),
                `BTS Chinese New` = ifelse(row_number() == 1, `BTS Chinese New` + Dif, `BTS Chinese New`))


## calculate Chi-square
observed1 <- H1_gender_bayes_general$`BTS Chinese New`
expected1 <- H1_gender_bayes_general$Journal

H1_Chi_gender_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_gender_general


## calculate BF
lambda <- UMPBT(df = H1_Chi_gender_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H1_Chi_gender_general$statistic, lambda = lambda, df = H1_Chi_gender_general$parameter)

H1_BF_gender_general <- log(BF1)

H1_BF_gender_general 

## rm 
rm(observed1,expected1,BF1)
```


The target population is special
```{r}
H1_gender_bayes_special <- Lucca_gender_special %>% 
  dplyr::select(Gender,n) %>% 
  dplyr::rename(Lucca = 2) %>% 
  dplyr::mutate(Journal = c(Journal_gender_special$Female_Proportion,
                            Journal_gender_special$Male_Proportion)) %>% 
  dplyr::mutate(Journal = Journal * 0.01)


## calculate Chi-square
observed1 <- H1_gender_bayes_special$Lucca
expected1 <- H1_gender_bayes_special$Journal


H1_Chi_gender_special <- chisq.test(x = observed1, p = expected1)
H1_Chi_gender_special


## calculate BF
lambda <- UMPBT(df = H1_Chi_gender_special$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H1_Chi_gender_special$statistic, lambda = lambda, df = H1_Chi_gender_special$parameter)

H1_BF_gender_special <- log(BF1)

H1_BF_gender_special 

## rm 
rm(observed1,expected1,BF1)
```


### age
PsyStages
```{r}
## convert data 
H1_PsyStages_bayes_general <- Sim_Journal_age_PsyStages3_general %>% 
  dplyr::mutate(Journal = sim1/sum(sim1)) %>% 
  dplyr::left_join(BTS_age_PsyStages_CHN_general %>% 
                     select(ageBins,n),
                   by = "ageBins") %>% 
  dplyr::rename(`BTS Chinese` = 4) %>% 
  dplyr::select(ageBins,Journal,`BTS Chinese`)


## trans 2000
H1_PsyStages_bayes_general <- H1_PsyStages_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`BTS Chinese`),
                `BTS Chinese New` = floor(Scaling_factor * `BTS Chinese`),
                Dif = 2000 - sum( `BTS Chinese New`),
                 `BTS Chinese New` = ifelse(row_number() == 1,
                                             `BTS Chinese New` + Dif,
                                             `BTS Chinese New`))


## calculate Chi-square
observed1 <- H1_PsyStages_bayes_general$`BTS Chinese New`
expected1 <- H1_PsyStages_bayes_general$Journal


H1_Chi_PsyStages_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_PsyStages_general


## calculate BF
lambda <- UMPBT(df = H1_Chi_PsyStages_general$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H1_Chi_PsyStages_general$statistic, lambda = lambda, df = H1_Chi_PsyStages_general$parameter)

H1_BF_PsyStages_general <- log(BF1)

H1_BF_PsyStages_general 

## rm 
rm(observed1,expected1,BF1)
```


interval10
```{r}
## convert data
H1_interval10_bayes_general <- Sim_Journal_age_interval103_general %>% 
  dplyr::mutate(Journal = sim1/sum(sim1)) %>% 
  dplyr::left_join(BTS_age_interval10_CHN_general %>% 
                     select(ageBins,n),
                   by = "ageBins") %>% 
  dplyr::rename(`BTS Chinese` = 4) %>% 
  dplyr::select(ageBins,Journal,`BTS Chinese`)


## trans 2000
H1_interval10_bayes_general <- H1_interval10_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`BTS Chinese`),
                `BTS Chinese New` = floor(Scaling_factor * `BTS Chinese`),
                Dif = 2000 - sum( `BTS Chinese New`),
                `BTS Chinese New` = ifelse(row_number() == 1,
                                             `BTS Chinese New` + Dif,
                                             `BTS Chinese New`))


## calculate Chi-square
observed1 <- H1_interval10_bayes_general$`BTS Chinese New`
expected1 <- H1_interval10_bayes_general$Journal


H1_Chi_interval10_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_interval10_general


## calculate BF
lambda <- UMPBT(df = H1_Chi_interval10_general$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H1_Chi_interval10_general$statistic, lambda = lambda, df = H1_Chi_interval10_general$parameter)

H1_BF_interval10_general <- log(BF1)

H1_BF_interval10_general 

## rm 
rm(observed1,expected1,BF1)
```


### Edu
college
```{r}
## convert data
H1_edu_college_bayes <- H1_edu_college %>% 
  dplyr::filter(Data_source == "Journal") %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(Journal = 2) %>% 
  dplyr::mutate(Journal = Journal * 0.01) %>% 
  dplyr::left_join(H1_edu_college %>% 
                     filter(Data_source == "BTS Chinese") %>% 
                     select(Educational_attainment,Num) %>% 
                     rename(`BTS Chinese` = 2),
                   by = "Educational_attainment")


## trans 2000
H1_edu_college_bayes <- H1_edu_college_bayes %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`BTS Chinese`),
                `BTS Chinese New` = floor(Scaling_factor * `BTS Chinese`),
                Dif = 2000 - sum( `BTS Chinese New`),
                `BTS Chinese New` = ifelse(row_number() == 1,
                                             `BTS Chinese New` + Dif,
                                             `BTS Chinese New`))

## calculate Chi-square
observed1 <- H1_edu_college_bayes$`BTS Chinese New`
expected1 <- H1_edu_college_bayes$Journal


H1_Chi_college <- chisq.test(x = observed1, p = expected1)
H1_Chi_college


## calculate BF
lambda <- UMPBT(df = H1_Chi_college$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H1_Chi_college$statistic, lambda = lambda, df = H1_Chi_college$parameter)

H1_BF_college <- log(BF1)

H1_BF_college 

## rm 
rm(observed1,expected1,BF1)
```


high school
```{r}
## convert data
H1_edu_highschool_bayes <- H1_edu_highschool %>% 
  dplyr::filter(Data_source == "Journal") %>% 
  dplyr::select(Educational_attainment,Proportion) %>% 
  dplyr::rename(Journal = 2) %>% 
  dplyr::mutate(Journal = Journal * 0.01) %>% 
  dplyr::left_join(H1_edu_highschool %>% 
                     filter(Data_source == "BTS Chinese") %>% 
                     select(Educational_attainment,Num) %>% 
                     rename(`BTS Chinese` = 2),
                   by = "Educational_attainment")


## trans 2000
H1_edu_highschool_bayes <- H1_edu_highschool_bayes %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`BTS Chinese`),
                `BTS Chinese New` = floor(Scaling_factor * `BTS Chinese`),
                Dif = 2000 - sum( `BTS Chinese New`),
                `BTS Chinese New` = ifelse(row_number() == 1,
                                             `BTS Chinese New` + Dif,
                                             `BTS Chinese New`))

## calculate Chi-square
observed1 <- H1_edu_highschool_bayes$`BTS Chinese New`
expected1 <- H1_edu_highschool_bayes$Journal


H1_Chi_highschool <- chisq.test(x = observed1, p = expected1)
H1_Chi_highschool 


## calculate BF
lambda <- UMPBT(df = H1_Chi_highschool$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H1_Chi_highschool$statistic, lambda = lambda, df = H1_Chi_highschool$parameter)

H1_BF_highschool <- log(BF1)

H1_BF_highschool 

## rm 
rm(observed1,expected1,BF1)
```


## Test the 2ed hypothesis
### Gender
First, process Data for the General Population.
```{r}
H2_gender_bayes_general <- H2_gender_general %>% 
  dplyr::filter(Data_source == "Chinese subjects") %>% 
  dplyr::select(Gender,n) %>% 
  dplyr::rename(`Chinese subjects` = 2) %>% 
  dplyr::left_join(H2_gender_general %>% 
                     filter(Data_source == "Census7") %>% 
                     select(Gender,Proportion) %>% 
                     rename(Census7 = 2) %>% 
                     mutate(Census7 = Census7 * 0.01),
                   by = "Gender") %>% 
  dplyr::left_join(H2_gender_general %>% 
                     filter(Data_source == "CFPS2018") %>% 
                     select(Gender,Proportion) %>% 
                     rename(CFPS2018 = 2) %>% 
                     mutate(CFPS2018 = CFPS2018 * 0.01),
                   by = "Gender")


## trans 2000
H2_gender_bayes_general <- H2_gender_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`Chinese subjects`),
                `Chinese subjects New` = floor(Scaling_factor * `Chinese subjects`),
                Dif = 2000 - sum( `Chinese subjects New`),
                `Chinese subjects New` = ifelse(row_number() == 1,
                                             `Chinese subjects New` + Dif,
                                             `Chinese subjects New`))

```


Census 7 vs Chinese subjects
```{r}
## calculate Chi-square
observed1 <- H2_gender_bayes_general$`Chinese subjects New`
expected1 <- H2_gender_bayes_general$Census7


H1_Chi_gender_bayes_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_gender_bayes_general 


## calculate BF
lambda <- UMPBT(df = H1_Chi_gender_bayes_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H1_Chi_gender_bayes_general$statistic, lambda = lambda, df = H1_Chi_gender_bayes_general$parameter)

H1_BF_gender_bayes_general <- log(BF1)

H1_BF_gender_bayes_general

## rm 
rm(observed1,expected1,BF1)
```


CFPS2018 vs Chinese sujects
```{r}
rm(H1_Chi_gender_bayes_general,H1_BF_gender_bayes_general)
## calculate Chi-square
observed1 <- H2_gender_bayes_general$`Chinese subjects New`
expected1 <- H2_gender_bayes_general$CFPS2018


H1_Chi_gender_bayes_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_gender_bayes_general 


## calculate BF
lambda <- UMPBT(df = H1_Chi_gender_bayes_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H1_Chi_gender_bayes_general$statistic, lambda = lambda, df = H1_Chi_gender_bayes_general$parameter)

H1_BF_gender_bayes_general <- log(BF1)

H1_BF_gender_bayes_general

## rm 
rm(observed1,expected1,BF1)
```


And, process the data for the special population
the special population is preschool children
```{r}
## convert data
H2_gender_bayes_preschool <- H2_gender_preschool_special_prop %>% 
  dplyr::select(Gender,n) %>% 
  dplyr::rename(`Chinese subjects` = 2) %>% 
  dplyr::left_join(Census7_gender_preschool_special %>% 
                     select(Gender,Proportion) %>% 
                     rename(Census7 = 2) %>% 
                     mutate(Census7 = Census7 * 0.01),
                   by = "Gender")


## trans 2000
H2_gender_bayes_preschool <- H2_gender_bayes_preschool %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`Chinese subjects`),
                `Chinese subjects New` = floor(Scaling_factor *`Chinese subjects`),
                Dif = 2000 - sum(`Chinese subjects New`),
                `Chinese subjects New` = ifelse(row_number() == 1, `Chinese subjects New` + Dif, `Chinese subjects New`))


## calculate Chi-square
observed1 <- H2_gender_bayes_preschool$`Chinese subjects`
expected1 <- H2_gender_bayes_preschool$Census7

H2_Chi_gender_bayes_preschool <- chisq.test(x = observed1, p = expected1)
H2_Chi_gender_bayes_preschool


## calculate BF
lambda <- UMPBT(df = H2_Chi_gender_bayes_preschool$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H2_Chi_gender_bayes_preschool$statistic, lambda = lambda, df = H2_Chi_gender_bayes_preschool$parameter)

H2_BF_gender_bayes_preschool <- log(BF1)

H2_BF_gender_bayes_preschool 

## rm 
rm(observed1,expected1,BF1)
```


the special population is college
```{r}
## convert data
H2_gender_bayes_college <- Journal_gender_college_sepcial2 %>% 
  dplyr::select(Gender,n) %>% 
  dplyr::rename(Journal = 2) %>% 
  dplyr::mutate(Outline_Women = c(0.5,0.5))


## trans 2000
H2_gender_bayes_college <- H2_gender_bayes_college %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(Journal),
                `Journal New` = floor(Scaling_factor * Journal),
                Dif = 2000 - sum(`Journal New`),
                `Journal New` = ifelse(row_number() == 1, `Journal New` + Dif, `Journal New`))


## calculate Chi-square
observed1 <- H2_gender_bayes_college$Journal
expected1 <- H2_gender_bayes_college$Outline_Women

H2_Chi_gender_bayes_college <- chisq.test(x = observed1, p = expected1)
H2_Chi_gender_bayes_college


## calculate BF
lambda <- UMPBT(df = H2_Chi_gender_bayes_college$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H2_Chi_gender_bayes_college$statistic, lambda = lambda, df = H2_Chi_gender_bayes_college$parameter)

H2_BF_gender_bayes_college <- log(BF1)

H2_BF_gender_bayes_college 

## rm 
rm(observed1,expected1,BF1)
```

### age
PsyStages
```{r}
## convert data
H2_PsyStages_bayes_general <- BTS_age_PsyStages_CHN_general %>% 
  dplyr::select(ageBins,n) %>% 
  dplyr::left_join(Sim_Journal_age_PsyStages3_general,
                   by = "ageBins") %>% 
  dplyr::mutate(`Chinese subjects` = n + sim1) %>% 
  dplyr::select(ageBins,`Chinese subjects`) %>% 
  dplyr::left_join(Census7_age_PsyStages %>% 
                     select(ageBins,Proportion) %>% 
                     rename(Census7 = 2) %>% 
                     mutate(Census7 = Census7 * 0.01),
                   by = "ageBins")


## trans 2000
H2_PsyStages_bayes_general <- H2_PsyStages_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`Chinese subjects`),
                `Chinese subjects New` = floor(Scaling_factor * `Chinese subjects`),
                Dif = 2000 - sum( `Chinese subjects New`),
                `Chinese subjects New` = ifelse(row_number() == 1,
                                             `Chinese subjects New` + Dif,
                                             `Chinese subjects New`))


## calculate Chi-square
observed1 <- H2_PsyStages_bayes_general$`Chinese subjects`
expected1 <- H2_PsyStages_bayes_general$Census7


H1_Chi_PsyStages_bayes_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_PsyStages_bayes_general


## calculate BF
lambda <- UMPBT(df = H1_Chi_PsyStages_bayes_general$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H1_Chi_PsyStages_bayes_general$statistic, lambda = lambda, df = H1_Chi_PsyStages_bayes_general$parameter)

H1_BF_PsyStages_bayes_general <- log(BF1)

H1_BF_PsyStages_bayes_general 

## rm 
rm(observed1,expected1,BF1)
```


interval10
```{r}
## convert data
H2_interval10_bayes_general <- BTS_age_interval10_CHN_general %>% 
  dplyr::select(ageBins,n) %>% 
  dplyr::left_join(Sim_Journal_age_interval103_general,
                   by = "ageBins") %>% 
  dplyr::mutate(`Chinese subjects` = n + sim1) %>% 
  dplyr::select(ageBins,`Chinese subjects`) %>% 
  dplyr::left_join(Census7_age_interval10 %>% 
                     select(ageBins,Proportion) %>% 
                     rename(Census7 = 2) %>% 
                     mutate(Census7 = Census7 * 0.01),
                   by = "ageBins")


## trans 2000
H2_interval10_bayes_general <- H2_interval10_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`Chinese subjects`),
                `Chinese subjects New` = floor(Scaling_factor * `Chinese subjects`),
                Dif = 2000 - sum( `Chinese subjects New`),
                `Chinese subjects New` = ifelse(row_number() == 1,
                                             `Chinese subjects New` + Dif,
                                             `Chinese subjects New`))


## calculate Chi-square
observed1 <- H2_interval10_bayes_general$`Chinese subjects`
expected1 <- H2_interval10_bayes_general$Census7


H1_Chi_interval10_bayes_general <- chisq.test(x = observed1, p = expected1)
H1_Chi_interval10_bayes_general


## calculate BF
lambda <- UMPBT(df = H1_Chi_interval10_bayes_general$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H1_Chi_interval10_bayes_general$statistic, lambda = lambda, df = H1_Chi_interval10_bayes_general$parameter)

H1_BF_interval10_bayes_general <- log(BF1)

H1_BF_interval10_bayes_general 

## rm 
rm(observed1,expected1,BF1)
```


### edu
the first edu cutoff is college
```{r}
H2_college_bayes_general <- H2_edu_college %>% 
  dplyr::filter(Data_source == "Chinese subjects") %>% 
  dplyr::select(Educational_attainment,Num) %>% 
  dplyr::rename(`Chinese subjects` = 2) %>% 
  dplyr::left_join(H2_edu_college %>% 
                     filter(Data_source == "Census7") %>% 
                     select(Educational_attainment,Proportion) %>% 
                     rename(Census7 = 2) %>% 
                     mutate(Census7 = Census7 * 0.01),
                   by = "Educational_attainment") %>% 
  dplyr::left_join(H2_edu_college %>% 
                     filter(Data_source == "CFPS2018") %>% 
                     select(Educational_attainment,Proportion) %>% 
                     rename(CFPS2018 = 2) %>% 
                     mutate(CFPS2018 = CFPS2018 * 0.01),
                   by = "Educational_attainment")


## trans 2000
H2_college_bayes_general <- H2_college_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`Chinese subjects`),
                `Chinese subjects New` = floor(Scaling_factor * `Chinese subjects`),
                Dif = 2000 - sum( `Chinese subjects New`),
                `Chinese subjects New` = ifelse(row_number() == 1,
                                             `Chinese subjects New` + Dif,
                                             `Chinese subjects New`))
```


Chinese subjects vs Census7
```{r}
## calculate Chi-square
observed1 <- H2_college_bayes_general$`Chinese subjects New`
expected1 <- H2_college_bayes_general$Census7


H2_Chi_college_bayes_general <- chisq.test(x = observed1, p = expected1)
H2_Chi_college_bayes_general 


## calculate BF
lambda <- UMPBT(df = H2_Chi_college_bayes_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H2_Chi_college_bayes_general$statistic, lambda = lambda, df = H2_Chi_college_bayes_general$parameter)

H2_BF_college_bayes_general <- log(BF1)

H2_BF_college_bayes_general

## rm 
rm(observed1,expected1,BF1)
```


Chinese subjects vs CFPS2018
```{r}
rm(H2_Chi_college_bayes_general,H2_BF_college_bayes_general)
## calculate Chi-square
observed1 <- H2_college_bayes_general$`Chinese subjects New`
expected1 <- H2_college_bayes_general$CFPS2018


H2_Chi_college_bayes_general <- chisq.test(x = observed1, p = expected1)
H2_Chi_college_bayes_general 


## calculate BF
lambda <- UMPBT(df = H2_Chi_college_bayes_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H2_Chi_college_bayes_general$statistic, lambda = lambda, df = H2_Chi_college_bayes_general$parameter)

H2_BF_college_bayes_general <- log(BF1)

H2_BF_college_bayes_general

## rm 
rm(observed1,expected1,BF1)
```


the second edu cutoff is high school
```{r}
H2_highschool_bayes_general <- H2_edu_highschool %>% 
  dplyr::filter(Data_source == "Chinese subjects") %>% 
  dplyr::select(Educational_attainment,Num) %>% 
  dplyr::rename(`Chinese subjects` = 2) %>% 
  dplyr::left_join(H2_edu_highschool %>% 
                     filter(Data_source == "Census7") %>% 
                     select(Educational_attainment,Proportion) %>% 
                     rename(Census7 = 2) %>% 
                     mutate(Census7 = Census7 * 0.01),
                   by = "Educational_attainment") %>% 
  dplyr::left_join(H2_edu_highschool %>% 
                     filter(Data_source == "CFPS2018") %>% 
                     select(Educational_attainment,Proportion) %>% 
                     rename(CFPS2018 = 2) %>% 
                     mutate(CFPS2018 = CFPS2018 * 0.01),
                   by = "Educational_attainment")


## trans 2000
H2_highschool_bayes_general <- H2_highschool_bayes_general %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(`Chinese subjects`),
                `Chinese subjects New` = floor(Scaling_factor * `Chinese subjects`),
                Dif = 2000 - sum( `Chinese subjects New`),
                `Chinese subjects New` = ifelse(row_number() == 1,
                                             `Chinese subjects New` + Dif,
                                             `Chinese subjects New`))
```


Chinese subjects vs Census7
```{r}
## calculate Chi-square
observed1 <- H2_highschool_bayes_general$`Chinese subjects New`
expected1 <- H2_highschool_bayes_general$Census7


H2_Chi_highschool_bayes_general <- chisq.test(x = observed1, p = expected1)
H2_Chi_highschool_bayes_general 


## calculate BF
lambda <- UMPBT(df = H2_Chi_highschool_bayes_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H2_Chi_highschool_bayes_general$statistic, lambda = lambda, df = H2_Chi_highschool_bayes_general$parameter)

H2_BF_highschool_bayes_general <- log(BF1)

H2_BF_highschool_bayes_general

## rm 
rm(observed1,expected1,BF1)
```


Chinese subjects vs CFPS2018
```{r}
rm(H2_Chi_highschool_bayes_general,H2_BF_highschool_bayes_general)
## calculate Chi-square
observed1 <- H2_highschool_bayes_general$`Chinese subjects New`
expected1 <- H2_highschool_bayes_general$CFPS2018


H2_Chi_highschool_bayes_general <- chisq.test(x = observed1, p = expected1)
H2_Chi_highschool_bayes_general 


## calculate BF
lambda <- UMPBT(df = H2_Chi_highschool_bayes_general$parameter,thresh = 4^10)

BF1 <- froot_bf(x = H2_Chi_highschool_bayes_general$statistic, lambda = lambda, df = H2_Chi_highschool_bayes_general$parameter)

H2_BF_highschool_bayes_general <- log(BF1)

H2_BF_highschool_bayes_general

## rm 
rm(observed1,expected1,BF1)
```


### region
the first region cutoff is four region
```{r}
## convert data
H2_region_four_bayes2 <- Journal_region_four %>% 
  dplyr::select(Region_four,n) %>% 
  dplyr::rename(Journal = 2) %>% 
  dplyr::left_join(H2_region_four_bayes %>% 
                     select(Region_four,Census7,CFPS2018),
                   by = "Region_four") %>% 
  dplyr::mutate(Census7 = Census7 * 0.01,
                CFPS2018 = CFPS2018 * 0.01)


## trans 2000
H2_region_four_bayes2 <- H2_region_four_bayes2 %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(Journal),
                `Journal New` = floor(Scaling_factor * Journal),
                Dif = 2000 - sum( `Journal New`),
                `Journal New` = ifelse(row_number() == 1,
                                             `Journal New` + Dif,
                                             `Journal New`))


```


Journal vs Census7
```{r}
## calculate Chi-square
observed1 <- H2_region_four_bayes2$`Journal New`
expected1 <- H2_region_four_bayes2$Census7


H2_Chi_region_four_bayes <- chisq.test(x = observed1, p = expected1)
H2_Chi_region_four_bayes


## calculate BF
lambda <- UMPBT(df = H2_Chi_region_four_bayes$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H2_Chi_region_four_bayes$statistic, lambda = lambda, df = H2_Chi_region_four_bayes$parameter)

H2_BF_region_four_bayes <- log(BF1)

H2_BF_region_four_bayes

## rm 
rm(observed1,expected1,BF1)
```


Journal vs CFPS2018
```{r}
rm(H2_Chi_region_four_bayes,H2_BF_region_four_bayes)
## calculate Chi-square
observed1 <- H2_region_four_bayes2$`Journal New`
expected1 <- H2_region_four_bayes2$CFPS2018


H2_Chi_region_four_bayes <- chisq.test(x = observed1, p = expected1)
H2_Chi_region_four_bayes


## calculate BF
lambda <- UMPBT(df = H2_Chi_region_four_bayes$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H2_Chi_region_four_bayes$statistic, lambda = lambda, df = H2_Chi_region_four_bayes$parameter)

H2_BF_region_four_bayes <- log(BF1)

H2_BF_region_four_bayes

## rm 
rm(observed1,expected1,BF1)
```


the second region cutoff is seven region
```{r}
## convert data
H2_region_seven_bayes2 <- Journal_region_seven %>% 
  dplyr::select(Region_seven,n) %>% 
  dplyr::rename(Journal = 2) %>% 
  dplyr::left_join(H2_region_seven_bayes %>% 
                     select(Region_seven,Census7,CFPS2018),
                   by = "Region_seven") %>% 
  dplyr::mutate(Census7 = Census7 * 0.01,
                CFPS2018 = CFPS2018 * 0.01)


## trans 2000
H2_region_seven_bayes2 <- H2_region_seven_bayes2 %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(Journal),
                `Journal New` = floor(Scaling_factor * Journal),
                Dif = 2000 - sum( `Journal New`),
                `Journal New` = ifelse(row_number() == 1,
                                             `Journal New` + Dif,
                                             `Journal New`))
```


Journal vs Census7
```{r}
## calculate Chi-square
observed1 <- H2_region_seven_bayes2$`Journal New`
expected1 <- H2_region_seven_bayes2$Census7


H2_Chi_region_seven_bayes <- chisq.test(x = observed1, p = expected1)
H2_Chi_region_seven_bayes


## calculate BF
lambda <- UMPBT(df = H2_Chi_region_seven_bayes$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H2_Chi_region_seven_bayes$statistic, lambda = lambda, df = H2_Chi_region_seven_bayes$parameter)

H2_BF_region_seven_bayes <- log(BF1)

H2_BF_region_seven_bayes

## rm 
rm(observed1,expected1,BF1)
```


Journal vs CFPS2018
```{r}
rm(H2_Chi_region_seven_bayes,H2_BF_region_seven_bayes)
## calculate Chi-square
observed1 <- H2_region_seven_bayes2$`Journal New`
expected1 <- H2_region_seven_bayes2$CFPS2018


H2_Chi_region_seven_bayes <- chisq.test(x = observed1, p = expected1)
H2_Chi_region_seven_bayes


## calculate BF
lambda <- UMPBT(df = H2_Chi_region_seven_bayes$parameter,thresh = 4^20)

BF1 <- froot_bf(x = H2_Chi_region_seven_bayes$statistic, lambda = lambda, df = H2_Chi_region_seven_bayes$parameter)

H2_BF_region_seven_bayes <- log(BF1)

H2_BF_region_seven_bayes

## rm 
rm(observed1,expected1,BF1)
```


## testing the 3rd hypothesis
### gender
reprocess the data
```{r}
H3_gender_nonCHN <- H3_gender %>% 
  dplyr::filter(ISO3 != "CHN") %>%   
  dplyr::select(ISO3,Gender,n,Proportion) %>% 
  dplyr::mutate(Proportion = Proportion * 0.01)


## process CHN data
H3_gender_CHN <- H3_gender %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(ISO3,Gender,n,Proportion) %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(n),
                n_New = floor(Scaling_factor * n),
                Dif = 2000 - sum(n_New),
                n_New = ifelse(row_number() == 1,
                                             n + Dif,
                                             n_New)) %>% 
  dplyr::select(ISO3,Gender,n_New,Proportion) %>% 
  dplyr::rename(n = 3) %>% 
  dplyr::mutate(Proportion = Proportion * 0.01)


H3_gender_bayes <- H3_gender_nonCHN %>% 
  dplyr::add_row(H3_gender_CHN)
```


calculate chi-square and BF
```{r warning=FALSE}
countries <- setdiff(unique(H3_gender_bayes$ISO3),"CHN")

results_list <- list()

for (ISO3 in countries) {
  
  country_data <- H3_gender_bayes %>% 
    filter(ISO3 == !!ISO3)
  
  
  ## calculate Chi-Sqaure
  observed1 <- country_data$n 
 
  expected1 <- H3_gender_bayes$Proportion[H3_gender_bayes$ISO3 == "CHN"]
  
  H3_Chi_gender <- chisq.test(x = observed1, p = expected1)

  
  ## calculate BF
  lambda <- UMPBT(df = H3_Chi_gender$parameter,thresh = 4^10)
  
  BF1 <- froot_bf(x = H3_Chi_gender$statistic, lambda = lambda, df = H3_Chi_gender$parameter)
  
  
  H3_BF_gender <- log(BF1)
  
  
  # create data row
  result_row <- data.frame(
    observed = country_data$ISO3,  
    expected = "CHN",  
    X_squared = H3_Chi_gender$statistic,
    df = H3_Chi_gender$parameter,
    p_value = H3_Chi_gender$p.value,
    BF_log =  H3_BF_gender
  )
  results_list[[ISO3]] <- result_row
  

}

H3_BF_gender <- do.call(rbind, results_list) %>% 
  dplyr::group_by(observed) %>% 
  dplyr::slice(1)
```


### age
the first age cutoff is PsyStages
```{r}
H3_PsyStages_nonCHN <- H3_PsyStages2 %>% 
  dplyr::filter(ISO3 != "CHN") %>%   
  dplyr::select(ISO3,ageBins,n,Proportion) %>% 
  dplyr::mutate(Proportion = Proportion * 0.01)


## process CHN data
H3_PsyStages_CHN <- H3_PsyStages2 %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(ISO3,ageBins,n,Proportion) %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(n),
                n_New = floor(Scaling_factor * n),
                Dif = 2000 - sum(n_New),
                n_New = ifelse(row_number() == 1,
                                             n + Dif,
                                             n_New)) %>% 
  dplyr::select(ISO3,ageBins,n_New,Proportion) %>% 
  dplyr::rename(n = 3) %>% 
  dplyr::mutate(Proportion = Proportion * 0.01)


H3_PsyStages_bayes <- H3_PsyStages_nonCHN %>% 
  dplyr::add_row(H3_PsyStages_CHN)
```


calculate chi-square and BF
```{r warning=FALSE}
full_bins <- c("<=17", "18~25", "26~40", "41~60", ">=61")

countries <- setdiff(unique(H3_PsyStages_bayes$ISO3),"CHN")

results_list <- list()

for (ISO3 in countries) {
  
  country_data <- H3_PsyStages_bayes %>% 
    filter(ISO3 == !!ISO3) %>% 
    bind_rows(tibble(ISO3 = ISO3,
                     ageBins = setdiff(full_bins, .$ageBins),
                     n = 0,Proportion = 0)) %>%
    arrange(match(ageBins, full_bins))
  
  
  ## calculate Chi-Square
  observed1 <- country_data$n 
 
  expected1 <- H3_PsyStages_bayes$Proportion[H3_PsyStages_bayes$ISO3 == "CHN"]
  
  H3_Chi_PsyStages <- chisq.test(x = observed1, p = expected1)

  
  ## calculate BF
  lambda <- UMPBT(df = H3_Chi_PsyStages$parameter,thresh = 4^20)
  
  BF1 <- froot_bf(x = H3_Chi_PsyStages$statistic, lambda = lambda, df = H3_Chi_PsyStages$parameter)
  
  
  H3_BF_PsyStages <- log(BF1)
  
  
  # create data row
  result_row <- data.frame(
    observed = country_data$ISO3,  
    expected = "CHN",  
    X_squared = H3_Chi_PsyStages$statistic,
    df = H3_Chi_PsyStages$parameter,
    p_value = H3_Chi_PsyStages$p.value,
    BF_log =  H3_BF_PsyStages
  )
  results_list[[ISO3]] <- result_row
  

}

H3_BF_PsyStages <- do.call(rbind, results_list) %>% 
  dplyr::group_by(observed) %>% 
  dplyr::slice(1)
```


The second cutoff is 7-bins(interval 10)
```{r}
H3_interval10_nonCHN <- H3_interval10 %>% 
  dplyr::filter(ISO3 != "CHN") %>%   
  dplyr::select(ISO3,ageBins,n,Proportion) %>% 
  dplyr::mutate(Proportion = Proportion * 0.01)


## process CHN data
H3_interval10_CHN <- H3_interval10 %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(ISO3,ageBins,n,Proportion) %>% 
  dplyr::mutate(Scaling_factor = 2000/sum(n),
                n_New = floor(Scaling_factor * n),
                Dif = 2000 - sum(n_New),
                n_New = ifelse(row_number() == 1,
                                             n + Dif,
                                             n_New)) %>% 
  dplyr::select(ISO3,ageBins,n_New,Proportion) %>% 
  dplyr::rename(n = 3) %>% 
  dplyr::mutate(Proportion = Proportion * 0.01)


H3_interval10_bayes <- H3_interval10_nonCHN %>% 
  dplyr::add_row(H3_interval10_CHN)
```


calculate chi-square and BF
```{r warning=FALSE}
full_bins2 <- c("<=10","11~20","21~30", "31~40", "41~50", "51~60", ">=61")

countries <- setdiff(unique(H3_interval10_bayes$ISO3),"CHN")

results_list <- list()

for (ISO3 in countries) {
  
  country_data <- H3_interval10_bayes %>% 
    filter(ISO3 == !!ISO3) %>% 
    bind_rows(tibble(ISO3 = ISO3,
                     ageBins = setdiff(full_bins2, .$ageBins),
                     n = 0,Proportion = 0)) %>%
    arrange(match(ageBins, full_bins2))
  
  
  ## calculate Chi-Square
  observed1 <- country_data$n 
 
  expected1 <- H3_interval10_bayes$Proportion[H3_interval10_bayes$ISO3 == "CHN"]
  
  H3_Chi_interval10 <- chisq.test(x = observed1, p = expected1)

  
  ## calculate BF
  lambda <- UMPBT(df = H3_Chi_interval10$parameter,thresh = 4^20)
  
  BF1 <- froot_bf(x = H3_Chi_interval10$statistic, lambda = lambda, df = H3_Chi_interval10$parameter)
  
  
  H3_BF_interval10 <- log(BF1)
  
  
  # create data row
  result_row <- data.frame(
    observed = country_data$ISO3,  
    expected = "CHN",  
    X_squared = H3_Chi_interval10$statistic,
    df = H3_Chi_interval10$parameter,
    p_value = H3_Chi_interval10$p.value,
    BF_log =  H3_BF_interval10
  )
  results_list[[ISO3]] <- result_row
  

}

H3_BF_interval10 <- do.call(rbind, results_list) %>% 
  dplyr::group_by(observed) %>% 
  dplyr::slice(1)
```
