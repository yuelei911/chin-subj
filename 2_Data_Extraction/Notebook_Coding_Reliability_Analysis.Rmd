---
title: "Notebook_Coding_Consistency"
author: "Lei Yue"
date: "2024-12-08"
output: html_document
---

## Load packages
```{r}
rm(list = ls())
if (!require("pacman")) install.packages("pacman")

# use package "pacman" as loading R packages tools

pacman::p_load("tidyverse","rio","here","tidyr","irr")
```

First, I calculated the consistency of Chinese journal coding, and then the consistency of BTS coding.
## Load Chinese Journal data
```{r warning=FALSE}
file_list <- list.files(
  here("C:/Users/ynian/Desktop/Stage_2_Code_Data"),
  pattern = ".xlsx",
  full.names = TRUE, recursive = TRUE)

df <- rio::import_list(file_list) 

 
df <-   df[grepl("Group",names(df),ignore.case = TRUE)]


df <- lapply(df, function(df) {  
  df[] <- lapply(df, as.character)  
  return(df)  
})

rm(file_list)
```


## Check col names
I only corrected the inconsistencies in the case of letters and spelling errors in the column names. For any other inconsistencies in column names, I made the necessary modifications during the subsequent merging process.
```{r}
## Check the coding stage col names


Coding_Data_Names <- data.frame(Group1_Coding_Names = names(df[[1]]),
                       Group1_Coding_Suppl_Names = names(df[[2]]),
                       Group2_Coding_Names = names(df[[3]]),
                       Group3_Coding_Names = names(df[[4]]),
                       Group3_Coding_Suppl_Names = names(df[[5]]),
                       Group4_Coding_Names = names(df[[6]]),
                       Group5_Coding_Names = names(df[[7]]),
                       Group6_Coding_Names = names(df[[8]]),
                       Group7_Coding_Names = names(df[[9]])) 

check_row_equality1 <- function(row) {  
  all_equal <- all(row == row[1])  
  return(all_equal)  
}  
  
row_equalities1 <- apply(Coding_Data_Names, 1, check_row_equality1) 

### I found the names of 3,4,5, 19 cols are different and I modfication them.

colnames(df[[9]])[colnames(df[[9]]) == "First_author"] <- "First_Author"

colnames(df[[3]])[colnames(df[[3]]) == "Sample_Szie"] <- "Sample_Size"
colnames(df[[4]])[colnames(df[[4]]) == "Sample_Szie"] <- "Sample_Size"
colnames(df[[5]])[colnames(df[[5]]) == "Sample_Szie"] <- "Sample_Size"
colnames(df[[6]])[colnames(df[[6]]) == "Sample_Szie"] <- "Sample_Size"
colnames(df[[7]])[colnames(df[[7]]) == "Sample_Szie"] <- "Sample_Size"
colnames(df[[9]])[colnames(df[[9]]) == "Sample_Szie"] <- "Sample_Size"

rm(Coding_Data_Names,row_equalities1,check_row_equality1)

## Check the proofreading stage col names
Proofreading_Data_Names <- data.frame(Group1_Proofreading_Names = names(df[[10]]),
                                      Group2_Proofreading_Names = names(df[[11]]),
                                      Group3_Proofreading_Names = names(df[[12]]),
                                      Group4_Proofreading_Names = names(df[[13]]),
                                      Group5_Proofreading_Names = names(df[[14]]),
                                      Group6_Proofreading_Names = names(df[[15]]),
                                      Group7_Proofreading_Names = names(df[[16]]))

check_row_equality2 <- function(row) {  
  all_equal <- all(row == row[1])  
  return(all_equal)  
}  
  
row_equalities2 <- apply(Proofreading_Data_Names, 1, check_row_equality2) 

### I found the names of 8 cols are different and I modfication them.

colnames(df[[11]])[colnames(df[[11]]) == "target_population_N"] <- "Target_Population_N"

rm(Proofreading_Data_Names,row_equalities2,check_row_equality2)

```


## Combining the two stages' data (Group2,4,5,6, and 7)
```{r}
Group24567_1 <- dplyr::bind_rows(df[[3]],df[[6]],df[[7]],df[[8]],df[[9]])


Group24567_2 <- dplyr::bind_rows(df[[11]],df[[13]],df[[14]],df[[15]],df[[16]]) %>% 
  dplyr::rename_at(vars(1:4,7), ~paste0(., "_N"))

  
Group24567_bind <-  cbind(Group24567_1,Group24567_2) %>% 
  dplyr::select(1,30,2,31,8,32,11,33,3:7,9,10,12:29,34:48) %>% 
  dplyr::filter(Coder != "check" & Coder != "Check")

```


## Finding the distinct Ids in suppl documents
```{r }
Suppl_ID <- dplyr::bind_rows(df[[2]],df[[5]]) %>% 
  dplyr::filter(Coder == "final") %>%
  dplyr::distinct(Article_IDs)
```


## Loading the Group 1 data (include suppl)
```{r}
Group1_1 <- df[[1]] %>% 
  dplyr::filter(Coder != "check" & Coder != "Check") %>% 
  dplyr::filter(!Article_IDs %in% Suppl_ID$Article_IDs) %>% 
  dplyr::select(-c(8,9,14:18,27,28,37,38))


Group1_suppl <- df[[2]] %>% 
  dplyr::filter(Coder != "check" & Coder != "Check") %>% 
  dplyr::rename_at(vars(8,9,14:18,27,28,37,38), ~paste0(., "_N")) %>% 
  dplyr::mutate(Coder_N = NA, Article_IDs_N = NA, Study_Number_N = NA, 
                Subjects_Group_N = NA, Remark1_N = NA, Remark2_N = NA, 
                Remark3_N = NA, Coder2_N= NA) %>% 
  dplyr::mutate(Coder_N = Coder, Coder2_N = Coder,Article_IDs_N = Article_IDs,
                Study_Number_N = Study_Number, Subjects_Group_N = Subjects_Group, Remark1_N = Remark1,
                Remark2_N = Remark2, Remark3_N = Remark3)


Group1_2 <- df[[10]] %>% 
  dplyr::filter(Coder != "check" & Coder != "Check") %>% 
  dplyr::filter(!Article_IDs %in% Suppl_ID$Article_IDs) %>%
  dplyr::rename_at(vars(1:4,7), ~paste0(., "_N"))


Group1_bind <- cbind(Group1_1,Group1_2) %>%
  dplyr::select(1,30,2,31,8,32,11,33,3:7,9,10,12:29,34:48)


Group1_bind <- bind_rows(Group1_bind,Group1_suppl)
``` 


## Loading the Group 3 data (include suppl)
```{r}
Group3_1 <- df[[4]] %>% 
  dplyr::filter(!Article_IDs %in% Suppl_ID$Article_IDs) %>% 
  dplyr::select(-c(8,9,14:18,27,28,37,38))

# The coders in the First_Author and Journal columns because of the wrong order of column names, so the two columns of 1:41 data position is reversed, now swap the data back, in order to facilitate the subsequent data merge
target_rows <- rep(seq(1, 161, by = 4), each = 2) + 0:1

Group3_1_Journal <- Group3_1[target_rows,"Journal"]
Group3_1_First_Author <- Group3_1[target_rows,"First_Author"]

Group3_1[target_rows,"Journal"] <- Group3_1_First_Author
Group3_1[target_rows,"First_Author"] <- Group3_1_Journal

Group3_1 <- Group3_1 %>% 
  dplyr::rename(First_Author = "Journal",Journal = "First_Author") %>% 
  dplyr::filter(Coder != "check" & Coder != "Check") %>% 
  dplyr::filter(Article_IDs != 20211037)

# continue sorting data
Group3_suppl <- df[[5]] %>% 
  dplyr::filter(Coder != "check" & Coder != "Check") %>% 
  dplyr::rename_at(vars(8,9,14:18,27,28,37,38), ~paste0(., "_N")) %>% 
  dplyr::mutate(Coder_N = NA, Article_IDs_N = NA, Study_Number_N = NA, 
                Subjects_Group_N = NA, Remark1_N = NA, Remark2_N = NA, 
                Remark3_N = NA, Coder2_N= NA) %>% 
  dplyr::mutate(Coder_N = Coder, Coder2_N = Coder,Article_IDs_N = Article_IDs,
                Study_Number_N = Study_Number, Subjects_Group_N = Subjects_Group, Remark1_N = Remark1,
                Remark2_N = Remark2, Remark3_N = Remark3)


Group3_2 <- df[[12]] %>% 
  dplyr::filter(Coder != "check" & Coder != "Check") %>% 
  dplyr::filter(!Article_IDs %in% Suppl_ID$Article_IDs) %>%
  dplyr::rename_at(vars(1:4,7), ~paste0(., "_N"))


Group3_bind <- cbind(Group3_1,Group3_2) %>%
  dplyr::select(1,30,2,31,8,32,11,33,3:7,9,10,12:29,34:48)

Group3_bind <- bind_rows(Group3_bind,Group3_suppl)
```


## load the replaced article data
```{r}
Relaced_articles <- readxl::read_xlsx("Chin_Subj_articles_replaced_CE.xlsx") %>% 
  dplyr::select(-rows) %>% 
  dplyr::filter(Coder != "check")

Relaced_articles <- Relaced_articles %>% 
  dplyr::mutate(Coder_N = Coder, Coder2_N = Coder,
                Article_IDs_N = Article_IDs, Study_Number_N = Study_Number,
                Subjects_Group_N = Subjects_Group, Remark1_N = Remark1,
                Remark2_N = Remark2, Remark3_N = Remark3,
                Subjects_Area = NA, Subjects_Area_info = NA) %>% 
  dplyr::mutate(across(everything(), as.character))
```


## Combine all data
```{r message=FALSE, warning=FALSE}
Journal_CE <- bind_rows(Group24567_bind,Group1_bind,Group3_bind,Relaced_articles)
```


## divide two data.frame for the subsequent analysis
```{r}
Journal_Coder1 <- Journal_CE[seq(1, nrow(Journal_CE), by = 3), ]

Journal_Coder2 <- Journal_CE[seq(2,nrow(Journal_CE), by = 3), ]
```


## process Coder NA
```{r}
Journal_Coder1 <- Journal_Coder1 %>%
  dplyr::mutate(rownum = 1:1749) %>% 
  dplyr::select(rownum,Coder,Article_IDs_N,Study_Number_N,Subjects_Group_N,
                Abstract1,Abstract2,
                Sample_Size,Gender,Male_Num,Female_Num,
                Age,M_age,SD_age,
                Educational_Attainment_N,Subjects_Recruitment_Method_N,
                Sampling_Method,Target_Population_N,Subjects_Recruitment_Area,
                Study_Type) %>% 
  dplyr::mutate(across(everything(), ~ifelse(is.na(.) | as.character(.) %in% c("　", ""), "NA", as.character(.))))



Journal_Coder2 <- Journal_Coder2 %>% 
  dplyr::mutate(rownum = 1:1749) %>% 
  dplyr::select(rownum,Coder,Article_IDs_N,Study_Number_N,Subjects_Group_N,
                Abstract1,Abstract2, 
                Sample_Size,Gender,Male_Num,Female_Num,
                Age,M_age,SD_age,
                Educational_Attainment_N,Subjects_Recruitment_Method_N,
                Sampling_Method,Target_Population_N,Subjects_Recruitment_Area,
                Study_Type) %>% 
  dplyr::mutate(across(everything(), ~ifelse(is.na(.) | as.character(.) %in% c("　", ""), "NA", as.character(.))))
```


## convert variables type
```{r warning=FALSE}
## Abstract
Journal_Coder1 <- Journal_Coder1 %>% 
  dplyr::mutate(Abstract1 = case_when(Abstract1 == "0" ~ "0",
                                      Abstract1 == "NA" ~ "NA",
                                      TRUE ~  "1"),
                Abstract1 = as.factor(Abstract1)) 
  
Journal_Coder2 <- Journal_Coder2 %>% 
  dplyr::mutate(Abstract1 = case_when(Abstract1 == "0" ~ "0",
                                      Abstract1 == "NA" ~ "NA",
                                      TRUE ~  "1"),
                Abstract1 = as.factor(Abstract1)) 


Journal_Coder1$Abstract2 <- as.factor(Journal_Coder1$Abstract2)
Journal_Coder2$Abstract2 <- as.factor(Journal_Coder2$Abstract2)

## Target population
Journal_Coder1$Target_Population_N <- as.factor(Journal_Coder1$Target_Population_N)
Journal_Coder2$Target_Population_N <- as.factor(Journal_Coder2$Target_Population_N)

## sample size, Mage, SDage, female & male number
Journal_Coder1 <- Journal_Coder1 %>% 
  mutate(across(c(Sample_Size, M_age, SD_age, Female_Num, Male_Num), 
                ~replace(as.numeric(.), is.na(.), 0))) ## first replace na and then repalce 0

Journal_Coder2 <- Journal_Coder2 %>% 
  mutate(across(c(Sample_Size, M_age, SD_age, Female_Num, Male_Num), 
                ~replace(as.numeric(.), is.na(.), 0)))

## gender reported
Journal_Coder1$Gender <- as.factor(Journal_Coder1$Gender)
Journal_Coder2$Gender <- as.factor(Journal_Coder2$Gender)

## age 
Journal_Coder1$Age <- as.factor(Journal_Coder1$Age)
Journal_Coder2$Age <- as.factor(Journal_Coder2$Age)

## educational attainment
table(Journal_Coder1$Educational_Attainment_N)
Journal_Coder1$Educational_Attainment_N <- as.factor(Journal_Coder1$Educational_Attainment_N)
Journal_Coder2$Educational_Attainment_N <- as.factor(Journal_Coder2$Educational_Attainment_N)

  
## subjects recruitment area
Journal_Coder1 <- Journal_Coder1 %>% 
  dplyr::mutate(Subjects_Recruitment_Area = case_when(
    Subjects_Recruitment_Area == "0" ~ "0",
    Subjects_Recruitment_Area == "2" ~ "2",
    Subjects_Recruitment_Area == "NA" ~ "NA",
    TRUE ~ "1"),
    Subjects_Recruitment_Area = as.factor(Subjects_Recruitment_Area))

Journal_Coder2 <- Journal_Coder2 %>% 
  dplyr::mutate(Subjects_Recruitment_Area = case_when(
    Subjects_Recruitment_Area == "0" ~ "0",
    Subjects_Recruitment_Area == "2" ~ "2",
    Subjects_Recruitment_Area == "NA" ~ "NA",
    TRUE ~ "1"),
    Subjects_Recruitment_Area = as.factor(Subjects_Recruitment_Area))

## subjects recruitment method
Journal_Coder1$Subjects_Recruitment_Method_N <- as.factor(Journal_Coder1$Subjects_Recruitment_Method_N)

Journal_Coder2$Subjects_Recruitment_Method_N <- Journal_Coder2$Subjects_Recruitment_Method_N %>% 
  recode("1;2" = "1")
Journal_Coder2$Subjects_Recruitment_Method_N <- as.factor(Journal_Coder2$Subjects_Recruitment_Method_N)

## sampling method
Journal_Coder1$Sampling_Method <- as.factor(Journal_Coder1$Sampling_Method)
Journal_Coder2$Sampling_Method <- as.factor(Journal_Coder2$Sampling_Method)


## study type
Journal_Coder1 <- Journal_Coder1 %>% 
  dplyr::mutate(Study_Type = case_when(Study_Type == "1" ~ "1",
                                       Study_Type == "2" ~ "2",
                                       Study_Type == "NA" ~ "NA",
                                       TRUE ~ "3"))

Journal_Coder2 <- Journal_Coder2 %>% 
  dplyr::mutate(Study_Type = case_when(Study_Type == "1" ~ "1",
                                       Study_Type == "2" ~ "2",
                                       Study_Type == "NA" ~ "NA",
                                       TRUE ~ "3"))
```


## Get Krippendorff’s alpha for continuous variables
```{r}
Journal_vars <- Journal_Coder1 %>% 
  dplyr::select(Sample_Size,Male_Num,Female_Num,M_age,SD_age) %>% 
  names() ## select calculated vars
 
Journal_irrs_continuous <- data.frame(
  IRR = sapply(Journal_vars, function(i) 
    kripp.alpha(rbind(Journal_Coder1[[i]], Journal_Coder2[[i]]), "ratio")$value  ## value represent kripp.alpha
  ),
  check.names = FALSE
)

options(digits = 2)
Journal_irrs_continuous
```


## Get Krippendorff’s alpha for categorical variables
```{r}
Journal_vars <- Journal_Coder1 %>% 
  dplyr::select(Age, Gender , Educational_Attainment_N,
                Sampling_Method, Subjects_Recruitment_Method_N,
                Target_Population_N,Study_Type,Abstract1,
                Abstract2) %>% 
  names() ## select calculated vars
 

Journal_irrs_categorical <- data.frame(
  IRR = sapply(Journal_vars, function(i) 
    kripp.alpha(rbind(Journal_Coder1[[i]], Journal_Coder2[[i]]), "nominal")$value  ## value represent kripp.alpha
  ),
  check.names = FALSE
)


Journal_irrs_categorical
```


# Get percentage of agreement for categorical variables
```{r}
Journal_agreement_percent <- data.frame(
  `percentage of agreement` = sapply(Journal_vars, function(i) {
  
    combined <- cbind(Journal_Coder1[[i]], Journal_Coder2[[i]])
    agree(combined)$value/100

  }),
  check.names = FALSE
)


Journal_agreement_percent
```


The above is the consistency calculation for the Chinese journal coding data; now I will calculate the consistency for the BTS coding.

## load BTS data
```{r}
BTS_CE <-  readxl::read_xlsx("D://chin-subj//2_Data_Extraction//2_2_BTS//Chin_Subj_Proofreading_BTS_Target_Population.xlsx")

BTS_Coder1 <- BTS_CE[seq(1, nrow(BTS_CE), by = 4), ]

BTS_Coder2 <- BTS_CE[seq(2,nrow(BTS_CE), by = 4), ]
```


## Get Krippendorff’s alpha for categorical variables
```{r}
BTS_vars <- BTS_Coder1 %>% 
  dplyr::select(Target_Population) %>% 
  names() ## select calculated vars
 
BTS_irrs_categorical <- data.frame(
  IRR = sapply(BTS_vars, function(i) 
    kripp.alpha(rbind(BTS_Coder1[[i]], BTS_Coder2[[i]]), "nominal")$value  ## value represent kripp.alpha
  ),
  check.names = FALSE
)


BTS_irrs_categorical
```
# Get percentage of agreement for categorical variables
```{r}
BTS_agreement_percent <- data.frame(
  `percentage of agreement` = sapply(BTS_vars , function(i) {
  
    combined <- cbind(BTS_Coder1[[i]], BTS_Coder2[[i]])
    agree(combined)$value/100

  }),
  check.names = FALSE
)


BTS_agreement_percent
```


